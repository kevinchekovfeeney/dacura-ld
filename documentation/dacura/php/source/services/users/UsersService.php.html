<html>
    <head>
        <script
            type="text/javascript"
            src="../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
include_once(&quot;UsersDacuraServer.php&quot;);
/**
 * Users Service - provides access to updating / editing / viewing users and roles, etc. 
 *
 * * Creation Date: 15/01/2015
 * @package users
 * @author Chekov
 * @license: GPL v2
 */
class UsersService extends DacuraService {
	/** @var string the list page is the default screen - the front page of the service */
	var $default_screen = &quot;list&quot;;
	
	function compareFacets($a, $b){
		if($b == 'list' &amp;&amp; $a == &quot;view&quot;){
			return true;
		}
		return parent::compareFacets($a, $b);
	}
	/**
	 * There are only two possible arguments - user id or profile
	 * 
	 * Thus we simplify the argument handling
	 * @see DacuraService::loadArgsFromBrowserURL()
	 * @param array $sections an array of the url sections between slashes, the first of which will be our screen
	 */
	function loadArgsFromBrowserURL($sections){
		if(count($sections)){
			if($sections[0] == 'profile'){
				$this-&gt;screen = 'profile';
			}
			else {
				$this-&gt;screen = &quot;view&quot;;
				$this-&gt;args['userid'] = $sections[0];				
			}
		}
		else {
			$this-&gt;screen = &quot;list&quot;;
			$this-&gt;args['userid'] = &quot;&quot;;
		}
	}
		
	/**
	 * We override the render screen function to swap in the view page for the profile page
	 * @param string screen the name of the screen to render
	 * @param array name value array of variabls to be subbed into screen
	 */
	function renderScreen($screen, $params, $other_service = false){
		if($screen == &quot;profile&quot;){
			$screen = &quot;view&quot;;
		}
		return parent::renderScreen($screen, $params, $other_service);
	}
	
	/**
	 * Just a shortcut function to fill in some standard data for some form fields
	 * @param string $formid the id of the html form being prepared
	 * @param DacuraServer $dacura_server - the currently active server object. 
	 */
	function prepareFormFields($formid, DacuraServer $dacura_server){
		$fields = $this-&gt;sform($formid);
		if(isset($fields['password'])){
			$fields['password']['help'] .= &quot; &quot; .  $this-&gt;smsg(&quot;password_rule&quot;).&quot;.&quot;;
		}
		if(isset($fields['role'])){
			$fields['role'][&quot;options&quot;] = $dacura_server-&gt;userman-&gt;getAvailableRoles($this-&gt;cid());						
		}
		return $fields;
	}
	
	/**
	 * Just a shortcut function to fill in the standard fields for a user
	 * @param DacuraUser $ub the user being viewed / updated
	 * @param array $ff an array of fields that are to be filled in
	 */
	function fillInFormFields(DacuraUser $ub, &amp;$ff){
		if(isset($ff['id'])) $ff['id']['value'] = $ub-&gt;id;
		if(isset($ff['email'])) $ff['email']['value'] = $ub-&gt;email;
		if(isset($ff['name'])) $ff['name']['value'] = $ub-&gt;handle;
		if(isset($ff['status'])) $ff['status']['value'] = $ub-&gt;status;
	}
	
	/**
	 * Populates the parameters for the html screen subtitutions, etc
	 * (non-PHPdoc)
	 * @see DacuraService::getParamsForScreen()
	 * @param $screen the name of the screen to render
	 * @param UsersDacuraServer $dacura_server server object
	 * @return array the parameter array
	 */
	function getParamsForScreen($screen, UsersDacuraServer &amp;$dacura_server){
		$params = array(&quot;contexts&quot; =&gt; $dacura_server-&gt;getUserAvailableContexts(&quot;admin&quot;, true));
		$prule = $this-&gt;smsg(&quot;password_rule&quot;);
		$u = $dacura_server-&gt;getUser();
		$col = $dacura_server-&gt;getCollection();		
		if($screen == &quot;profile&quot;){
			$params[&quot;userid&quot;] = $u-&gt;id;			
		}
		else {
			$params[&quot;userid&quot;] = $this-&gt;args['userid'];
		}
		$params['all_roles'] = UserRole::$dacura_roles;
		$params[&quot;dt&quot;] = true;
		$params['image'] = $this-&gt;furl(&quot;images&quot;, &quot;services/users.png&quot;);
		$params['collectionbreadcrumb'] = &quot;users&quot;;
		if($screen == 'profile'){
			$params[&quot;title&quot;] = &quot;User Profile&quot;;
			$params[&quot;subtitle&quot;] = &quot;Manage your account details&quot;;
		}
		else {
			$params['role_options']	= $dacura_server-&gt;getRoleCreateOptions($params[&quot;userid&quot;]);	
			$params[&quot;title&quot;] = &quot;User Management Tool&quot;;
			if($this-&gt;cid() == &quot;all&quot;){
				$params[&quot;subtitle&quot;] = &quot;Manage users and their roles in the system&quot;;
			}
			else {
				$params[&quot;subtitle&quot;] = &quot;Manage the users and roles of &quot;.$col-&gt;name.&quot; collection&quot;;				
			}				
			if($u &amp;&amp; $u-&gt;rolesSpanCollections()){
				$params[&quot;breadcrumbs&quot;] = true;
			}
			elseif($screen == &quot;view&quot;){
				$params[&quot;breadcrumbs&quot;] = true;				
			}			
		}
		if($screen == &quot;list&quot;){		
			$params['selection_options'] = json_encode(DacuraObject::$valid_statuses);
			$params['subscreens'] = array(&quot;list-users&quot;);
			if($dacura_server-&gt;userHasFacet(&quot;admin&quot;) &amp;&amp; $u){
				$params['admin_table_settings'] = ($this-&gt;cid() == &quot;all&quot;) ? $this-&gt;getDatatableSetting(&quot;users&quot;): $this-&gt;getDatatableSetting(&quot;cusers&quot;);
				$params['subscreens'][] = &quot;add-user&quot;;
				$params['admin'] = true;
				if($dacura_server-&gt;cid() != &quot;all&quot;) {
					$cform = $this-&gt;prepareFormFields(&quot;ccu&quot;, $dacura_server);
					$params['subscreens'][] = &quot;invite-users&quot;;
					$iform = $this-&gt;prepareFormFields(&quot;icu&quot;, $dacura_server);
					$params[&quot;invite_intro_msg&quot;] = $this-&gt;smsg(&quot;invite_intro&quot;);
					$params['invite_email_template'] = $this-&gt;smsg(&quot;invite_email&quot;);
					$iform['message']['value'] = $params['invite_email_template'];					
					$params['invite_users_fields'] = array_values($iform);
					$params['add_intro_msg'] = $this-&gt;smsg(&quot;collection_add&quot;);
				}
				else {
					$cform = $this-&gt;prepareFormFields(&quot;csu&quot;, $dacura_server);						
					$params['add_intro_msg'] = $this-&gt;smsg(&quot;system_add&quot;);						
				}
				$params['create_user_fields'] = array_values($cform);				
			}
			else {
				$params['list_table_settings'] = ($this-&gt;cid() == &quot;all&quot;) ? $this-&gt;getDatatableSetting(&quot;susers&quot;): $this-&gt;getDatatableSetting(&quot;scusers&quot;);
				$params['clickable_users'] = $dacura_server-&gt;userHasFacet(&quot;view&quot;);				
			}
		}
		elseif($screen == 'profile') {
			$params['profile'] = true;
			$params['subscreens'] = array(&quot;user-password&quot;, &quot;user-details&quot;);				
			$params['update_details_fields'] = array_values($this-&gt;sform('upu'));
			$params[&quot;details_intro_msg&quot;] = $this-&gt;smsg(&quot;profile_intro&quot;);
			$params['showdelete'] = false;
			$params['showupdate'] = true;
			$params['update_button_text'] = &quot;Save Updated Profile&quot;;
			$params['update_form_type'] = &quot;update&quot;;
			$params['update_password_fields'] = array_values($this-&gt;prepareFormFields(&quot;upp&quot;, $dacura_server));
			$params[&quot;password_intro_msg&quot;] = $this-&gt;smsg(&quot;profile_password_intro&quot;);		
		}
		else {//view screen
			$ub = $dacura_server-&gt;getUser($params[&quot;userid&quot;]);
			$params['subscreens'] = array();
			if(!$ub){return $params;}
			elseif($u &amp;&amp; $u-&gt;id == $ub-&gt;id){
				$params['self_update'] = true;
			}
			$params[] = &quot;user-details&quot;;
			if($dacura_server-&gt;userHasFacet(&quot;inspect&quot;)){
				$params['roles_table_settings'] = $this-&gt;getDatatableSetting(&quot;roles&quot;);
				$params['subscreens'][] = &quot;user-history&quot;;
				if($this-&gt;cid() == 'all'){
					$params['history_table_settings'] = $this-&gt;getDatatableSetting(&quot;system_history&quot;);					
					$params['subscreens'][] = &quot;user-roles&quot;;
					$params[&quot;roles_intro_msg&quot;] = $this-&gt;smsg(&quot;roles_intro&quot;);
				}
				else {
					$params['history_table_settings'] = $this-&gt;getDatatableSetting(&quot;collection_history&quot;);					
					$params['subscreens'][] = &quot;collection-roles&quot;;
					$params[&quot;roles_intro_msg&quot;] = $this-&gt;smsg(&quot;roles_intro&quot;);
				}				
			}		
			if($dacura_server-&gt;userHasFacet(&quot;admin&quot;) &amp;&amp; $dacura_server-&gt;canUpdatePassword($ub)){
				$params['subscreens'][] = &quot;user-password&quot;;
				$params[&quot;details_intro_msg&quot;] = $this-&gt;smsg(&quot;update_details_intro&quot;);
				$params[&quot;showupdate&quot;] = true;
				$params['update_form_type'] = &quot;update&quot;;
				$params['update_password_fields'] = array_values($this-&gt;prepareFormFields(&quot;uxp&quot;, $dacura_server));
				$params[&quot;password_intro_msg&quot;] = $this-&gt;smsg(&quot;password_intro&quot;);
			}
			elseif($u &amp;&amp; $dacura_server-&gt;userHasFacet(&quot;admin&quot;)){
				$params[&quot;showupdate&quot;] = true;
				$params['update_form_type'] = &quot;view&quot;;
				$params[&quot;details_intro_msg&quot;] = $this-&gt;smsg(&quot;view_details_intro&quot;);						
			}
			else {
				$params[&quot;showupdate&quot;] = false;
				$params['update_form_type'] = &quot;view&quot;;
				$params[&quot;details_intro_msg&quot;] = $this-&gt;smsg(&quot;view_details_intro&quot;);						
			}
			$udf = $this-&gt;prepareFormFields(&quot;uxu&quot;, $dacura_server);
			$this-&gt;fillInFormFields($ub,$udf);
			$params['update_details_fields'] = array_values($udf);
			
			$params[&quot;showdelete&quot;] = $u &amp;&amp; $dacura_server-&gt;canUpdateUserStatus($u, $ub);				
			$params[&quot;history_intro_msg&quot;] = $this-&gt;smsg(&quot;history_intro&quot;);
			$params['update_button_text'] = &quot;Update User Details&quot;;
		}
		return $params;
	}
}</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>