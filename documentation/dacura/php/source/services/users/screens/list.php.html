<html>
    <head>
        <script
            type="text/javascript"
            src="../../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;div class='dacura-screen' id='users-home'&gt;
	&lt;?php if(in_array(&quot;list-users&quot;, $params['subscreens'])) { ?&gt;
	&lt;div class='dacura-subscreen' id='list-users' title=&quot;List Users&quot;&gt;
		&lt;div id='user-table-container'&gt;
			&lt;table id=&quot;users-table&quot; class=&quot;dacura-api-listing&quot;&gt;
				&lt;thead&gt;
				&lt;tr&gt;
					&lt;th id=&quot;duo-id&quot; title=&quot;The internal ID of the collection - a component in all collection internal URLs&quot;&gt;ID&lt;/th&gt;
					&lt;th id=&quot;duo-email&quot; title=&quot;The users primary email address.&quot;&gt;Email&lt;/th&gt;
					&lt;th id=&quot;duo-name&quot; title=&quot;The users handle - expressed in natural language&quot;&gt;Handle&lt;/th&gt;
					&lt;th id=&quot;duo-status&quot; title=&quot;Only users with status 'accept' are active.&quot;&gt;Status&lt;/th&gt;
					&lt;th id=&quot;dfn-getRoleSummary&quot; title=&quot;What roles does this user have within this context&quot;&gt;Roles&lt;/th&gt;
					&lt;th id=&quot;dfn-getCollectionSummary&quot; title=&quot;How many collections does the user have roles in?&quot;&gt;Collections&lt;/th&gt;
					&lt;th id=&quot;dfn-rowselector&quot; title=&quot;Select a group of users&quot;&gt;Select&lt;/th&gt;
				&lt;/tr&gt;
				&lt;/thead&gt;
				&lt;tbody&gt;&lt;/tbody&gt;
			&lt;/table&gt;
		&lt;/div&gt;
		&lt;div class=&quot;subscreen-buttons&quot; id='user-table-updates'&gt;&lt;/div&gt;
	&lt;/div&gt;
	&lt;?php } if(in_array(&quot;add-user&quot;, $params['subscreens'])) { ?&gt;
	&lt;div class='dacura-subscreen' id='add-user' title=&quot;Add User&quot;&gt;
		&lt;div class='subscreen-intro-message'&gt;&lt;?=$params['add_intro_msg']?&gt;&lt;/div&gt;
		&lt;?php echo $service-&gt;getInputTableHTML(&quot;user-details&quot;, &quot;create&quot;, $params['create_user_fields']);?&gt;
		&lt;div class=&quot;subscreen-buttons&quot;&gt;
			&lt;button id='usercreate' class='dacura-create subscreen-button'&gt;Add New User&lt;/button&gt;
		&lt;/div&gt;
	&lt;/div&gt;
	&lt;?php } if(in_array(&quot;invite-users&quot;, $params['subscreens'])) { ?&gt;
	&lt;div class='dacura-subscreen' id='invite-users' title=&quot;Invite Users&quot;&gt;
		&lt;div class='subscreen-intro-message'&gt;&lt;?=$params['invite_intro_msg']?&gt;&lt;/div&gt;
	
		&lt;?php echo $service-&gt;getInputTableHTML(&quot;uinvites&quot;, &quot;create&quot;, $params['invite_users_fields']);?&gt;
		&lt;div class=&quot;subscreen-buttons&quot;&gt;
			&lt;button id='usersinvite' class='dacura-update subscreen-button'&gt;Invite Users&lt;/button&gt;
		&lt;/div&gt;
	&lt;/div&gt;
	&lt;?php } ?&gt;
&lt;/div&gt;

&lt;script&gt;
	function clearResultMessages(){
		dacura.system.clearResultMessage(&quot;#invite-users-msgs&quot;);
		dacura.system.clearResultMessage(&quot;#add-user-msgs&quot;);
		dacura.system.clearResultMessage(&quot;#list-users-msgs&quot;);
	}

	/* List subscreen */
	
	/* Updates each of the selected users' statuses in sequence */
	function updateUsersStatus(ids, status, cnt, pconf){
		clearResultMessages();
		var nid = ids.shift();
		var obj = {&quot;status&quot;: status, &quot;id&quot;: nid};
		var onwards = function(){
			if(!isEmpty(ids)){
				updateUsersStatus(ids, status, cnt, pconf);
			}
			else {
				showUpdateStatusSuccess(status, cnt, pconf);
				refreshUserList();
			}
		}
		dacura.users.updateUser(obj, onwards, pconf);
	}

	/* shows a message to the user after an update status on the list page */
	function showUpdateStatusSuccess(status, cnt, targets){          
		dacura.system.showSuccessResult(cnt + &quot; users updated to status &quot; + status, &quot;Users Update OK&quot;, targets.resultbox, false, {'scrollTo': true, &quot;icon&quot;: true, &quot;closeable&quot;: true});
	}
	
	/*Gets the number of roles for each user*/ 	
	function getRoleSummary(obj){
		if(typeof obj.roles == &quot;undefined&quot;) return &quot;?&quot;;
		var html = &quot;&lt;div class='dacura-role-list'&gt;&quot;;
		if(typeof obj.category == 'zombie' || size(obj.roles) == 0) {
			html += &quot;&lt;span class='dacura-role zombie' title='Zombie user has no roles'&gt;&lt;/span&gt;&quot;;
		}
		else {
			for(var i in obj.roles){
				html += &quot;&lt;span class='dacura-role &quot; + i + &quot;' title='&quot;+obj.roles[i] +&quot;'&gt;&lt;/span&gt;&quot;;
			}
		}
		html += &quot;&lt;/div&gt;&quot;;
		return html;
	}

	function getCollectionSummary(obj){
		if(typeof obj.collections == &quot;undefined&quot;) return &quot;&quot;;
		if(size(obj.collections) == 0){
			return &quot;&quot;;
		}
		var html = &quot;&lt;div class='dacura-collections-summary'&gt;&quot;;
		if(typeof obj.collections['all'] != &quot;undefined&quot;) {
			html += &quot;&lt;span class='dacura-platform-role' title='platform roles: &quot; + obj.collections['all'].join(&quot;, &quot;) + &quot;'&gt;system&lt;/span&gt;&quot;;
		}
		for(var i in obj.collections){
			if(i != 'all') {
				html += &quot;&lt;span class='dacura-collection-role' title='&quot; + i + &quot; collection roles: &quot; + obj.collections[i].join(&quot;, &quot;) + &quot;'&gt;&quot; + i + &quot;&lt;/span&gt;&quot;;
			}
		}
		html += &quot;&lt;/div&gt;&quot;;
		return html;
	}

	//refreshes the list of users from the server - called whenever a user is created or users have their status updated 
	function refreshUserList(){
		dacura.tool.refreshtable(&quot;users-table&quot;, &quot;user-table-container&quot;);
	}
	
	/* Create user subscreen */

	//checks to ensure that there are no egregious input errors on the create user subscreen
	function inputError(obj){
		if(typeof obj.email == &quot;undefined&quot; || typeof obj.password == &quot;undefined&quot;){
			return &quot;bad reading of object from input&quot;;
		}
		if(obj.email.length &lt; 5){
			return &quot;The ID must be at least 3 characters long and the password must be at least 6 characters&quot;;
		}
		return false;
	}

	//displays a message to the user when they have successfully create a user
	function showCreateSuccess(txt, targets){
		clearResultMessages();
		refreshUserList();
		var usrurl = &quot;&lt;?= $service-&gt;my_url().&quot;/&quot;; ?&gt;&quot; + txt.id;
		dacura.system.showSuccessResult(&quot;The users account has been created at: &lt;a href='&quot; + usrurl + &quot;'&gt;&quot; + usrurl + &quot;&lt;/a&gt;&quot;, &quot;User with id: &quot; + txt.id + &quot; successfully created&quot;, targets.resultbox);
		dacura.tool.form.clear(&quot;user-details&quot;);
	}

	/* Invite users subscreen */
	
	//A table showing the outcomes of each invited user...
	function drawInviteResultTable(res){
		var html = &quot;&lt;ul&gt;&quot;;
		for(var key in res){
			html += &quot;&lt;li&gt;&quot; + key + &quot; &quot; + res[key] + &quot;&lt;/li&gt;&quot;;
		}
		html += &quot;&lt;/ul&gt;&quot;;
		return html;
	}

	//Display the result of an invitation request
	function showInviteResult(json, targets){
		clearResultMessages();
		if(size(json.issued) &gt; 0){
			refreshUserList();
			var msg = size(json.issued) + &quot; invitations successfully issued&quot;;
			html = &quot;&lt;h3&gt;Invitations Issued&lt;/h3&gt;&quot; + drawInviteResultTable(json.issued);
			if(size(json.failed) &gt; 0){
				msg  += &quot;, &quot; + size(json.failed) + &quot; addresses failed&quot;;
				html += &quot;&lt;h3&gt;Failed&lt;/h3&gt;&quot; + drawInviteResultTable(json.failed);				
				dacura.system.showWarningResult(msg, &quot;Invitations processed but errors encountered&quot;, targets.resultbox, html);
			}
			else {
				dacura.system.showSuccessResult(msg, &quot;Invitations processed successfully&quot;, targets.resultbox, html);			
			}
			dacura.tool.form.clear(&quot;uinvites&quot;);			
		}
		else {
			msg  = &quot;all &quot; + size(json.failed) + &quot; addresses failed&quot;;
			html = drawInviteResultTable(json.failed);				
			dacura.system.showErrorResult(msg, &quot;Invite failed&quot;, targets.resultbox, html);
		}
	}
	
	$(function() {
		dacura.tool.init({&quot;tabbed&quot;: 'users-home'});
		dacura.tool.table.init(&quot;users-table&quot;, {
			&quot;screen&quot;: &quot;list-users&quot;, 
			&quot;fetch&quot;: dacura.users.getUsers,
			&quot;mode&quot;: &quot;html&quot;,
			&quot;selected&quot;: {
				options: &lt;?=$params['selection_options']?&gt; , 
				intro: &quot;Update Selected Users, Set Status to &quot;, 
				container: &quot;user-table-updates&quot;,
				label: &quot;Update&quot;,
				update: updateUsersStatus 
			},
			&quot;refresh&quot;: {container: &quot;user-table-container&quot;, label: &quot;Refresh User List&quot; },
			&quot;cellClick&quot;: function(entid) {window.location.href = dacura.system.pageURL() + &quot;/&quot; + entid},
			&quot;dtsettings&quot;: &lt;?=$params['dacura_table_settings']?&gt;
		});
		dacura.tool.button.init(&quot;usercreate&quot;, {
			&quot;screen&quot;: &quot;add-user&quot;,
			&quot;source&quot;: &quot;user-details&quot;,
			&quot;validate&quot;: inputError, 
			&quot;submit&quot;: dacura.users.addUser, 
			&quot;result&quot;: showCreateSuccess
		});
		dacura.tool.button.init(&quot;usersinvite&quot;, {
			&quot;screen&quot;: &quot;invite-users&quot;,
			&quot;source&quot;: &quot;uinvites&quot;,
			&quot;submit&quot;: dacura.users.inviteUsers,
			&quot;result&quot;: showInviteResult				
		});
	});
&lt;/script&gt;
</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>