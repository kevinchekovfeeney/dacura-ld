<html>
    <head>
        <script
            type="text/javascript"
            src="../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
/*
 * API for users service - viewing and updating user details
 *
 * Created By: Chekov
 * Contributors:
 * Creation Date: 12/01/2015
 * Licence: GPL v2
 */

/*
 * God -&gt; can do everything....
 * Dacura admin -&gt; can do everything
 * Collection admin -&gt; can do everything related to their admin-ed collections
 * Otherwise users can view and update themselves, nothing else. 
 */

if($dacura_server-&gt;userHasRole(&quot;admin&quot;)){
	getRoute()-&gt;get('/', 'listUsers');
	getRoute()-&gt;post('/', 'createUser');	
	getRoute()-&gt;post('/invite', 'inviteUsers');
	getRoute()-&gt;delete('/(\w+)', 'deleteUser');
	getRoute()-&gt;delete('/(\w+)/role/(\w+)', 'deleteRole');
	getRoute()-&gt;post('/(\w+)/role', 'createRole');
}
//we need to load stuff to check permissions for the below - done in the functions below
getRoute()-&gt;get('/(\w+)', 'viewUser');
getRoute()-&gt;post('/(\w+)', 'updateUser');
getRoute()-&gt;post('/(\w+)/password', 'updateUserPassword');

/*
 * Changes the current user to the user with id $id
 * Just for testing different users - not for production!!!
 */
getRoute()-&gt;get('/load/(\w+)', 'switchUser'); //must be turned off - only for testing
function switchUser($id){
	global $dacura_server;
	$dacura_server-&gt;write_json_result($dacura_server-&gt;userman-&gt;switchToUser($id), &quot;Switched to user $id&quot;);
}

function listUsers(){
	global $dacura_server;
	$dacura_server-&gt;init(&quot;list_users&quot;);
	$collobj = $dacura_server-&gt;getUsersInContext();
	if($collobj){
		$dacura_server-&gt;write_json_result(array_values($collobj), &quot;Retrieved user listing for &quot;.$dacura_server-&gt;contextStr());
	}
	else {
		$dacura_server-&gt;write_http_error();
	}
}

function viewUser($id){
	global $dacura_server;
	$dacura_server-&gt;init(&quot;get_user&quot;, $id);
	if($object_user = $dacura_server-&gt;getUserPrunedForContext($id)){
		return $dacura_server-&gt;write_json_result($object_user, &quot;Viewing user $id&quot;);
	}
	else {
		$dacura_server-&gt;write_http_error();
	}
}

function createUser(){
	global $dacura_server;
	$dacura_server-&gt;init(&quot;create_user&quot;);
	$json = json_decode(file_get_contents('php://input'), true);
	if(!$json || !isset($json['email']) or !$json['email'] or !isset($json['password']) or !$json['password']){
		return $dacura_server-&gt;write_http_error(400, &quot;Missing parameters: new users must have password and email&quot;);
	}
	if(isset($json['role']) &amp;&amp; !isset($json['roles'])){
		$json['roles'] = array(array(&quot;collection_id&quot; =&gt; $dacura_server-&gt;cid(),&quot;role&quot; =&gt; $json['role']));
	}
	if($dacura_server-&gt;canAddUser($json) &amp;&amp; ($uobj = $dacura_server-&gt;addUser($json))){
		return $dacura_server-&gt;write_json_result($uobj, &quot;User $uobj-&gt;id has been created&quot;);
	}
	return $dacura_server-&gt;write_http_error();
}

function updateUser($id){
	global $dacura_server;
	$dacura_server-&gt;init(&quot;update_user&quot;, $id);
	if(!($json = json_decode(file_get_contents('php://input'), true))){
		return $dacura_server-&gt;write_http_error(400, &quot;failed to read user object from input&quot;);
	}
	if(($object = $dacura_server-&gt;getUser($id)) &amp;&amp; $dacura_server-&gt;canUpdateUser($object, $json) &amp;&amp; $dacura_server-&gt;updateUser($object, $json)){
		return $dacura_server-&gt;write_json_result($object, &quot;User $id has been updated&quot;);
	}
	$dacura_server-&gt;write_http_error();		
}

function deleteUser($id){
	global $dacura_server;
	$dacura_server-&gt;init(&quot;delete_user&quot;, $id);
	if(!($u = $dacura_server-&gt;getUser($id))){
		return $dacura_server-&gt;write_http_error();
	}
	if($dacura_server-&gt;canDeleteUser($u) &amp;&amp; ($dacura_server-&gt;deleteUser($u))){
		return $dacura_server-&gt;write_json_result(true, &quot;User $id has been deleted&quot;);
	}
	$dacura_server-&gt;write_http_error();
}

function updateUserPassword($id){
	global $dacura_server;
	$dacura_server-&gt;init(&quot;updatepassword&quot;, $id);
	$json = json_decode(file_get_contents('php://input'), true);
	if(!$json || isset($json['password'])){
		return $dacura_server-&gt;write_http_error(400, &quot;failed to read password update json object from input&quot;);
	}
	if(!($uobj = $dacura_server-&gt;getUser($id))){
		return $dacura_server-&gt;write_http_error();
	}
	if($dacura_server-&gt;canUpdatePassword($uobj) &amp;&amp; $dacura_server-&gt;updatePassword($uobj, $json['password'])){
		return $dacura_server-&gt;write_json_result(&quot;OK&quot;, &quot;User $id password updated&quot;);				
	}
	return $dacura_server-&gt;write_http_error();
}

function deleteRole($uid, $rid){
	global $dacura_server;
	$dacura_server-&gt;init(&quot;deleterole&quot;, &quot;$rid&quot;);
	if(!(($uobj = $dacura_server-&gt;getUser($uid)) &amp;&amp; ($role = $uobj-&gt;getRole($rid)))){
		return $dacura_server-&gt;write_http_error();
	}
	if($dacura_server-&gt;canDeleteRole($uobj, $role) &amp;&amp; $dacura_server-&gt;deleteRole($uobj, $role)){
		return $dacura_server-&gt;write_json_result($uobj, &quot;Role $rid has been removed from user $uid&quot;);
	}
	return $dacura_server-&gt;write_http_error();		
}

function createRole($uid){
	global $dacura_server;
	$dacura_server-&gt;init(&quot;createrole&quot;, $uid);
	$role_obj = json_decode(file_get_contents('php://input'), true);
	if(!$role_obj){
		return $dacura_server-&gt;write_http_error(400, &quot;Bad parameters: could not decipher json object for new role&quot;);
	}
	if(($uobj = $dacura_server-&gt;getUser($uid)) &amp;&amp;  $dacura_server-&gt;canCreateRole($uobj, $role_obj[&quot;collection&quot;], $role_obj[&quot;role&quot;]) 
			&amp;&amp; $dacura_server-&gt;createRole($uobj, $role_obj[&quot;collection&quot;], $role_obj[&quot;role&quot;])){
		return $dacura_server-&gt;write_json_result($uobj, &quot;Role has been added to user $uid&quot;);
	}
	return $dacura_server-&gt;write_http_error();
}

function viewUserHistory($id){
	global $dacura_server;
	$dacura_server-&gt;init(&quot;userhistory&quot;, $id);
	$uobj = $dacura_server-&gt;getUser($id);
	if($dacura_server-&gt;canViewUserHistory($uobj) &amp;&amp; ($user_history = $dacura_server-&gt;getUserHistory($uobj))){
		return $dacura_server-&gt;write_json_result($user_history, &quot;Viewing user history $id&quot;);
	}
	else {
		$dacura_server-&gt;write_http_error();
	}
}

function inviteUsers(){
	global $dacura_server;
	$json = json_decode(file_get_contents('php://input'), true);
	if(!$json){
		return $dacura_server-&gt;write_http_error(400, &quot;failed to read invitation json from input&quot;);
	}
	if(!isset($json['emails']) || !$json['emails']){
		return $dacura_server-&gt;write_http_error(400, &quot;No emails specified for invitation&quot;);
	}
	if(!isset($json['role']) || !$json['role']){
		return $dacura_server-&gt;write_http_error(400, &quot;No role specified in invitation&quot;);
	}
	if(!isset($json['message']) || !$json['message']){
		return $dacura_server-&gt;write_http_error(400, &quot;No message specified in invitation&quot;);
	}
	$invite_list = $dacura_server-&gt;parseInviteList($json['emails'], $json['role']);
	if($dacura_server-&gt;inviteListContainsValidEntries($invite_list)){
		$invite_report = $dacura_server-&gt;processInviteList($invite_list, $json['role'], $json['message']);
		return $dacura_server-&gt;write_json_result($invite_report, &quot;issued &quot;.count($invite_report['issued']).&quot; invitations, &quot;.count($invite_report['failed']).&quot; failures&quot;);
	}
	else {
		$invite_report = $dacura_server-&gt;getInviteErrorReport($invite_list);
		$dacura_server-&gt;write_json_error($invite_report, 400, &quot;Invitations: all &quot;.count($invite_report['failed']).&quot; failed&quot;);
	}
}

</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>