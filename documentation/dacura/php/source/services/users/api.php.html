<html>
    <head>
        <script
            type="text/javascript"
            src="../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
/**
 * API for users service - viewing and updating user details
 *
 * Creation Date: 12/01/2015
 * @author chekov
 * @package users/api
 * @license GPL v2
 */

if($dacura_server-&gt;userHasFacet(&quot;list&quot;)){
	getRoute()-&gt;get('/', 'listUsers');
}
if($dacura_server-&gt;userHasFacet(&quot;admin&quot;)){
	getRoute()-&gt;post('/', 'createUser');	
	getRoute()-&gt;post('/invite', 'inviteUsers');
	getRoute()-&gt;delete('/(\w+)', 'deleteUser');
	getRoute()-&gt;delete('/(\w+)/role/(\w+)', 'deleteRole');
	getRoute()-&gt;post('/(\w+)/role', 'createRole');
	getRoute()-&gt;post('/(\w+)', 'updateUser');
	getRoute()-&gt;post('/(\w+)/password', 'updateUserPassword');
}
if($dacura_server-&gt;userHasFacet(&quot;inspect&quot;)){
	getRoute()-&gt;get('/(\w+)/history', 'viewUserHistory');
}
//we need to load stuff to check permissions for the below - done in the functions below

if($dacura_server-&gt;userHasFacet(&quot;view&quot;)){
	getRoute()-&gt;get('/(\w+)', 'viewUser');
}
getRoute()-&gt;get('/load/(\w+)', 'switchUser'); //must be turned off - only for testing

/**
 * GET /load/$userid
 * 
 * Changes the current user to the user with id $userid
 * Just for testing different users - not for production!!!
 * @param $id the user id
 * @api
 */
function switchUser($id){
	global $dacura_server;
	$dacura_server-&gt;write_json_result($dacura_server-&gt;userman-&gt;switchToUser($id), &quot;Switched to user $id&quot;);
}

/**
 * GET /
 * 
 * Returns an array of all the users in the context
 * @api
 */
function listUsers(){
	global $dacura_server;
	$dacura_server-&gt;init(&quot;list_users&quot;);
	$collobj = $dacura_server-&gt;getUsersInContext();
	if($collobj){
		$dacura_server-&gt;write_json_result(array_values($collobj), &quot;Retrieved user listing for &quot;.$dacura_server-&gt;contextStr());
	}
	else {
		$dacura_server-&gt;write_http_error();
	}
}


/**
 * Invite a list of users to join the collection
 * @api
 * POST /invite
 *
 * requires $json[emails] &amp;&amp; json[role] &amp;&amp; json[message]
 *
 * @return a parse invitation result report (issued:&lt;array&gt;, failed: array&lt;&gt;)
 */
function inviteUsers(){
	global $dacura_server;
	$json = json_decode(file_get_contents('php://input'), true);
	if(!$json){
		return $dacura_server-&gt;write_http_error(400, &quot;failed to read invitation json from input&quot;);
	}
	if(!isset($json['emails']) || !$json['emails']){
		return $dacura_server-&gt;write_http_error(400, &quot;No emails specified for invitation&quot;);
	}
	if(!isset($json['role']) || !$json['role']){
		return $dacura_server-&gt;write_http_error(400, &quot;No role specified in invitation&quot;);
	}
	if(!isset($json['message']) || !$json['message']){
		return $dacura_server-&gt;write_http_error(400, &quot;No message specified in invitation&quot;);
	}
	$invite_list = $dacura_server-&gt;parseInviteList($json['emails'], $json['role']);
	if($dacura_server-&gt;inviteListContainsValidEntries($invite_list)){
		$invite_report = $dacura_server-&gt;processInviteList($invite_list, $json['role'], $json['message']);
		return $dacura_server-&gt;write_json_result($invite_report, &quot;issued &quot;.count($invite_report['issued']).&quot; invitations, &quot;.count($invite_report['failed']).&quot; failures&quot;);
	}
	else {
		$invite_report = $dacura_server-&gt;getInviteErrorReport($invite_list);
		$dacura_server-&gt;write_json_error($invite_report, 400, &quot;Invitations: all &quot;.count($invite_report['failed']).&quot; failed&quot;);
	}
}


/**
 * Create a new user object
 * 
 * POST /
 * 
 * requires $json[email] &amp;&amp; json[password]
 * optional $json[roles], $json[status], $json[name], $json[profile]
 * 
 * Creates a new user object from the json object passed
 * Returns the new user object if it was successfully created
 * 
 * @api
 */
function createUser(){
	global $dacura_server;
	$dacura_server-&gt;init(&quot;create_user&quot;);
	$json = json_decode(file_get_contents('php://input'), true);
	if(!$json || !isset($json['email']) or !$json['email'] or !isset($json['password']) or !$json['password']){
		return $dacura_server-&gt;write_http_error(400, &quot;Missing parameters: new users must have password and email&quot;);
	}
	if(isset($json['role']) &amp;&amp; !isset($json['roles'])){
		$json['roles'] = array(array(&quot;collection_id&quot; =&gt; $dacura_server-&gt;cid(),&quot;role&quot; =&gt; $json['role']));
	}
	if($dacura_server-&gt;canAddUser($json) &amp;&amp; ($uobj = $dacura_server-&gt;addUser($json))){
		return $dacura_server-&gt;write_json_result($uobj, &quot;User $uobj-&gt;id has been created&quot;);
	}
	return $dacura_server-&gt;write_http_error();
}

/**
 * Fetch a user object
 * GET /$id
 * @param string $id the id of the user to be viewed
 * @return JSON DacuraUser object
 * @api
 */
function viewUser($id){
	global $dacura_server;
	$dacura_server-&gt;init(&quot;get_user&quot;, $id);
	if($object_user = $dacura_server-&gt;getUserPrunedForContext($id)){
		return $dacura_server-&gt;write_json_result($object_user, &quot;Viewing user $id&quot;);
	}
	else {
		$dacura_server-&gt;write_http_error();
	}
}

/**
 * Updates a user object
 * 
 * POST /$id
 * 
 * optional $json[email], $json[status], $json[name], $json[profile]
 * @param string $id the id of the user
 * @return JSON DacuraUser object
 * @api
 */
function updateUser($id){
	global $dacura_server;
	$dacura_server-&gt;init(&quot;update_user&quot;, $id);
	if(!($json = json_decode(file_get_contents('php://input'), true))){
		return $dacura_server-&gt;write_http_error(400, &quot;failed to read user object from input&quot;);
	}
	if(($object = $dacura_server-&gt;getUser($id)) &amp;&amp; $dacura_server-&gt;canUpdateUser($object, $json)){
		$nobj = $dacura_server-&gt;updateUser($object, $json);
		if($nobj) return $dacura_server-&gt;write_json_result($nobj, &quot;User $id has been updated&quot;);
	}
	$dacura_server-&gt;write_http_error();		
}

/**
 * Deletes the user from the system
 * 
 * @api
 * DELETE /$id
 * @param string $id
 * @return true if successeful
 * @api
*/
function deleteUser($id){
	global $dacura_server;
	$dacura_server-&gt;init(&quot;delete_user&quot;, $id);
	if(!($u = $dacura_server-&gt;getUser($id))){
		return $dacura_server-&gt;write_http_error();
	}
	if($dacura_server-&gt;canDeleteUser($u) &amp;&amp; ($dacura_server-&gt;deleteUser($u))){
		return $dacura_server-&gt;write_json_result(true, &quot;User $id has been deleted&quot;);
	}
	$dacura_server-&gt;write_http_error();
}

/**
 * Updates the password of a user
 * POST /$id/password
 * 
 * requires $json[password] 
 * 
 * @param string $id the id of the user to be updated
 * @return &quot;OK&quot; on success
 * @api
 */
function updateUserPassword($id){
	global $dacura_server;
	$dacura_server-&gt;init(&quot;updatepassword&quot;, $id);
	$json = json_decode(file_get_contents('php://input'), true);
	if(!$json || !isset($json['password'])){
		return $dacura_server-&gt;write_http_error(400, &quot;failed to read password update json object from input&quot;);
	}
	if(!($uobj = $dacura_server-&gt;getUser($id))){
		return $dacura_server-&gt;write_http_error();
	}
	if($dacura_server-&gt;canUpdatePassword($uobj) &amp;&amp; $dacura_server-&gt;updatePassword($uobj, $json['password'])){
		return $dacura_server-&gt;write_json_result(&quot;OK&quot;, &quot;User $id password updated&quot;);				
	}
	return $dacura_server-&gt;write_http_error();
}

/**
 * Creates a role in a user object
 *
 * @api
 * POST /$uid/role
 *
 * requires $json[collection] &amp;&amp; json[role]
 *
 * @param string $uid a user id
 * @return a json dacura user object
 */
function createRole($uid){
	global $dacura_server;
	$dacura_server-&gt;init(&quot;createrole&quot;, $uid);
	$role_obj = json_decode(file_get_contents('php://input'), true);
	if(!$role_obj){
		return $dacura_server-&gt;write_http_error(400, &quot;Bad parameters: could not decipher json object for new role&quot;);
	}
	if(($uobj = $dacura_server-&gt;getUser($uid)) &amp;&amp;  $dacura_server-&gt;canCreateRole($uobj, $role_obj[&quot;collection&quot;], $role_obj[&quot;role&quot;])){
		$nobj = $dacura_server-&gt;createRole($uobj, $role_obj[&quot;collection&quot;], $role_obj[&quot;role&quot;]);
		if($nobj) return $dacura_server-&gt;write_json_result($nobj, &quot;Role has been added to user $uid&quot;);
	}
	return $dacura_server-&gt;write_http_error();
}

/**
 * Deletes a role from a user
 * 
 * @api
 * DELETE /$uid/role/$rid
 * @param string $uid the user id
 * @param string $rid the role id
 * @return the json dacura user object of the updated user
 */
function deleteRole($uid, $rid){
	global $dacura_server;
	$dacura_server-&gt;init(&quot;deleterole&quot;, &quot;$rid&quot;);
	if(!(($uobj = $dacura_server-&gt;getUser($uid)) &amp;&amp; ($role = $uobj-&gt;getRole($rid)))){
		return $dacura_server-&gt;write_http_error();
	}
	if($dacura_server-&gt;canDeleteRole($uobj, $role)){
		$nobj = $dacura_server-&gt;deleteRole($uobj, $role);
		if($nobj) return $dacura_server-&gt;write_json_result($nobj, &quot;Role $rid has been removed from user $uid&quot;);
	}
	return $dacura_server-&gt;write_http_error();		
}

/**
 * View a users historical sessions
 * 
 * @api
 * GET /$id/history
 * @param string $uid a user id
 * @return an array of json session objects
 */
function viewUserHistory($id){
	global $dacura_server;
	$dacura_server-&gt;init(&quot;userhistory&quot;, $id);
	$uobj = $dacura_server-&gt;getUser($id);
	if($dacura_server-&gt;canViewUserHistory($uobj)){
		$user_history = $dacura_server-&gt;getUserHistory($uobj);
		if(is_array($user_history)){
			return $dacura_server-&gt;write_json_result($user_history, &quot;Viewing user history $id&quot;);
		}
	}
	$dacura_server-&gt;write_http_error();
}

</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>