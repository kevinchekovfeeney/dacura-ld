<html>
    <head>
        <script
            type="text/javascript"
            src="../../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php 
/** 
 * Collection configuration page
 * 
 * @package config/screens
 * @author chekov
 * @copyright GPL v2
 */
?&gt;
&lt;div class='dacura-screen' id='collection-config'&gt;
	&lt;?php if(in_array(&quot;collection-configuration&quot;, $params['subscreens'])) { ?&gt;
	&lt;div class='dacura-subscreen' id=&quot;collection-configuration&quot; title=&quot;Settings&quot;&gt;
		&lt;div class='subscreen-intro-message'&gt;&lt;/div&gt;
		&lt;?php echo $service-&gt;getInputTableHTML(&quot;sysconfig&quot;, $params['sysconfig_fields'], $params['sysconfig_settings']);?&gt;
		&lt;div id=&quot;kcfinder_div&quot; class='dch'&gt;&lt;/div&gt;
		&lt;div class=&quot;subscreen-buttons&quot;&gt;
			&lt;?php if(isset($params['candelete']) &amp;&amp; $params['candelete']){?&gt;
			&lt;button id='deletecollection' class='dacura-delete subscreen-button'&gt;Delete Collection&lt;/button&gt;
			&lt;?php } if(isset($params['sysconfig_settings']['display_type']) &amp;&amp; $params['sysconfig_settings']['display_type'] == &quot;update&quot;){?&gt;
				&lt;button id='configupdate' class='dacura-update subscreen-button'&gt;Update Configuration&lt;/button&gt;
			&lt;?php } ?&gt;
		&lt;/div&gt;		
	&lt;/div&gt;
	&lt;?php } if(in_array(&quot;view-files&quot;, $params['subscreens'])) { ?&gt;
	&lt;div class='dacura-subscreen' id=&quot;view-files&quot; title=&quot;Files&quot;&gt;
		&lt;div class='subscreen-intro-message'&gt;&lt;/div&gt;
		&lt;div id='kcfilebrowser'&gt;&lt;/div&gt;
	&lt;/div&gt;
	&lt;?php } if(in_array(&quot;view-services&quot;, $params['subscreens'])) { ?&gt;
	&lt;div class='dacura-subscreen' id=&quot;view-services&quot; title=&quot;Services&quot;&gt;
		&lt;div class='subscreen-intro-message'&gt;&lt;/div&gt;
		&lt;div id='servicelist'&gt;
			&lt;div id='srvrtable'&gt;
				&lt;table id=&quot;services-table&quot; class=&quot;dacura-api-listing&quot;&gt;
					&lt;thead&gt;
					&lt;tr&gt;
						&lt;th id=&quot;dso-id&quot; title=&quot;The internal ID of the collection - a component in all collection internal URLs&quot;&gt;ID&lt;/th&gt;
						&lt;th id=&quot;dso-status&quot; title=&quot;Only services with status 'accept' are enabled.&quot;&gt;Status&lt;/th&gt;
						&lt;th id=&quot;dso-selector&quot; title=&quot;Update a group of services&quot;&gt;Update&lt;/th&gt;
					&lt;/tr&gt;
					&lt;/thead&gt;
					&lt;tbody&gt;&lt;/tbody&gt;
				&lt;/table&gt;
			&lt;/div&gt;
		&lt;/div&gt;
		&lt;div id='servicebox' class='subsubscreen dch'&gt;
			&lt;div id='servicebox-contents'&gt;&lt;/div&gt;
			&lt;?php if(isset($params['service_config_settings']['display_type']) &amp;&amp; $params['service_config_settings']['display_type'] == &quot;update&quot;){?&gt;
				&lt;div class=&quot;subscreen-buttons&quot;&gt;
					&lt;button id='serviceupdate' class='dacura-update subscreen-button'&gt;Update Service Configuration&lt;/button&gt;
				&lt;/div&gt;
			&lt;?php } ?&gt;
		&lt;/div&gt;
	&lt;/div&gt;
	&lt;?php } if(in_array(&quot;view-logs&quot;, $params['subscreens'])) { ?&gt;
	&lt;div class='dacura-subscreen' id=&quot;view-logs&quot; title=&quot;Logs&quot;&gt;
		&lt;div class='subscreen-intro-message'&gt;&lt;/div&gt;
		&lt;?php echo RequestLog::getAsListingTable(&quot;logtable&quot;)?&gt;
	&lt;/div&gt;	
	&lt;?php } ?&gt;
&lt;/div&gt;
&lt;script&gt;

/* result reporting */

function showUpdateSuccess(data, pconf, msg){
	opts = {};
	if(typeof data.collection == &quot;object&quot; &amp;&amp; typeof data.collection.name == &quot;string&quot;){
		opts.cname = data.collection.name; 
	}
	if(typeof data.settings == &quot;object&quot; &amp;&amp; typeof data.settings.icon == &quot;string&quot;){ 
		opts.cicon = data.settings.icon;
	}
	if(!isEmpty(opts)){
		dacura.system.updateTopbar(opts);
	}
	if(typeof data.settings == &quot;object&quot; &amp;&amp; typeof data.settings.background == &quot;string&quot;){
		dacura.system.updateHeader({background: data.settings.background});
	}
	dacura.system.showSuccessResult(&quot;Updates successfully saved&quot;, msg, pconf.resultbox, false, {'scrollTo': true, &quot;icon&quot;: true, &quot;closeable&quot;: true});
	drawCollection(data);
}

/* updates the current settings of a collection - called by collection configuration button */
function updateSettings(obj, result, pconf){
	data = {settings: obj};
	dacura.config.updateCollection(data, result, pconf);
}

/* Draws the collection screens - including all the subscreens*/
function drawCollection(obj){
	if(typeof lconfig == &quot;object&quot;){
		for(var k in obj){
			lconfig[k] = obj[k];
		}
	}
	else {
		lconfig = obj;
	}
	if(typeof obj.settings == &quot;object&quot;){
		obj.settings.name = obj.collection.name;
		obj.settings.id = obj.collection.id;
		obj.settings.status = obj.collection.status;
		dacura.tool.form.populate(&quot;sysconfig&quot;, obj.settings);
	}
	&lt;?php if(in_array(&quot;view-services&quot;, $params['subscreens'])) { ?&gt;
	
	if(typeof obj.services == &quot;object&quot;){
		drawServiceTable(obj.services, obj.collection);
	}
	$('button.update-service').button().click(function(){
		var bits = this.id.split(&quot;-&quot;);
		var sid = bits[0];
		if(typeof lconfig.services[sid] == &quot;object&quot;){
			nobj = lconfig.services[sid];
			nobj.status = bits[1];
		}
		else {
			nobj = {&quot;status&quot;: bits[1]};
		}
		var ndata = {&quot;services&quot;: {}};
		ndata.services[sid] = nobj;
		var onwards = function(data, pconf){
			showUpdateSuccess(data, pconf, sid + &quot; updated: &quot; + bits[1] + &quot;d&quot;);
		}
		pconf = typeof service_subpage_conf == &quot;object&quot; ? service_subpage_conf : dacura.tool.subscreens['view-services'];
		dacura.config.updateCollection(ndata, onwards, pconf);
	});
	&lt;?php } ?&gt;
}

/* Storing various data in javascript variables for access by screens */
&lt;?php if(in_array(&quot;view-services&quot;, $params['subscreens'])) { ?&gt;
var allroles = &lt;?=isset($params['all_roles']) ? json_encode($params['all_roles']) : &quot;{}&quot;?&gt;;
var service_tables = &lt;?= json_encode($params['service_tables']); ?&gt;;

/* result reporting */ 
function showDeleteResult(obj, targets){
	dacura.system.showWarningResult(&quot;This collection has been deleted&quot;, &quot;Collection &quot; + dacura.system.cid() + &quot; deleted&quot;, targets.resultbox, false, targets.mopts);
}

/* Called when user clicks 'remove' link of facet page */
function facet_remove(divid, r, f){
	id = current_service;
	var nfacets = [];
	for(var i = 0; i &lt; lconfig.services[id].facets.length; i++){
		if(lconfig.services[id].facets[i].facet == f &amp;&amp; lconfig.services[id].facets[i].role == r){
			
		}
		else {
			nfacets.push(lconfig.services[id].facets[i]);
		}
	}
	lconfig.services[id].facets = nfacets;
	var ndata = {&quot;services&quot;: {}};
	ndata.services[id] = lconfig.services[id];
	var onwards = function(data, pconf){
		$('#'+divid).remove();
		showUpdateSuccess(data, pconf, id + &quot; updated&quot;);
	}
	dacura.config.updateCollection(ndata, onwards, service_subpage_conf);	
}

/* Called when user updates list of facets for a service */
function updateFacetList(key, facets, pconf, allfacets){
	var html = &quot;&quot;;
	for(var i = 0; i &lt; facets.length; i++){
		var rtitle = allroles[facets[i].role];
		if(typeof allfacets == &quot;object&quot; &amp;&amp; typeof allfacets[facets[i].facet] == &quot;string&quot;){
			fac = allfacets[facets[i].facet];
		}
		else {
			fac = facets[i].facet;
		}
		html += dacura.config.getFacetButtonHTML(key+&quot;-facet-&quot; + i, facets[i].role, rtitle, facets[i].facet, fac);
	}
	$('#' + key + ' .dacura-facets-listing').html(html);
}

/* Loads the service with the passed id into the screen */
function loadService(id){
	current_service = id;
	dacura.tool.clearResultMessages();
	if(!isEmpty(service_tables[id])){
		$('#servicebox-contents').empty().append(service_tables[id].body);
		dacura.tool.form.init('service-'+id, {initselects: true, icon: &quot;&lt;?= $service-&gt;furl(&quot;images&quot;, &quot;icons/help-icon.png&quot;)?&gt;&quot;});
		$('.addfacet').button().click(function(event){
			var f = $('.facet-maker select.facets').val();
			var r = $('.facet-maker select.roles').val();
			if(typeof lconfig.services[id].facets == &quot;object&quot;){
				lconfig.services[id].facets.push({&quot;facet&quot;: f, &quot;role&quot;: r});
			}
			var ndata = {&quot;services&quot;: {}};
			ndata.services[id] = lconfig.services[id];
			var onwards = function(data, pconf){
				updateFacetList(&quot;servicebox-contents&quot;, lconfig.services[id].facets, pconf, lconfig.services[id][&quot;facet-list&quot;]); 
				showUpdateSuccess(data, pconf, id + &quot; updated&quot;);
			}
			dacura.config.updateCollection(ndata, onwards, service_subpage_conf);	
		});
		dacura.tool.form.populate('service-'+id, lconfig.services);		
	}
	else {
		dacura.system.showErrorResult(&quot;Found no service configuration information for &quot; + id, &quot;Error loading service&quot;, '#servicebox-contents');
	}
	
	service_subpage_conf = dacura.tool.loadSubscreen('servicelist', 'servicebox', &quot;return to list of services&quot;, service_tables[id].header);
}

/* updates the config of a particular service */
function updateServiceConfig(obj, result, pconf){
	var sid = obj.id;
	delete(obj.id);
	var data = {&quot;services&quot;: {}};
	data.services[sid] = obj;
	pconf = typeof service_subpage_conf == &quot;object&quot; ? service_subpage_conf : pconf;
	dacura.config.updateCollection(data, result, pconf);
}

/* reads the data from the form, marshalls it and sends it to the update api */
function readServiceUpdate(screen){
	//get id of currently loaded serviced
	if($('#servicebox-contents table').length){
		var tid = $(&quot;#servicebox-contents table&quot;).attr(&quot;id&quot;);
		var obj = dacura.tool.form.gather(tid);
		if(typeof obj.meta == &quot;object&quot; &amp;&amp; typeof obj.values == &quot;object&quot;){

		}
		obj.id = tid.substring(8);
		return obj;
	}
	else {
		alert(&quot;No input data available to update service configuration&quot;);
	}
	return {};
}

/* draws the table which lists the services available */
function drawServiceTable(services, col){
	var service_rows = dacura.config.getServiceTableRows(services, col);
	if(!sloaded){
		dacura.tool.table.init(&quot;services-table&quot;, {
			&quot;screen&quot;: &quot;view-services&quot;,
			&quot;nohover&quot;: true, 
			&quot;container&quot;: &quot;srvrtable&quot;,
			&quot;dtsettings&quot;: &lt;?=$params['service_table_settings']?&gt;
		}, service_rows);
		sloaded = true;
	}
	else {
		dacura.tool.table.reincarnate(&quot;services-table&quot;, service_rows, dacura.tool.tables[&quot;services-table&quot;]); 	
	}
	for(sid in services){
		if(services[sid].status == 'enable'){
			$('#services-table td.dso-id:contains(&quot;' + sid + '&quot;)').hover(function(){
				$(this).closest('tr').addClass('userhover');
			}, function() {
			    $(this).closest('tr').removeClass('userhover');
			}).click( function(event){
				loadService($(event.target).html());
			});					
		}
	}

}

&lt;?php } ?&gt;
var fbloaded = false;//is the configuration loaded
var lconfig;//the most recent configuration received from the api
var sloaded = false; // the currently loaded service

 /* page initialisation - forms, tables, etc */
 $(function() {
	dacura.tool.init({
		&quot;tabbed&quot;: 'collection-config', 
		&quot;forms&quot;: {
			ids: ['sysconfig'], 
			icon: &quot;&lt;?= $service-&gt;furl(&quot;images&quot;, &quot;icons/help-icon.png&quot;)?&gt;&quot;,
			fburl: &quot;&lt;?php echo $service-&gt;getFileBrowserURL()?&gt;&quot;
		}
	}); 
	
    &lt;?php if(in_array(&quot;view-logs&quot;, $params['subscreens'])) { ?&gt;
    dacura.tool.table.init(&quot;logtable&quot;, {
		&quot;screen&quot;: &quot;view-logs&quot;, 
		&quot;fetch&quot;: dacura.config.getLogs,
		&quot;refresh&quot;: {label: &quot;Refresh Log Listing&quot;},
		&quot;dtsettings&quot;: &lt;?=$params['log_table_settings']?&gt;
	});		
    &lt;?php } if(in_array(&quot;collection-configuration&quot;, $params['subscreens']) &amp;&amp; isset($params['sysconfig_settings']['display_type']) &amp;&amp; $params['sysconfig_settings']['display_type'] == &quot;update&quot;){?&gt;
    dacura.tool.button.init(&quot;configupdate&quot;, {
		&quot;screen&quot;: &quot;collection-configuration&quot;,			
		&quot;source&quot;: &quot;sysconfig&quot;,
		&quot;submit&quot;: updateSettings,
		&quot;result&quot;: function(data, pconf){showUpdateSuccess(data, pconf, &quot;Configuration settings updated ok&quot;);}
	});
    &lt;?php } if(in_array(&quot;view-services&quot;, $params['subscreens']) &amp;&amp; isset($params['service_config_settings']['display_type']) &amp;&amp; $params['service_config_settings']['display_type'] == &quot;update&quot;) { ?&gt;
	dacura.tool.button.init(&quot;serviceupdate&quot;, {
		&quot;screen&quot;: &quot;view-services&quot;,			
		&quot;gather&quot;: readServiceUpdate,
		&quot;submit&quot;: updateServiceConfig,
		&quot;result&quot;: function(data, pconf) { showUpdateSuccess(data, pconf, &quot;System Configuration Updated OK&quot;);}
	});
    &lt;?php } if(isset($params['candelete'])){?&gt;
	dacura.tool.button.init(&quot;deletecollection&quot;, {
		&quot;screen&quot;: &quot;collection-configuration&quot;,
		&quot;gather&quot;: function(){ return dacura.system.cid();},
		&quot;submit&quot;: dacura.config.deleteCollection, 
		&quot;result&quot;: showDeleteResult
	});
	&lt;?php } if(in_array(&quot;view-files&quot;, $params['subscreens'])) { ?&gt;
    if(!fbloaded &amp;&amp; $(&quot;#kcfilebrowser&quot;).is(':visible')){
		dacura.tool.openKCFinder(&quot;#kcfilebrowser&quot;, &quot;&lt;?php echo $service-&gt;getFileBrowserURL()?&gt;&quot;, dacura.system.cid(), &quot;images&quot;);	
    }
	$('#collection-config').tabs( {
        &quot;activate&quot;: function(event, ui) {
        	 if($(&quot;#kcfilebrowser&quot;).is(':visible')){
        		dacura.tool.openKCFinder(&quot;#kcfilebrowser&quot;, &quot;&lt;?php echo $service-&gt;getFileBrowserURL()?&gt;&quot;, dacura.system.cid(), &quot;images&quot;);	
        	 }
        	 else {
				$(&quot;#kcfilebrowser&quot;).html(&quot;&quot;);
           	}
     	 }
    });
	&lt;?php } ?&gt;	
        
	var pconf = { resultbox: &quot;.tool-info&quot;, errorbox: &quot;.tool-info&quot;, busybox: &quot;#collection-config&quot;};
    dacura.config.fetchCollection(dacura.system.cid(), drawCollection, pconf);
    fbloaded = true;
});
&lt;/script&gt;</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>