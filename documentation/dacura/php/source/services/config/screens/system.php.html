<html>
    <head>
        <script
            type="text/javascript"
            src="../../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php 
/** 
 * Platform / System level configuration page
 * 
 * @package config/screens
 * @author chekov
 * @copyright GPL v2
 */
?&gt;
&lt;div class='dacura-screen' id='system-config'&gt;
	&lt;?php if(in_array(&quot;system-configuration&quot;, $params['subscreens'])) { ?&gt;
	&lt;div class='dacura-subscreen' id=&quot;system-configuration&quot; title=&quot;System Settings&quot;&gt;
		&lt;div class='subscreen-intro-message'&gt;&lt;?= isset($params['system-configuration-intro']) ? $params['system-configuration-intro'] : &quot;&quot;?&gt;&lt;/div&gt;
		&lt;?php echo $service-&gt;getInputTableHTML(&quot;sysconfig&quot;, $params['sysconfig_fields'], $params['sysconfig_settings']);?&gt;
		&lt;div class=&quot;subscreen-buttons&quot;&gt;
			&lt;button id='configupdate' class='dacura-update subscreen-button'&gt;Update Configuration&lt;/button&gt;
		&lt;/div&gt;		
	&lt;/div&gt;
	&lt;?php } if(in_array(&quot;list-collections&quot;, $params['subscreens'])) { ?&gt;
	&lt;div class='dacura-subscreen' id='list-collections' title=&quot;Configure Collections&quot;&gt;
		&lt;div class='subscreen-intro-message'&gt;&lt;?= isset($params['list-collections-intro']) ? $params['list-collections-intro'] : &quot;&quot; ?&gt;&lt;/div&gt;
		&lt;table id=&quot;collections-table&quot; class=&quot;dacura-api-listing&quot;&gt;
			&lt;thead&gt;
			&lt;tr&gt;
				&lt;th id=&quot;dlo-id&quot; title=&quot;The internal ID of the collection - a component in all collection internal URLs&quot;&gt;ID&lt;/th&gt;
				&lt;th id=&quot;dlo-name&quot; title=&quot;The title of the collection - expressed in natural language&quot;&gt;Title&lt;/th&gt;
				&lt;th id=&quot;dlo-status&quot; title=&quot;Only collections with status 'accept' are in use.&quot;&gt;Status&lt;/th&gt;
			&lt;/tr&gt;
			&lt;/thead&gt;
			&lt;tbody&gt;&lt;/tbody&gt;
		&lt;/table&gt;
	&lt;/div&gt;
	&lt;?php } if(in_array(&quot;add-collection&quot;, $params['subscreens'])) { ?&gt;
	&lt;div class='dacura-subscreen' id=&quot;add-collection&quot; title=&quot;Create New Collection&quot;&gt;
		&lt;div class='subscreen-intro-message'&gt;&lt;?= isset($params['add-collection-intro']) ? $params['list-collections-intro'] : &quot;&quot; ?&gt;&lt;/div&gt;
		&lt;?php echo $service-&gt;getInputTableHTML(&quot;collection-details&quot;, $params['create_collection_fields'], $params['create_collection_settings']);?&gt;
		&lt;div class=&quot;subscreen-buttons&quot;&gt;
			&lt;button id='collectioncreate' class='dacura-create subscreen-button'&gt;Create New Collection&lt;/button&gt;
		&lt;/div&gt;
	&lt;/div&gt;
	&lt;?php } if(in_array(&quot;view-files&quot;, $params['subscreens'])) { ?&gt;
	&lt;div class='dacura-subscreen' id=&quot;view-files&quot; title=&quot;System Files&quot;&gt;
		&lt;div class='subscreen-intro-message'&gt;&lt;?= isset($params['view-files-intro']) ? $params['view-files-intro'] : &quot;&quot; ?&gt;&lt;/div&gt;
		&lt;div id='kcfilebrowser'&gt;&lt;/div&gt;
	&lt;/div&gt;
	&lt;?php } if(in_array(&quot;view-services&quot;, $params['subscreens'])) { ?&gt;
	&lt;div class='dacura-subscreen' id=&quot;view-services&quot; title=&quot;Configure Services&quot;&gt;
		&lt;div class='subscreen-intro-message'&gt;&lt;?= isset($params['view-services-intro']) ? $params['view-services-intro'] : &quot;&quot; ?&gt;&lt;/div&gt;
			&lt;div id='servicelist'&gt;
			&lt;div id='srvrtable'&gt;
			&lt;table id=&quot;services-table&quot; class=&quot;dacura-api-listing&quot;&gt;
				&lt;thead&gt;
				&lt;tr&gt;
					&lt;th id=&quot;dso-id&quot; title=&quot;The internal ID of the collection - a component in all collection internal URLs&quot;&gt;ID&lt;/th&gt;
					&lt;th id=&quot;dso-status&quot; title=&quot;Only services with status 'accept' are enabled.&quot;&gt;Status&lt;/th&gt;
					&lt;th id=&quot;dfn-rowselector&quot; title=&quot;Update a group of services&quot;&gt;Update&lt;/th&gt;
				&lt;/tr&gt;
				&lt;/thead&gt;
				&lt;tbody&gt;&lt;/tbody&gt;
			&lt;/table&gt;
			&lt;/div&gt;
			&lt;div class=&quot;subscreen-buttons&quot; id='multi-service-updates'&gt;
				&lt;div id=&quot;service-table-updates&quot;&gt;&lt;/div&gt;
			&lt;/div&gt;
		&lt;/div&gt;
		&lt;div id='servicebox' class='subsubscreen dch'&gt;
			&lt;div id='servicebox-contents'&gt;&lt;/div&gt;
			&lt;div class=&quot;subscreen-buttons&quot;&gt;
				&lt;button id='serviceupdate' class='dacura-update subscreen-button'&gt;Update Service Configuration&lt;/button&gt;
			&lt;/div&gt;
		&lt;/div&gt;
	&lt;/div&gt;
	&lt;?php } if(in_array(&quot;view-logs&quot;, $params['subscreens'])) { ?&gt;
	&lt;div class='dacura-subscreen' id=&quot;view-logs&quot; title=&quot;View Server Logs&quot;&gt;
		&lt;div class='subscreen-intro-message'&gt;&lt;?= isset($params['view-services-intro']) ? $params['view-logs-intro'] : &quot;&quot; ?&gt;&lt;/div&gt;
		&lt;?php echo RequestLog::getAsListingTable(&quot;logtable&quot;)?&gt;
	&lt;/div&gt;	
	&lt;?php } ?&gt;
&lt;/div&gt;

&lt;script&gt;
/* we pre-format the tables for all the services and embed them in the page as a javascript object */
var service_tables = &lt;?= json_encode($params['service_tables']); ?&gt;;
var service_subpage_conf;
/* Updates each of the selected services statuses in sequence */
function updateServicesStatus(ids, status, cnt, pconf){
	dacura.tool.clearResultMessages();
	var obj = {&quot;services&quot;: {}};
	for(var i = 0; i &lt; ids.length; i++){
		obj.services[ids[i]] = lconfig.services[ids[i]]; 
		obj.services[ids[i]].status = status;
	}
	var onwards = function(data, pconf){
		showUpdateSuccess(data, pconf, cnt + &quot; services updated to status &quot; + status);
	}
	dacura.config.updateCollection(obj, onwards, pconf);
}

/* to load a new collection, we just switch pages to it */
function loadCollection(e, id){
	dacura.system.switchContext(id);	
}

/* Loads an individual service following a click on it on the service configuration screen */
function loadService(e, id){
	dacura.tool.clearResultMessages();
	if(!isEmpty(service_tables[id])){
		$('#servicebox-contents').empty().append(service_tables[id].body);
		dacura.tool.form.init('service-'+id, {initselects: true, icon: &quot;&lt;?= $service-&gt;furl(&quot;images&quot;, &quot;icons/help-icon.png&quot;)?&gt;&quot;});
		if(typeof lconfig.collection == &quot;object&quot; &amp;&amp; typeof lconfig.collection.config == &quot;object&quot; &amp;&amp; typeof lconfig.collection.config.servicesmeta == &quot;object&quot;){
			dacura.tool.form.populate('service-'+id, lconfig.services[id], lconfig.collection.config.servicesmeta[id]);
		}
		else {
			dacura.tool.form.populate('service-'+id, lconfig.services[id]);		
		}		
	}
	else {
		dacura.system.showErrorResult(&quot;Found no service configuration information for &quot; + id, &quot;Error loading service&quot;, '#servicebox-contents');
	}
	service_subpage_conf = dacura.tool.loadSubscreen('servicelist', 'servicebox', &quot;return to list of services&quot;, service_tables[id].header);
}

/* reads the updated state of a service configuration from the html form */
function readServiceUpdate(screen){
	if($('#servicebox-contents table').length){
		var tid = $(&quot;#servicebox-contents table&quot;).attr(&quot;id&quot;);
		var obj = dacura.tool.form.gather(tid);
		obj.id = tid.substring(8);
		return obj;
	}
	else {
		alert(&quot;No input data available to update service configuration&quot;);
	}
	return {};
}

/* called to check for illegal and obvious problems with creating collections */
function inputError(obj){
	if(typeof obj.id == &quot;undefined&quot; || typeof obj.title == &quot;undefined&quot;){
		return &quot;bad reading of object from input&quot;;
	}
	if(obj.id.length &lt; 2 || obj.title.length &lt; 5){
		return &quot;The ID must be at least 2 characters long and the title must be at least 5&quot;;
	}
	return false;
}
/* marshalls the data from the passed object then sends it to the server for an update */
function updateServiceConfig(obj, result, pconf){
	var sid = obj.id;
	delete(obj.id);
	var data = {&quot;services&quot;: {}, &quot;servicesmeta&quot;: {}};
	data.services[sid] = obj.values;
	data.servicesmeta[sid] = obj.meta;
	dacura.config.updateCollection(data, result, service_subpage_conf);
}

/* marshalls the data extracted from the update configuration form for passing to the api */
function updateConfiguration(obj, result, pconf){
	obj.settings = obj.values;
	delete(obj.values);
	dacura.config.updateCollection(obj, result, pconf);
}

/* just some result reporting */
function showCreateSuccess(txt, targets){
	dacura.system.showSuccessResult(&quot;You will now be able to configure and activate this collection&quot;, &quot;Collection with id: &quot; + txt + &quot; successfully created&quot;, targets.resultbox, false, {'scrollTo': true, &quot;icon&quot;: true});
	setTimeout(dacura.system.switchContext(txt), 3000);
}

function showUpdateSuccess(data, pconf, msg){
	dacura.system.showSuccessResult(msg, &quot;Updates successfully saved&quot;, pconf.resultbox, false, {'scrollTo': true, &quot;icon&quot;: true});
	drawCollection(data);
}

/* called when settings are received from a call to draw the page */
function drawCollection(obj){
	if(typeof lconfig == &quot;object&quot;){
		for(var k in obj){
			lconfig[k] = obj[k];
		}
	}
	else {
		lconfig = obj;
	}
	if((typeof obj.collection == &quot;object&quot;) &amp;&amp; (typeof obj.collection.config == &quot;object&quot;) &amp;&amp; obj.collection.config &amp;&amp; typeof obj.collection.config.meta == &quot;object&quot;){
		dacura.tool.form.populate(&quot;sysconfig&quot;, lconfig.settings, obj.collection.config.meta);
	}
	else if(typeof obj.settings == &quot;object&quot;){
		dacura.tool.form.populate(&quot;sysconfig&quot;, lconfig.settings);
	}
	if(typeof obj.services == &quot;object&quot;){
		drawServiceTable(obj.services);
	}
}

var sloaded = false;//is the service table loaded
/* draws the table listing the various services */ 
function drawServiceTable(services){
	var service_rows = dacura.config.getServiceTableRows(services);
	if(!sloaded){
		dacura.tool.table.init(&quot;services-table&quot;, {
			&quot;screen&quot;: &quot;view-services&quot;, 
			&quot;container&quot;: &quot;srvrtable&quot;,
			&quot;cellClick&quot;: loadService,
			&quot;multiselect&quot;: {
				options: &lt;?=json_encode($params['selection_options'])?&gt; , 
				intro: &quot;Update selected services: &quot;, 
				container: &quot;service-table-updates&quot;,
				label: &quot;Update&quot;,
				update: updateServicesStatus 
			},		
			&quot;dtsettings&quot;: &lt;?=$params['service_table_settings']?&gt;
		}, service_rows);
		sloaded = true;
	}
	else {
		dacura.tool.table.reincarnate(&quot;services-table&quot;, service_rows, dacura.tool.tables[&quot;services-table&quot;]); 	
	}
}

var fbloaded = false;//is the configuration loaded
var lconfig;//the most recent configuration received from the api

/* page initialisation - forms, tables, etc */
$(function() {	
	dacura.tool.init({
		&quot;tabbed&quot;: 'system-config', 
		forms: {
			ids:['sysconfig','collection-details'], 
			icon: &quot;&lt;?= $service-&gt;furl(&quot;images&quot;, &quot;icons/help-icon.png&quot;)?&gt;&quot;}
		}
	); 
	dacura.tool.table.init(&quot;collections-table&quot;, {
		&quot;screen&quot;: &quot;list-collections&quot;, 
		&quot;fetch&quot;: dacura.config.getCollections,
		&quot;refresh&quot;: {label: &quot;Refresh Collection List&quot;},
		&quot;rowClick&quot;: loadCollection,
		&quot;dtsettings&quot;: &lt;?=$params['dacura_table_settings']?&gt;
	});		
	dacura.tool.table.init(&quot;logtable&quot;, {
		&quot;screen&quot;: &quot;view-logs&quot;, 
		&quot;fetch&quot;: dacura.config.getLogs,
		&quot;refresh&quot;: {label: &quot;Refresh Log Listing&quot;},
		&quot;dtsettings&quot;: &lt;?=$params['log_table_settings']?&gt;
	});		
	dacura.tool.button.init(&quot;configupdate&quot;, {
		&quot;screen&quot;: &quot;system-configuration&quot;,			
		&quot;source&quot;: &quot;sysconfig&quot;,
		&quot;submit&quot;: updateConfiguration,
		&quot;result&quot;: function(data, pconf) { showUpdateSuccess(data, pconf, &quot;System Configuration Updated OK&quot;);}
	});	
	dacura.tool.button.init(&quot;serviceupdate&quot;, {
		&quot;screen&quot;: &quot;view-services&quot;,			
		&quot;gather&quot;: readServiceUpdate,
		&quot;submit&quot;: updateServiceConfig,
		&quot;result&quot;: function(data, pconf) { showUpdateSuccess(data, pconf, &quot;System Configuration Updated OK&quot;);}
	});	
	dacura.tool.button.init(&quot;collectioncreate&quot;, {
		&quot;screen&quot;: &quot;add-collection&quot;,
		&quot;source&quot;: &quot;collection-details&quot;,
		&quot;validate&quot;: inputError, 
		&quot;submit&quot;: dacura.config.addCollection, 
		&quot;result&quot;: showCreateSuccess
	});
    if(!fbloaded &amp;&amp; $(&quot;#kcfilebrowser&quot;).is(':visible')){
		dacura.tool.openKCFinder(&quot;#kcfilebrowser&quot;, &quot;&lt;?php echo $service-&gt;getFileBrowserURL()?&gt;&quot;, dacura.system.cid(), &quot;images&quot;);	
    }
	$('#system-config').tabs( {
        &quot;activate&quot;: function(event, ui) {
        	 if($(&quot;#kcfilebrowser&quot;).is(':visible')){
        		dacura.tool.openKCFinder(&quot;#kcfilebrowser&quot;, &quot;&lt;?php echo $service-&gt;getFileBrowserURL()?&gt;&quot;, dacura.system.cid(), &quot;images&quot;);	
        	 }
        	 else {
				$(&quot;#kcfilebrowser&quot;).html(&quot;&quot;);
           	}
     	 }
    });
	var pconf = { resultbox: &quot;.tool-info&quot;, busybox: &quot;#system-config&quot;};
	dacura.config.fetchCollection(dacura.system.cid(), drawCollection, pconf);
    fbloaded = true;
});
&lt;/script&gt;</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>