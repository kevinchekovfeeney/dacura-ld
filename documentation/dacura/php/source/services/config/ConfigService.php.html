<html>
    <head>
        <script
            type="text/javascript"
            src="../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
include_once(&quot;ConfigDacuraServer.php&quot;);
/**
 * Config Service - provides access to updating / editing / viewing collection configurations.
 *
 * Creation Date: 30/01/2015
 * @package config
 * @author Chekov
 * @license: GPL v2
 */

class ConfigService extends DacuraService {
	/** @var string the view page is the default screen - the only screen of the service (albeit divided into system / collection) */
	var $default_screen = &quot;view&quot;;
	

	/* HTML Generation */
	
	/**
	 * Generates a set of html tables, each with a header and body element for each service in the system
	 * @param array $fsettings an array of settings to be passed to the DacuraForm element underlying the tables... 
	 * @param unknown $sfields
	 * @return multitype:multitype:NULL string
	 */
	function getServiceConfigTables(ConfigDacuraServer &amp;$dacura_server, $fsettings, $sfields = array()){
		$stables = array();
		$services = $dacura_server-&gt;getServiceList();
		foreach($services as $s){
			$fields = $dacura_server-&gt;getServiceConfigFields($s, isset($sfields) ? $sfields : array());
			$tid = &quot;service-&quot;.$s;
			$configs = $dacura_server-&gt;getServiceConfig($s);
			$stables[$s] = array(
				&quot;body&quot; =&gt; $this-&gt;getInputTableHTML($tid, $fields, $fsettings),
				&quot;header&quot; =&gt; $this-&gt;getServiceConfigPageHeaderHTML($s, $configs));
		}
		return $stables;
	}
	
	/**
	 * Generates the HTML for the service page subscreen headers
	 * @param string $sid the service id
	 * @param array $configs the settings for the service
	 * @return string the html string representing the header of the service configuration page
	 */
	function getServiceConfigPageHeaderHTML($sid, $configs){
		$html = &quot;&lt;span class='service-icon'&gt;&lt;img class='serivce-config-img' src='&quot;;
		$html .= $this-&gt;furl(&quot;images&quot;, &quot;services/&quot;.$sid.&quot;.png&quot;).&quot;'&gt;&quot;;
		$html .= &quot;&lt;/span&gt;&lt;span class='service-title'&gt;&quot;;
		if(isset($configs['service-title'])){
			$html .= $configs['service-title']. &quot; configuration&quot;;
		}
		else {
			$html .= ucfirst($sid).&quot; service configuration&quot;;
		}
		$html .= &quot;&lt;/span&gt;&lt;span class='service-description'&gt;&quot;;
		if(isset($configs['service-description'])){
			$html .= $configs['service-description'];
		}
		$html .= &quot;&lt;/span&gt;&quot;;
		return $html;
	}
	
	/**
	 * Generates the url for the appropriate file browser url depending on the context
	 * @return string the filebrowser url
	 */
	function getFileBrowserURL(){
		return $this-&gt;durl().$this-&gt;getSystemSetting('filebrowser').&quot;browse.php&quot;;
	}
	
	/* generating the settings for the dacura forms, depending on the facet, etc */
	
	/**
	 * System Configuration form settings
	 * 
	 * adds meta data column to system level forms and sets up various configuration values
	 * @param ConfigDacuraServer $srvr active server object
	 * @param Collection $col current collection context object
	 * @return array a DacuraForm initialisation settings array
	 */
	function getSysConfigFormSettings(ConfigDacuraServer &amp;$srvr, Collection $col){
		if($this-&gt;cid() == &quot;all&quot;){
			$settings = array(&quot;meta&quot; =&gt; array(&quot;changeable&quot; =&gt; array(&quot;changeable&quot;, &quot;choice&quot;, 
						array(&quot;hidden&quot; =&gt; &quot;Hidden&quot;, &quot;fixed&quot; =&gt; &quot;Fixed&quot;, &quot;changeable&quot; =&gt; &quot;Variable&quot;))),
				&quot;display_type&quot; =&gt; &quot;update&quot;,
				&quot;embedstyle&quot; =&gt; &quot;flat&quot;,
				&quot;show-header&quot; =&gt; 2,
				&quot;header-html&quot; =&gt; &quot;System Configuration Settings&quot;
			);
		}
		else {
			$settings = array(&quot;meta&quot; =&gt; array(), &quot;display_type&quot; =&gt; &quot;view&quot;, &quot;embedstyle&quot; =&gt; &quot;flat&quot;, 
				&quot;show-header&quot; =&gt; 2, &quot;header-html&quot; =&gt; $col-&gt;name .&quot; collection Settings&quot;);
			if($srvr-&gt;userHasFacet(&quot;manage&quot;)){
				$settings['display_type'] = &quot;update&quot;;
			}	
		}
		return $settings;
	}
	
	/**
	 * Service Configuration form settings
	 * 
	 * adds meta data column to system level forms and sets up various configuration values
	 * @param ConfigDacuraServer $srvr active server object
	 * @return array a DacuraForm settings array
	 */
	 function getServiceConfigFormSettings(ConfigDacuraServer &amp;$srvr){
		if($this-&gt;cid() == &quot;all&quot;){
			$settings = array(&quot;meta&quot; =&gt; array(&quot;changeable&quot; =&gt; array(&quot;changeable&quot;,&quot;choice&quot;,
				array(&quot;hidden&quot; =&gt; &quot;Hidden&quot;, &quot;fixed&quot; =&gt; &quot;Fixed&quot;, &quot;changeable&quot; =&gt; &quot;Variable&quot;))));
		}
		else {
			$settings = array(&quot;meta&quot; =&gt; array());
		}
		$settings[&quot;display_type&quot;] = &quot;view&quot;;
		if($srvr-&gt;userHasFacet(&quot;manage&quot;)){
			$settings['display_type'] = &quot;update&quot;;
		}
		if(!($srvr-&gt;userHasFacet(&quot;admin&quot;) || $srvr-&gt;userHasFacet(&quot;inspect&quot;))){
			$settings['shortform'] = true;
		}
		$settings[&quot;embedstyle&quot;] = &quot;flat&quot;;
		$settings[&quot;show-header&quot;] = 0;
		$settings[&quot;header-html&quot;] = &quot;&quot;;
		return $settings;
	}
	
	/**
	 * Create Collection form settings
	 *
	 * @return array a DacuraForm settings array
	 */	
	function getCreateFormSettings(){
		$settings = array(&quot;meta&quot; =&gt; array(), &quot;display_type&quot; =&gt; &quot;create&quot;, &quot;show-header&quot; =&gt; 2, 
			&quot;header-html&quot; =&gt; &quot;New Collection Details&quot;);
		return $settings;
	}
	
	/**
	 * Loads the parameters, depending on context, that must be sent to the configuration tab
	 * @param array $params an array of parameters to be modified (added to)
	 * @param ConfigDacuraServer $dacura_server the active server object
	 * @param string $screen the html id of the screen that the tab is associated with
	 * @param Collection $col the current collection object
	 * @param DacuraUser $u the current logged in user (false if not logged in)
	 */
	function getSysconfigTabParams(&amp;$params, ConfigDacuraServer &amp;$dacura_server, $screen, Collection $col, $u = false){
		$params['sysconfig_settings'] = $this-&gt;getSysConfigFormSettings($dacura_server, $col);
		if($screen == 'system'){
			$params['sysconfig_fields'] = $dacura_server-&gt;getSysconfigFields($this-&gt;sform(&quot;sysconfig_form_fields&quot;));			
		}
		else {
			$basic_fields = array(&quot;id&quot; =&gt; array(&quot;id&quot; =&gt; &quot;id&quot;, &quot;length&quot; =&gt; &quot;short&quot;, &quot;type&quot; =&gt; &quot;text&quot;, &quot;value&quot; =&gt; $dacura_server-&gt;cid(), &quot;disabled&quot; =&gt; true, &quot;label&quot; =&gt; &quot;id&quot;, &quot;help&quot; =&gt; &quot;The id of the collection - used in urls&quot;));
			$basic_fields = array_merge($basic_fields, $this-&gt;sform(&quot;update_collection_fields&quot;));
			if(!$u or !$u-&gt;isPlatformAdmin()){
				$basic_fields['status']['disabled'] = true;
			}
			$sysfields = $dacura_server-&gt;getSysconfigFields($this-&gt;sform(&quot;sysconfig_form_fields&quot;));
			foreach($sysfields as $i =&gt; $sysfield){
				if(isset($basic_fields[$sysfield['id']])){
					$basic_fields[$sysfield['id']]['value'] = $sysfield['value'];
					unset($sysfields[$i]);				
				}
			}
			if($dacura_server-&gt;userHasFacet(&quot;admin&quot;) || $dacura_server-&gt;userHasFacet(&quot;inspect&quot;)){
				$params['sysconfig_fields'] = array_merge(array_values($basic_fields), $sysfields);
				if($u &amp;&amp; $u-&gt;isPlatformAdmin()){
					$params['candelete'] = true;
				}
			}
			else {
				$params['sysconfig_fields'] = $basic_fields;
			}
		}
	}
	
	/** 
	 * Loads the parameters, depending on context, that must be sent to the view logs tab
	 * @param array $params an array of parameters to be modified (added to)
	 * @param ConfigDacuraServer $dacura_server the active server object
	 * @param string $screen the html id of the screen that the tab is associated with
	 * @param Collection $col the current collection object
	 * @param DacuraUser $u the current logged in user (false if not logged in)
	 */
	function getLogTabParams(&amp;$params, ConfigDacuraServer &amp;$dacura_server, $screen, Collection $col, $u = false){
		$params['log_table_settings'] = $this-&gt;getDatatableSetting(&quot;logs&quot;);
	}
	
	/**
	 * Loads the parameters, depending on context, that must be sent to the view logs tab
	 * @param array $params an array of parameters to be modified (added to)
	 * @param ConfigDacuraServer $dacura_server the active server object
	 * @param string $screen the html id of the screen that the tab is associated with
	 * @param Collection $col the current collection object
	 * @param DacuraUser $u the current logged in user (false if not logged in)
	 */
	function getServicesTabParams(&amp;$params, ConfigDacuraServer &amp;$dacura_server, $screen, Collection $col, $u = false){
		$params['service_table_settings'] = $this-&gt;getDatatableSetting(&quot;services&quot;);
		$ss = $this-&gt;getServiceConfigFormSettings($dacura_server);
		$sf = $this-&gt;getServiceSetting(&quot;service_form_fields&quot;);
		$sf[&quot;facets&quot;]['extras'] = UserRole::$extended_dacura_roles;
		if($screen == &quot;system&quot;){
			$sf[&quot;facets&quot;]['hidden'] = true;	
			$params['selection_options'] = array(&quot;enable&quot; =&gt; &quot;Enabled&quot;, &quot;disable&quot; =&gt; &quot;Disabled&quot;);				
		}
		else {
			$params['all_roles'] = UserRole::$extended_dacura_roles;				
		}
		if(!$dacura_server-&gt;userHasFacet(&quot;manage&quot;)){
			$sx = json_decode($params['service_table_settings'], true);
			$sx[&quot;aoColumns&quot;] = array(null, null, array(&quot;bVisible&quot; =&gt; false));
			$params['service_table_settings'] = json_encode($sx);
		}
		$params['services_config'] = $dacura_server-&gt;getServicesConfig();
		$params['service_tables'] = $this-&gt;getServiceConfigTables($dacura_server, $ss, $sf);
		$params['service_config_settings'] = $ss;
	}
	
	/**
	 * Loads the parameters, depending on context, that must be sent to the create collection tab
	 * @param array $params an array of parameters to be modified (added to)
	 * @param ConfigDacuraServer $dacura_server the active server object
	 * @param string $screen the html id of the screen that the tab is associated with
	 * @param Collection $col the current collection object
	 * @param DacuraUser $u the current logged in user (false if not logged in)
	 */
	function getCreateTabParams(&amp;$params, ConfigDacuraServer &amp;$dacura_server, $screen, Collection $col, $u = false){
		$params['create_collection_fields'] = $this-&gt;getServiceSetting(&quot;create_collection_fields&quot;);
		$params['create_collection_settings'] = $this-&gt;getCreateFormSettings();
	}	
	
	/**
	 * Get the list of subscreens that should be loaded for this context (user, collection)
	 * 
	 * @param string $screen
	 * @param ConfigDacuraServer $dacura_server
	 * @return array&lt;string&gt; an array of sub-screen html ids that should be loaded for the current context
	 */
	function getSubscreens($screen, ConfigDacuraServer &amp;$dacura_server){
		$ss = array();
		if($screen == &quot;system&quot;){
			$ss = array(&quot;system-configuration&quot;, &quot;view-services&quot;, &quot;list-collections&quot;, &quot;add-collection&quot;, &quot;view-logs&quot;, &quot;view-files&quot;);				
		}
		else {
			if($dacura_server-&gt;userHasFacet(&quot;view&quot;)){
				$ss[] = &quot;collection-configuration&quot;;
				$ss[] = &quot;view-services&quot;;
			}
			if($dacura_server-&gt;userHasFacet(&quot;admin&quot;) || $dacura_server-&gt;userHasFacet(&quot;inspect&quot;)){
				$ss[] = &quot;view-logs&quot;;
			}
			if($dacura_server-&gt;userHasFacet(&quot;admin&quot;) || $dacura_server-&gt;userHasFacet(&quot;manage&quot;)){
				$ss[] = &quot;view-files&quot;;
			}		
		}
		return $ss;
	}
	
	/**
	 * Loads the messages from the collection's services' settings for showing to the user
	 * @param string $screen the screen in question
	 * @param array $params the parameter array to be filled with messages for sending to the html template
	 * @param array&lt;string&gt; $sscreens an array of strings, each being the html id of a subscreen
	 */
	function loadSubscreenMessages(&amp;$params, $screen, $sscreens){
		foreach($sscreens as $sid){
			$params[$sid.'-intro'] = $this-&gt;smsg($screen.'-'.$sid.'-intro');
		}
	}
	
	/* overridden inherited functions */
	
	/**
	 * treat all access as a view from an access control point of view to simplify roles
	 * @param string screen the name of the screen to render
	 * @param ConfigDacuraServer $dacura_server server object
	 * @return string always &quot;view&quot;
	 */
	function getMinimumFacetForAccess(&amp;$dacura_server){
		if($this-&gt;cid() == &quot;all&quot;){
			return &quot;admin&quot;;
		}
		return &quot;view&quot;;
	}
	
	/**
	 * If the context is &quot;all&quot; load platform config page
	 * Otherwise load collection config page
	 * @return string page id
	 * @see DacuraService::getScreenForCall()
	 */
	function getScreenForCall(){
		if($this-&gt;screen == &quot;view&quot;){
			return ($this-&gt;cid() == &quot;all&quot; ?  &quot;system&quot; : &quot;collection&quot;);
		}
		else {
			return &quot;service&quot;;
		}
	}
	
	/**
	 * Basic workhorse function that generates the parameters that have to be passed to the html screens
	 * @see DacuraService::getParamsForScreen()
	 */
	function getParamsForScreen($screen, ConfigDacuraServer &amp;$dacura_server){
		$u = $dacura_server-&gt;getUser();
		$col = $dacura_server-&gt;getCollection();
		$ss = $this-&gt;getSubscreens($screen, $dacura_server);
		if(in_array('collection-configuration', $ss) || in_array('system-configuration', $ss)){
			$this-&gt;getSysconfigTabParams($params, $dacura_server, $screen, $col, $u);
		}
		if(in_array('view-services', $ss)){
			$this-&gt;getServicesTabParams($params, $dacura_server, $screen, $col, $u);
		}
		if(in_array('view-logs', $ss)){
			$this-&gt;getLogTabParams($params, $dacura_server, $screen, $col, $u);				
		}
		if(in_array(&quot;add-collection&quot;, $ss)){
			$this-&gt;getCreateTabParams($params, $dacura_server, $screen, $col, $u);				
		}
		$params['messages'] = $this-&gt;loadSubscreenMessages($params, $screen, $ss);
		$params['subscreens'] = $ss;
		$params['image'] = $this-&gt;furl(&quot;images&quot;, &quot;services/config.png&quot;);
		$params['dt'] = true;
		$params[&quot;breadcrumbs&quot;] = array(array(), array());
		
		if($screen == &quot;system&quot;){
			$params['dacura_table_settings'] = $this-&gt;getDatatableSetting(&quot;collections&quot;);
			$params[&quot;title&quot;] = &quot;Dacura Platform Management&quot;;
			$params[&quot;subtitle&quot;] = &quot;Manage the configuration of the Dacura Platform and all of its hosted collections&quot;;				
			$params['subscreens'] = array(&quot;system-configuration&quot;, &quot;view-services&quot;, &quot;list-collections&quot;, &quot;add-collection&quot;, &quot;view-logs&quot;, &quot;view-files&quot;);
		}
		elseif($screen == &quot;service&quot;) {
			
		}
		else {
			$params[&quot;title&quot;] = $col-&gt;id.&quot; settings&quot;;
			$params[&quot;subtitle&quot;] = &quot;Manage the configuration of the &quot;.$col-&gt;name . &quot; collection&quot;;
		}
		return $params;
	}
}</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>