<html>
    <head>
        <script
            type="text/javascript"
            src="../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
include_once(&quot;phplib/services/ld/LdService.php&quot;);
include_once(&quot;phplib/services/ld/LdDacuraServer.php&quot;);
include_once(&quot;Candidate.php&quot;);
include_once(&quot;CandidateUpdateRequest.php&quot;);
include_once(&quot;CandidateCreateRequest.php&quot;);


class CandidateDacuraServer extends LdDacuraServer {
	

	function __construct($service){
		parent::__construct($service);
		$this-&gt;cwurlbase = $service-&gt;my_url();
		if($this-&gt;cid() != &quot;all&quot;){
			$this-&gt;schema = $this-&gt;loadSchemaFromContext();
			$this-&gt;graphbase = $this-&gt;service-&gt;get_service_url(&quot;schema&quot;);		
		}
	}
	
	function getNGSkeleton(){
		if($this-&gt;schema){
			return $this-&gt;schema-&gt;getNGSkeleton();
		}
		return $this-&gt;failure_result(&quot;Attempted to load a skeleton with no schema loaded&quot;, 400);
	}
	
	function createNewEntityObject($id, $type){
		$obj = parent::createNewEntityObject($id, $type);
		if(!$this-&gt;schema){
			return $this-&gt;failure_result(&quot;Cannot create new candidates outside of a schema&quot;, 400);
		}
		$obj-&gt;cwurl = $this-&gt;schema-&gt;instance_prefix.&quot;/&quot;.$obj-&gt;id;
		$obj-&gt;schema = $this-&gt;schema;
		return $obj;
	}
	
	function loadEntity($entity_id, $type, $cid, $fragment_id = false, $version = false, $options = array()){
		$ent = parent::loadEntity($entity_id, $type, $cid, $fragment_id, $version, $options);
		if($ent){
			$ent-&gt;cwurl = $this-&gt;schema-&gt;instance_prefix.&quot;/&quot;.$ent-&gt;id;
			$this-&gt;nsres-&gt;prefixes[$ent-&gt;id] = $ent-&gt;cwurl;
		}
		return $ent;
	}
	
	function publishEntityToGraph($nent, $is_test=false){
		$ar = new GraphAnalysisResults(&quot;Publishing to Graph&quot;);
		foreach($nent-&gt;ldprops as $k =&gt; $props){
			$quads = $nent-&gt;getPropertyAsQuads($k, $this-&gt;getInstanceGraph($k));
			if($quads){
				$gobj = $this-&gt;loadEntity($k, &quot;graph&quot;, $this-&gt;cid());
				$tests = isset($gobj-&gt;meta['instance_dqs']) ? $gobj-&gt;meta['instance_dqs'] : array();
				$errs = $this-&gt;graphman-&gt;create($quads, $this-&gt;getInstanceGraph($k), $this-&gt;getGraphSchemaGraph($k), $is_test, $tests);
				if($errs === false){
					$ar-&gt;addOneGraphTestFail($k, $quads, array(), $this-&gt;graphman-&gt;errcode, $this-&gt;graphman-&gt;errmsg);
				}
				else {
					$ar-&gt;addOneGraphTestResult($k, $quads, array(), $errs);
				}
			}			
		}
		return $ar;
	}
	
	function updateEntityInGraph($ent, $is_test = false){
		$ar = new GraphAnalysisResults(&quot;Updating Report in Graph&quot;, $is_test);
		foreach($ent-&gt;changed-&gt;ldprops as $k =&gt; $props){
			$gobj = $this-&gt;loadEntity($k, &quot;graph&quot;, $this-&gt;cid());
			if($gobj){
				$tests = $gobj-&gt;meta['instance_dqs'];
				$iquads = $ent-&gt;delta-&gt;getNamedGraphInsertQuads($k, $this-&gt;getInstanceGraph($k));
				$dquads = $ent-&gt;delta-&gt;getNamedGraphDeleteQuads($k, $this-&gt;getInstanceGraph($k));
				if(count($iquads) &gt; 0 or count($dquads) &gt; 0){
					$errs = $this-&gt;graphman-&gt;update($iquads, $dquads, $this-&gt;getInstanceGraph($k), $this-&gt;getGraphSchemaGraph($k), $is_test, $tests);
					if($errs === false){
						$ar-&gt;addOneGraphTestFail($k, $iquads, $dquads, $this-&gt;graphman-&gt;errcode, $this-&gt;graphman-&gt;errmsg);
					}
					else {
						$ar-&gt;addOneGraphTestResult($k, $iquads, $dquads, $errs);
					}
				}
			}
			else {
				$ar-&gt;addOneGraphTestFail($k, array(), array(), $this-&gt;errcode, &quot;Failed to load graph $k&quot;.$this-&gt;errmsg);
			}
		}
		return $ar;
	}
	
	function deleteEntityFromGraph($ent, $is_test = false){
		$ar = new GraphAnalysisResults(&quot;Removing Entity from Graph&quot;, $is_test);
		foreach($ent-&gt;ldprops as $k =&gt; $props){
			$quads = $ent-&gt;getPropertyAsQuads($k, $this-&gt;getInstanceGraph($k));
			if($quads){
				$errs = $this-&gt;graphman-&gt;delete($quads, $this-&gt;getInstanceGraph($k), $this-&gt;getGraphSchemaGraph($k), $is_test);
				if($errs === false){
					$ar-&gt;addOneGraphTestFail($k, array(), $quads, $this-&gt;graphman-&gt;errcode, $this-&gt;graphman-&gt;errmsg);
				}
				else {
					$ar-&gt;addOneGraphTestResult($k, array(), $quads, $errs);
				}
			}
		}
		return $ar;
	}
	
	function undoEntityUpdate($ent, $is_test = false){
		$ar = new GraphAnalysisResults(&quot;Undoing Report Update in Graph&quot;);
		foreach($ent-&gt;original-&gt;ldprops as $k =&gt; $props){
			$dquads = $ent-&gt;delta-&gt;getNamedGraphInsertQuads($k, $this-&gt;getInstanceGraph($k));
			$iquads = $ent-&gt;delta-&gt;getNamedGraphDeleteQuads($k, $this-&gt;getInstanceGraph($k));
			if(count($iquads) &gt; 0 or count($dquads) &gt; 0){
				$errs = $this-&gt;graphman-&gt;update($iquads, $dquads, $this-&gt;getInstanceGraph($k),$this-&gt;getGraphSchemaGraph($k), $is_test);
				if($errs === false){
					$ar-&gt;addOneGraphTestFail($k, $iquads, $dquads, $this-&gt;graphman-&gt;errcode, $this-&gt;graphman-&gt;errmsg);
				}
				else {
					$ar-&gt;addOneGraphTestResult($k, $iquads, $dquads, $errs);
				}
			}
		}
		return $ar;
	}
	
	function updatePublishedUpdate($cand, $ocand, $is_test = false){
		$ar = new GraphAnalysisResults(&quot;Updating Report in Graph&quot;, $is_test);
		foreach($cand-&gt;original-&gt;ldprops as $k){
			$quads = $cand-&gt;deltaAsNGQuads($ocand, $this-&gt;getInstanceGraph($k));
			if(count($quads['add']) &gt; 0 or count($quads['del']) &gt; 0){
				$errs = $this-&gt;graphman-&gt;update($quads['add'], $quads['del'], $this-&gt;getInstanceGraph($k), $this-&gt;getGraphSchemaGraph($k), $is_test);
				if($errs === false){
					$ar-&gt;addOneGraphTestFail($k, $quads['add'], $quads['del'], $this-&gt;graphman-&gt;errcode, $this-&gt;graphman-&gt;errmsg);
				}
				else {
					$ar-&gt;addOneGraphTestResult($k, $quads['add'], $quads['del'], $errs);
				}
			}
		}
		return $ar;
	}
	
	function getCandidateEntityClasses(){
		return $this-&gt;graphman-&gt;getGraphEntityClasses(&quot;seshat&quot;);
	}
	
	function getClassFrame($cls){
		$graphs = $this-&gt;getMainGraphForEntityId($entid);
		$frame = $this-&gt;graphman-&gt;getClassFrame($cls, $graphs[1]);		
	}
	
	function getEntityClassFrame($entid){
		$cls = $this-&gt;getClassFromEntity($entid);
		$frame = $this-&gt;getClassFrame($cls);
		$filled_frame = $this-&gt;fillFrame($entid, $frame);		
	}
	
	function getMainGraphForEntityId($entid){
		return array(&quot;main_instance&quot;, &quot;main_schema&quot;);
	}
	
}

</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>