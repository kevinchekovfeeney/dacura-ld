<html>
    <head>
        <script
            type="text/javascript"
            src="../../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
require_once(&quot;AnalysisResults.php&quot;);
require_once(&quot;FakeTripleStore.php&quot;);

class GraphManager extends DacuraObject {

	var $settings;
	var $tests = &quot;all&quot;;
	var $errors;
	var $warnings;
	var $fake = false;

	function __construct($settings){
		$this-&gt;settings = $settings;
	}
	
	/* 
	 * all of these are just convenience interfaces to invoke DQS...
	 */
	function getGraphEntityClasses($schema_gname){
		/*if(substr($schema_gname, -strlen(&quot;main_schema&quot;)) == &quot;main_schema&quot;){
			$classes = array(&quot;seshat:Polity&quot;, &quot;seshat:SupraculturalEntity&quot;, &quot;seshat:SubPolity&quot;, &quot;seshat:QuasiPolity&quot;, 
					&quot;seshat:InterestGroup&quot;, &quot;seshat:Language&quot;, &quot;seshat:Building&quot;, &quot;seshat:Territory&quot;, 					
					&quot;seshat:CollectionOfTerritories&quot;, &quot;seshat:FreeFormArea&quot;, &quot;seshat:NGA&quot;, &quot;seshat:Event&quot;, 
					&quot;seshat:War&quot;, &quot;seshat:Battle&quot;, &quot;seshat:NavalEngagement&quot;, &quot;seshat:LandBattle&quot;, &quot;seshat:Siege&quot;,	
			);
		}
		elseif(substr($schema_gname, -strlen(&quot;provenance_schema&quot;)) == &quot;provenance_schema&quot;){
			$classes = array(&quot;prov:Activity&quot;, &quot;prov:AgentInfluence&quot;, &quot;prov:Association&quot;, 
				&quot;prov:Attribution&quot;, &quot;prov:Bundle&quot;, &quot;prov:Collection&quot;, &quot;prov:Delegation&quot;, &quot;prov:Derivation&quot;, &quot;prov:EmptyCollection&quot;, 
				&quot;prov:End&quot;, &quot;prov:Entity&quot;, &quot;prov:EntityInfluence&quot;, &quot;prov:Generation&quot;, &quot;prov:Influence&quot;, 
				&quot;prov:InstantaneousEvent&quot;, &quot;prov:Invalidation&quot;, &quot;prov:Location&quot;, &quot;prov:Organization&quot;, &quot;prov:Person&quot;, &quot;prov:Plan&quot;, 
				&quot;prov:PrimarySource&quot;, &quot;prov:Quotation&quot;, &quot;prov:Revision&quot;, &quot;prov:Role&quot;, &quot;prov:SoftwareAgent&quot;, &quot;prov:Start&quot;, 
				&quot;prov:Usage&quot;
			);
		}
		elseif(substr($schema_gname, -strlen(&quot;annotation_schema&quot;)) == &quot;annotation_schema&quot;){
			$classes = array(&quot;oa:Annotation&quot;, &quot;oa:Choice&quot;, &quot;oa:Motivation&quot;, &quot;oa:Tag&quot;);
		}
		else {
			$classes = array();
		}*/
		$classes = $this-&gt;invokeDCS($schema_gname);
		return $classes;
	}
	
	function getClassFrame($schema_gname, $classname){
		$classes = $this-&gt;invokeDCS($schema_gname, $classname);
		return $classes;
	}
	
	function getClassAncestry($schema_gname, $classname){}
	
	function test_update($itrips, $dtrips, $gname, $schema_gname, $tests = &quot;all&quot;){
		return $this-&gt;update($itrips, $dtrips, $gname, $schema_gname, true);		
	}

	function test_create($itrips, $gname, $schema_gname, $tests = all){
		return $this-&gt;create($itrips, $gname, $schema_gname, true, $tests);
	}
	
	function create($itrips, $gname, $schema_gname, $test = false, $tests = &quot;all&quot;){
		return $this-&gt;update($itrips, array(), $gname, $schema_gname, $test, $tests);
	}
	
	function test_delete($dtrips, $gname, $schema_gname, $tests = &quot;all&quot;){
		return $this-&gt;delete($dtrips, $gname, $schema_gname, true, $tests);
	}
	
	function delete($dtrips, $gname, $schema_gname, $test = false, $tests = &quot;all&quot;){
		return $this-&gt;update(array(), $dtrips, $gname, $schema_gname, $test, $tests);
	}
	
	function update($itrips, $dtrips, $gname, $schema_gname, $test = false, $tests = &quot;all&quot;){
		if($this-&gt;fake&amp;&amp; $this-&gt;settings['dqs_service']['fakets']){
			$fakets = new FakeTripleStore($this-&gt;settings['dqs_service']['fakets']);
			return $fakets-&gt;update($itrips, $dtrips, $test);
		}
		else {
			return $this-&gt;invokeDQS(&quot;instance&quot;, $schema_gname, $gname, $itrips, $dtrips, $test, $tests);
		}
	}
		
	function updateSchema($itrips, $dtrips, $gname, $schema_gname, $test = false, $tests = &quot;all&quot;){
		if($this-&gt;fake){
			return $fakets-&gt;update($itrips, $dtrips, false);				
		}
		else {
			return $this-&gt;invokeDQS(&quot;schema&quot;, $schema_gname, $gname, $itrips, $dtrips, $test, $tests);
		}
	}

	function validateSchema($schema_gname, $itrips, $tests){
		if($this-&gt;fake &amp;&amp; $this-&gt;settings['dqs_service']['fakets']){
			$fakets = new FakeTripleStore($this-&gt;settings['dqs_service']['fakets']);
			return $fakets-&gt;update($itrips, array(), false);
		}
		else {
			return $this-&gt;invokeDQS(&quot;schema&quot;, $schema_gname, false, $itrips, false, true, $tests);
		}
	}
	
	
	function validateAll($gname, $schema_gname){
		return $this-&gt;invokeDQS(&quot;validate&quot;, $schema_gname, $gname);		
	}
	
	function invokeDCS($graphid, $clsname = false){
		$args = array(&quot;schema&quot; =&gt; $graphid);
		if($clsname){
			$srvc = $this-&gt;settings[&quot;dqs_service&quot;]['stub'];
			$args['class'] = $clsname;
		}
		else {
			$srvc = $this-&gt;settings[&quot;dqs_service&quot;]['entity'];		
		}
		$qstr = &quot;&quot;;
		foreach($args as $k =&gt; $v){
			if(strlen($qstr) &gt; 0) $qstr.= &quot;&amp;&quot;;
			//$qstr .= &quot;$k=$v&quot;;
			$qstr .= $k.&quot;=&quot;.urlencode($v);
		}
		$ch = curl_init();
		//if(isset ($this-&gt;settings['http_proxy']) &amp;&amp; $this-&gt;settings['http_proxy']){
		//	curl_setopt($ch, CURLOPT_PROXY, $this-&gt;settings['http_proxy']);
		//} TCD's proxy doesnt see the dqs
		curl_setopt($ch, CURLOPT_URL, $srvc);
		curl_setopt($ch, CURLOPT_POST, 1);
		curl_setopt($ch, CURLOPT_POSTFIELDS, $qstr);
		curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
		$content = curl_exec($ch);
		if(curl_getinfo($ch, CURLINFO_HTTP_CODE) != 200 || !$content){
			$errcode = (curl_getinfo($ch, CURLINFO_HTTP_CODE) == 200) ? 500 : curl_getinfo($ch, CURLINFO_HTTP_CODE);
			return $this-&gt;failure_result(&quot;Failed to analyse stub call failed: $content&quot;, $errcode);
		}
		$content = json_decode($content, true);
		if(is_array($content)){
			return $content;
		}
		else {
			return $this-&gt;failure_result(&quot;Dacura Quality Service returned illegal type (not an array): $content&quot;, 500);
		}
		
	}
	
	function invokeDQS($service, $schema_gname, $gname = false, $itrips = false, $dtrips = false, $test = false, $tests = &quot;all&quot;){
		$queries = array();
		$itrips = $itrips ? $itrips : array();
		$dtrips = $dtrips ? $dtrips : array();
		if($service == &quot;schema&quot; or $service == &quot;instance&quot;){
			$update_ip = json_encode(array(
					&quot;inserts&quot; 	=&gt; 	$itrips,
					&quot;deletes&quot; 	=&gt; 	$dtrips
			));
			$queries['update'] = $update_ip;
			$commit = $test ? &quot;false&quot; : &quot;true&quot;;		
			$pragma_ip = json_encode(array(
					&quot;tests&quot; 	=&gt;	$tests,
					&quot;commit&quot; 	=&gt; 	$commit,
					&quot;schema&quot; 	=&gt; 	$schema_gname,
					&quot;instance&quot; 	=&gt; 	$gname
			));
			$queries['pragma'] = $pragma_ip;
		}
		else {
			$prag = array(
					&quot;tests&quot; =&gt; $tests,
					&quot;schema&quot; =&gt; $schema_gname
			);
			if($gname != false){
				$prag['instance'] = $gname;	
			}
			$queries['pragma'] = json_encode($prag);				
		}
		$qstr = &quot;&quot;;
		foreach($queries as $k =&gt; $v){
			if(strlen($qstr) &gt; 0) $qstr.= &quot;&amp;&quot;;
			//$qstr .= &quot;$k=$v&quot;;
			$qstr .= $k.&quot;=&quot;.urlencode($v);
		}
		if($this-&gt;settings['dqs_service']['dumplast']){
			$this-&gt;dumpDQSRequest($this-&gt;settings['dqs_service']['dumplast'], $service, $tests, $schema_gname, $gname, $itrips, $dtrips, $qstr);
		}
		$ch = curl_init();
		//if(isset ($this-&gt;settings['http_proxy']) &amp;&amp; $this-&gt;settings['http_proxy']){
		//	curl_setopt($ch, CURLOPT_PROXY, $this-&gt;settings['http_proxy']);
		//} TCD's proxy doesnt see the dqs
		curl_setopt($ch, CURLOPT_URL, $this-&gt;settings[&quot;dqs_service&quot;][$service]);
		curl_setopt($ch, CURLOPT_POST, 1);
		curl_setopt($ch, CURLOPT_POSTFIELDS, $qstr);
		curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
		$content = curl_exec($ch);
		if(curl_getinfo($ch, CURLINFO_HTTP_CODE) != 200 || !$content){
			$errcode = (curl_getinfo($ch, CURLINFO_HTTP_CODE) == 200) ? 500 : curl_getinfo($ch, CURLINFO_HTTP_CODE);
			return $this-&gt;failure_result(&quot;Failed to analyse $service - service call failed: $content&quot;, $errcode);
		}
		$content = json_decode($content, true);
		if(is_array($content)){
			return $content;
		}
		else {
			return $this-&gt;failure_result(&quot;Dacura Quality Service returned illegal type (not an array): $content&quot;, 500);
		}		
	}
	
	function dumpDQSRequest($fname, $service, $tests, $schema_gname, $gname, $itrips, $dtrips, $qstr){
		$dumpstr = &quot;Service: $service\n&quot;;
		$dumpstr .= &quot;Tests: &quot;;
		if(is_array($tests)){
			$dumpstr .= implode(&quot;, &quot;, $tests).&quot;\n&quot;;
		}
		else {
			$dumpstr .= $tests.&quot;\n&quot;;
		}
		$dumpstr .= &quot;Schema: &quot;.$schema_gname.&quot; Instance: &quot;.$gname.&quot;\n&quot;;
		$dumpstr .= &quot;Triples Added:\n&quot;;
		foreach($itrips as $itrip){
			$dumpstr .= json_encode($itrip).&quot;\n&quot;;
		}
		$dumpstr .= &quot;Triples Deleted:\n&quot;;
		foreach($dtrips as $itrip){
			$dumpstr .= json_encode($itrip).&quot;\n&quot;;
		}
		$dumpstr .= &quot;Query: $qstr&quot;;
		file_put_contents($fname, $dumpstr);
	}
}
</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>