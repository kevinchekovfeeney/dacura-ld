<html>
    <head>
        <script
            type="text/javascript"
            src="../../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php

include_once(&quot;phplib/libs/easyrdf-0.9.0/lib/EasyRdf.php&quot;);
include_once(&quot;LDUtils.php&quot;);

class EntityUpdate extends DacuraObject{
	var $id;
	var $cid;
	var $type;
	var $targetid;
	var $status;
	var $created;
	var $modified;
	var $forward;
	var $backward;
	var $from_version;
	var $to_version = 0;
	var $meta; //meta data about the update itself

	var $cwurl;//closed world url of the entity being updated
	var $nsres;//name space resolver
	//complex objects - any of them can be calculated from 1.5. (original + delta.forward = changed) (changed + delta.backward = original)
	var $original; //the original state of the target candidate
	var $changed;	//the changed state of the target candidate (if the update request was to be accepted)
	var $delta; // LDDelta object describing changes from old to new

	function __construct($id = false, &amp;$original = false, $cwurl = false){
		//parent::__construct($original-&gt;id);
		$this-&gt;id = $id;
		if($original) $this-&gt;setOriginal($original);
		$this-&gt;cwurl = $cwurl;
	}

	function __clone(){
		$this-&gt;original = $this-&gt;original;
		$this-&gt;changed = $this-&gt;changed;
		$this-&gt;delta = $this-&gt;delta;
		$this-&gt;meta = $this-&gt;meta;
		$this-&gt;forward = deepArrCopy($this-&gt;forward);
		$this-&gt;backward = deepArrCopy($this-&gt;backward);
	}
	
	function setNamespaces($nsres){
		$this-&gt;nsres = $nsres;
	}
	
	function loadFromDBRow($row){
		$this-&gt;targetid = $row['targetid'];
		$this-&gt;status = $row['status'];
		$this-&gt;type = $row['type'];
		$this-&gt;cid = $row['collectionid'];
		$this-&gt;created = $row['createtime'];
		$this-&gt;modified = $row['modtime'];
		$this-&gt;from_version = $row['from_version'];
		$this-&gt;to_version = $row['to_version'];
		$this-&gt;forward = json_decode($row['forward'], true);
		$this-&gt;backward = json_decode($row['backward'], true);
		$this-&gt;meta = json_decode($row['meta'], true);
	}
	
	function getEntityType(){
		if($this-&gt;type) return $this-&gt;type;
		return strtolower(substr(get_class($this), 0, strlen(get_class($this)) - strlen(&quot;UpdateRequest&quot;)));
	}


	//compare two update requests (for analysing updates to updates)

	function compare($other = false){
		$results = array(&quot;meta&quot; =&gt; array(), &quot;add&quot; =&gt; array(), &quot;del&quot; =&gt; array());
		if(!$other){
			$results['meta']['id'] = $this-&gt;id;
			$results['meta']['type'] = $this-&gt;type;
			$results['meta']['targetid'] = $this-&gt;targetid;
			$results['meta']['status'] = $this-&gt;status;
			$results['meta']['from_version'] = $this-&gt;from_version;
			$results['meta']['to_version'] = $this-&gt;to_version;
			$results['add']['forward'] = $this-&gt;forward;
			$results['add']['backward'] = $this-&gt;backward;
		}
		else {
			if($this-&gt;id != $other-&gt;id) $results['meta']['id'] = array($this-&gt;id, $other-&gt;id);
			if($this-&gt;type != $other-&gt;type ) $results['meta']['type'] = array($this-&gt;type, $other-&gt;type);
			if($this-&gt;targetid != $other-&gt;targetid ) $results['meta']['targetid'] = array($this-&gt;targetid, $other-&gt;targetid);
			if($this-&gt;status != $other-&gt;status) $results['meta']['status'] = array($this-&gt;status, $other-&gt;status);
			if($this-&gt;from_version != $other-&gt;from_version) $results['meta']['from_version'] = array($this-&gt;from_version, $other-&gt;from_version);
			if($this-&gt;to_version != $other-&gt;to_version) $results['meta']['to_version'] = array($this-&gt;to_version, $other-&gt;to_version);
			$fdelta = compareLD($this-&gt;targetid, $this-&gt;forward, $other-&gt;forward, $this-&gt;cwurl);
			$bdelta = compareLD($this-&gt;targetid, $this-&gt;backward, $other-&gt;backward, $this-&gt;cwurl);
			$results['add']['forward'] = $fdelta-&gt;forward;
			$results['add']['backward'] = $bdelta-&gt;forward;
			$results['del']['forward'] = $fdelta-&gt;backward;
			$results['del']['backward'] = $bdelta-&gt;backward;
		}
		return $results;
	}

	function deltaAsNGQuads($other, $gname){
		$added = $this-&gt;delta-&gt;getNamedGraphInsertQuads($gname);
		$deleted = $this-&gt;delta-&gt;getNamedGraphDeleteQuads($gname);
		$oadded = $other-&gt;delta-&gt;getNamedGraphInsertQuads($gname);
		$odeleted = $other-&gt;delta-&gt;getNamedGraphDeleteQuads($gname);
		return $this-&gt;consolidateTrips($added, $deleted, $oadded, $odeleted);
	}

	function consolidateTrips($added, $deleted, $oadded, $odeleted){
		foreach($added as $i =&gt; $trip){
			foreach($oadded as $j =&gt; $otrip){
				if(compareTrips($trip, $otrip)){
					unset($added[$i]);
					unset($oadded[$j]);
					break;
				}
			}
		}
		foreach($deleted as $i =&gt; $trip){
			foreach($odeleted as $j =&gt; $otrip){
				if(compareTrips($trip, $otrip)){
					unset($deleted[$i]);
					unset($odeleted[$j]);
					break;
				}
			}
		}
		$deleted = array_merge(array_values($deleted), array_values($oadded));
		$added = array_merge(array_values($added), array_values($odeleted));
		return array(&quot;add&quot; =&gt; $added, &quot;del&quot; =&gt; $deleted);
	}

	function deltaAsTriples($other){
		$added = $this-&gt;addedCandidateTriples();
		$deleted = $this-&gt;deletedCandidateTriples();
		$oadded = $other-&gt;addedCandidateTriples();
		$odeleted = $other-&gt;deletedCandidateTriples();
		return $this-&gt;consolidateTrips($added, $deleted, $oadded, $odeleted);
	}

	function getMetaUpdates(){
		$meta = array();
		if($this-&gt;original-&gt;id != $this-&gt;changed-&gt;id) $meta['id'] = array($this-&gt;original-&gt;id, $this-&gt;changed-&gt;id);
		if($this-&gt;original-&gt;status != $this-&gt;changed-&gt;status) $meta['status'] = array($this-&gt;original-&gt;status, $this-&gt;changed-&gt;status);
		//if($this-&gt;original-&gt;type != $this-&gt;changed-&gt;type) $meta['type'] = array($this-&gt;original-&gt;type, $this-&gt;changed-&gt;type);
		if($this-&gt;original-&gt;cid != $this-&gt;changed-&gt;cid) $meta['cid'] = array($this-&gt;original-&gt;cid, $this-&gt;changed-&gt;cid);
		return $meta;
	}

	function published(){
		return $this-&gt;get_status() == &quot;accept&quot;;
	}

	function originalPublished(){
		if(!$this-&gt;original) return false;
		return $this-&gt;original-&gt;get_status() == &quot;accept&quot;;
	}

	function changedPublished(){
		if(!$this-&gt;changed) return false;
		return $this-&gt;changed-&gt;get_status() == &quot;accept&quot;;
	}

	function bothPublished(){
		return $this-&gt;changedPublished() &amp;&amp; $this-&gt;originalPublished();
	}

	function setOriginal(&amp;$original){
		$this-&gt;original = $original;
		if(!(isset($this-&gt;targetid) and $this-&gt;targetid)){
			$this-&gt;targetid = $original-&gt;id;
		}
		if(!(isset($this-&gt;cwurl) and $this-&gt;cwurl)){
			$this-&gt;cwurl = $original-&gt;cwurl;
		}
		if(!(isset($this-&gt;nsres) and $this-&gt;nsres)){
			$this-&gt;nsres = $original-&gt;nsres;
		}
		$this-&gt;from_version = $this-&gt;original-&gt;version();
	}

	//whether the forward and backward fields of the object have been loaded
	function FBLoaded(){
		return isset($this-&gt;forward) &amp;&amp; is_array($this-&gt;forward) &amp;&amp; isset($this-&gt;backward) &amp;&amp; is_array($this-&gt;backward);
	}

	function FBChanges(){
		return $this-&gt;FBLoaded() &amp;&amp; (count($this-&gt;forward) &gt; 0 &amp;&amp; count($this-&gt;backward) &gt; 0);
	}

	function initFromOriginal(){
		$this-&gt;created = time();
		$this-&gt;modified = time();
		$this-&gt;from_version = $this-&gt;original-&gt;version();
		$this-&gt;cid = $this-&gt;original-&gt;cid;
	}

	/*
	 * Called by the state management system when update records are pulled from the DB
	 */
	function calculate($stored = false, $load_all = true, $validate_delta = true){
		$this-&gt;expandNS();
		if($stored){
			$this-&gt;changed = $stored;
			return (!$load_all or $this-&gt;calculateDelta($validate_delta));
		}
		return (!$load_all or $this-&gt;calculateChanged(array(&quot;force_inserts&quot; =&gt; true, &quot;calculate_delta&quot; =&gt; true)));
	}

	/*
	 * Checks for illegal structures in the update command
	 */
	function validateCommand($obj, $in_embedded = false){
		foreach($obj as $p =&gt; $v){
			//opr($v);
			$pv = new LDPropertyValue($v, $this-&gt;cwurl);
			if($pv-&gt;illegal()) return $this-&gt;failure_result(&quot;Update failed validation: &quot;.$pv-&gt;errmsg, $pv-&gt;errcode);
			if($pv-&gt;embeddedlist()){
				$cwlinks = $pv-&gt;getupdates();
				if(count($cwlinks) &gt; 0 &amp;&amp; $in_embedded){
					return $this-&gt;failure_result(&quot;New embedded objects cannot have properties that update anything but themselves: $p &quot;.&quot; closed world links &quot;.$cwlinks[0], 400);
				}
				foreach($v as $id =&gt; $emb){
					if(!$this-&gt;validateCommand($emb, $in_embedded)){
						return false;
					}
				}
			}
			elseif($pv-&gt;embedded()){
				if(count($v) == 1 &amp;&amp; isset($v['@id'])){
					return $this-&gt;failure_result(&quot;Embedded objects cannot have @id as their only property ($p).&quot;, 400);
				}
				if(!$this-&gt;validateCommand($v, true)){
					return false;
				}
			}
			elseif($pv-&gt;objectlist()){
				foreach($v as $emb){
					if(count($emb) == 1 &amp;&amp; isset($emb['@id'])){
						return $this-&gt;failure_result(&quot;Embedded objects cannot have @id as their only property ($p).&quot;, 400);
					}
					if(!$this-&gt;validateCommand($emb, true)){
						return false;
					}
				}
			}
		}
		return true;
	}

	function calculateChanged($opts = array()){
		//options
		$backward = (isset($opts['direction']) &amp;&amp; $opts['direction'] == &quot;backward&quot;) ? true : false;
		$demand_id_allowed = isset($opts['demand_id_allowed']) &amp;&amp; $opts['demand_id_allowed'];
		$force_inserts = isset($opts['force_inserts']) &amp;&amp; $opts['force_inserts'];
		$calc_delta = isset($opts['calculate_delta']) &amp;&amp; $opts['calculate_delta'];
		$val_delta = isset($opts['validate_delta']) &amp;&amp; $opts['validate_delta'];

		$this-&gt;changed = clone $this-&gt;original;
		$this-&gt;changed-&gt;version = $this-&gt;to_version ? $this-&gt;to_version : 1 + $this-&gt;changed-&gt;latest_version;
		if($this-&gt;changed-&gt;version &gt; $this-&gt;changed-&gt;latest_version){
			$this-&gt;changed-&gt;latest_version = $this-&gt;changed-&gt;version;
		}
		$contents = ($backward) ? $this-&gt;backward : $this-&gt;forward;
		if(!$this-&gt;changed-&gt;update($contents, $force_inserts, $demand_id_allowed) &amp;&amp; $this-&gt;changed-&gt;compliant()){
			return $this-&gt;failure_result($this-&gt;changed-&gt;errmsg, $this-&gt;changed-&gt;errcode);
		}
		$this-&gt;changed-&gt;readStateFromMeta();
		if($calc_delta){
			return $this-&gt;calculateDelta($val_delta);
		}
		return true;
	}

	function getUpdateOptions(){
		$opts = array(
			&quot;demand_id_allowed&quot; =&gt; true,
			&quot;force_inserts&quot; =&gt; true,
			'calculate_delta' =&gt; true,
			'validate_delta' =&gt; false,				
		);
		return $opts;
	}
	
	function updateImportedProps($contents){
		$this-&gt;changed-&gt;ldprops = array($this-&gt;original-&gt;id =&gt; $contents);		
	}
	
	function calculateImported($meta, $contents){
		$this-&gt;changed = clone $this-&gt;original;
		$this-&gt;changed-&gt;version = $this-&gt;to_version ? $this-&gt;to_version : 1 + $this-&gt;changed-&gt;latest_version;
		if($this-&gt;changed-&gt;version &gt; $this-&gt;changed-&gt;latest_version){
			$this-&gt;changed-&gt;latest_version = $this-&gt;changed-&gt;version;
		}
		$this-&gt;updateImportedProps($contents);
		if($meta){
			if(!$this-&gt;changed-&gt;update(array(&quot;meta&quot; =&gt; $meta), true, true)){
				return $this-&gt;failure_result($this-&gt;changed-&gt;errmsg, $this-&gt;changed-&gt;errcode);
			}				
		}
		$this-&gt;changed-&gt;readStateFromMeta();
		return $this-&gt;calculateDelta();
	}	
	
	/*
	 * Called when a candidate update request is sent to the API
	 * $obj is a LD property structure
	 */
	function loadFromAPI($cnt, $meta, $format, $opts = false){
		if($opts == false) $opts = $this-&gt;getUpdateOptions();
		$this-&gt;initFromOriginal();
		$cmd = array();
		if($format == &quot;json&quot;){ //native format
			$cmd = $cnt;
			if($meta){
				$cmd['meta'] = $meta;
			}
			$this-&gt;forward = $cmd;
			$this-&gt;expandNS();
			$opts = $this-&gt;getUpdateOptions();
			if(!$this-&gt;calculateChanged($opts)){
				return false;
			}
		}
		else {
			$imported = $this-&gt;import($format, $cnt);
			if(!$this-&gt;calculateImported($meta, $imported)){
				return false;
			}
		}
		return true;
	}
	
	function import($format, $txt){
		$graph = new EasyRdf_Graph($this-&gt;original-&gt;id, $txt, $format, $this-&gt;original-&gt;id);
		$op = $graph-&gt;serialise(&quot;php&quot;);
		$ld = importEasyRDFPHP($op);
		return $ld;
	}

	function calculateDelta($validate = false){
		$this-&gt;delta = $this-&gt;original-&gt;compare($this-&gt;changed);
		if($validate &amp;&amp; $this-&gt;FBLoaded()){
			$fdelta = compareLD($this-&gt;targetid, $this-&gt;delta-&gt;forward, $this-&gt;forward, $this-&gt;cwurl);
			if($fdelta-&gt;containsChanges()){
				//opr($fdelta);
				//opr($this);
				return $this-&gt;failure_result(&quot;Update $this-&gt;id to $this-&gt;targetid: Mismatch between calculated changes and stored forward transition.&quot;, 400);
			}
			$bdelta = compareLD($this-&gt;targetid, $this-&gt;delta-&gt;backward, $this-&gt;backward, $this-&gt;cwurl);
			if($bdelta-&gt;containsChanges()){
				return $this-&gt;failure_result(&quot;Update $this-&gt;id to $this-&gt;targetid: Mismatch between calculated changes and stored backward transitions&quot;, 400);
			}
		}
		$this-&gt;forward = $this-&gt;delta-&gt;forward;
		$this-&gt;backward = $this-&gt;delta-&gt;backward;
		return true;
	}

	function compressNS(){
		compressNamespaces($this-&gt;forward, $this-&gt;nsres, $this-&gt;cwurl);
		compressNamespaces($this-&gt;backward, $this-&gt;nsres, $this-&gt;cwurl);
		if($this-&gt;delta){
			$this-&gt;delta-&gt;compressNS($this-&gt;nsres);
		}
		$this-&gt;original &amp;&amp; $this-&gt;original-&gt;compressNS();
		$this-&gt;changed &amp;&amp; $this-&gt;changed-&gt;compressNS();
	}

	function expandNS(){
		expandNamespaces($this-&gt;forward, $this-&gt;nsres, $this-&gt;cwurl);
		expandNamespaces($this-&gt;backward, $this-&gt;nsres, $this-&gt;cwurl);
		if($this-&gt;delta){
			$this-&gt;delta-&gt;expandNS($this-&gt;nsres);
		}
		$this-&gt;original &amp;&amp; $this-&gt;original-&gt;expandNS();
		$this-&gt;changed &amp;&amp; $this-&gt;changed-&gt;expandNS();
	}

	function get_status(){
		return $this-&gt;status;
	}

	/**
	 * Does the update request come from a context that has authority for the candidate?
	 * @param string $ocid - candidate collection id
	 * @return boolean
	 */
	function isLegalContext($cid){
		if($cid == &quot;all&quot; or ($this-&gt;original-&gt;cid != &quot;all&quot; &amp;&amp; $this-&gt;original-&gt;cid == $cid)){
			return true;
		}
		return false;
	}

	function getChangeViewHTML(){
		return $this-&gt;showChanges($this-&gt;changed-&gt;ldprops, $this-&gt;backward);
	}

	function showChanges($props, $dprops){
		$cprops = array();
		foreach($props as $prop =&gt; $v){
			$pv = new LDPropertyValue($v, $this-&gt;cwurl);
			if($pv-&gt;illegal()){
				return $this-&gt;failure_result($pv-&gt;errmsg, $pv-&gt;errcode);
			}
			if(!isset($dprops[$prop])){
				$xprop = $this-&gt;applyLinkHTML($prop, &quot;unchanged&quot;, true);
				$cprops[$xprop] = $this-&gt;getUnchangedJSONHTML($v, $pv);
				//ignore.
			}
			else {
				$nv = $dprops[$prop];
				$dpv = new LDPropertyValue($nv, $this-&gt;cwurl);
				if($dpv-&gt;isempty()){
					$xprop = $this-&gt;applyLinkHTML($prop, &quot;added&quot;, true);
					$cprops[$xprop] = $this-&gt;getAddedJSONHTML($v, $pv);
				}
				if(!$pv-&gt;sameLDType($dpv)){
					$xprop = $this-&gt;applyLinkHTML($prop, &quot;structural&quot;, true);
					$cprops[$xprop] = $this-&gt;getAddedTypeJSONHTML($v, $pv);
					$cprops[$xprop] = array_merge($cprops[$xprop], $this-&gt;getDeletedTypeJSONHTML($nv, $dpv));
				}
				else {
					switch($pv-&gt;ldtype(true)){
						case 'scalar':
							if($v != $nv){
								$xprop = $this-&gt;applyLinkHTML($prop, &quot;updated&quot;, true);
								$cprops[$xprop] = $this-&gt;getValueChangeHTML($v, $nv);
							}
							else {
								$xprop = $this-&gt;applyLinkHTML($prop, &quot;unchanged&quot;, true);
								$cprops[$xprop] = $this-&gt;applyLiteralHTML($v, &quot;unchanged&quot;);
							}
							break;
						case 'valuelist':
							$changed = false;
							$entries = array();
							foreach($v as $i =&gt; $val){
								if(in_array($val, $nv)){
									$entries[] = $this-&gt;applyLiteralHTML($val, &quot;unchanged&quot;);
								}
								else {
									$changed = true;
									$entries[] = $this-&gt;applyLiteralHTML($val, &quot;added&quot;);
								}
							}
							foreach($nv as $j =&gt; $val2){
								if(!in_array($val2, $v)){
									$changed = true;
									$entries[] = $this-&gt;applyLiteralHTML($val2, &quot;deleted&quot;);
								}
							}
							if($changed){
								$xprop = $this-&gt;applyLinkHTML($prop, &quot;changed&quot;, true);
							}
							else {
								$xprop = $this-&gt;applyLinkHTML($prop, &quot;unchanged&quot;, true);
							}
							$cprops[$xprop] = $entries;
							break;
						case 'embeddedobjectlist':
							$xprop = $this-&gt;applyLinkHTML($prop, &quot;unchanged&quot;, true);
							$cprops[$xprop] = array();
							foreach($v as $id =&gt; $obj){
								if(!isset($nv[$id])){
									$tprop = $this-&gt;applyLinkHTML($id, &quot;unchanged&quot;);
									$cprops[$xprop][$tprop] = $this-&gt;getUnchangedJSONHTML($v, $pv);
								}
								else {
									$tprop = $this-&gt;applyLinkHTML($id, &quot;unchanged&quot;);
									$cprops[$xprop][$tprop]= $this-&gt;showChanges($obj, $nv[$id]);
								}
							}
							foreach($nv as $nid =&gt; $nobj){
								if(!isset($v[$nid])){
									$tprop = $this-&gt;applyLinkHTML($nid, &quot;deleted&quot;);
									$cprops[$xprop][$tprop] = $this-&gt;getDeletedJSONHTML($v, $pv);
								}
							}
							break;
					}
				}
			}
		}
		foreach($dprops as $dprop =&gt; $dv){
			$dpv = new LDPropertyValue($dv, $this-&gt;cwurl);
			if(!isset($props[$dprop])){
				$xprop = $this-&gt;applyLinkHTML($dprop, &quot;deleted&quot;);
				$cprops[$xprop] = $this-&gt;getDeletedJSONHTML($v, $pv);
			}
		}
		return $cprops;
	}

	function getValueChangeHTML($v, $nv){
		return array($this-&gt;applyLiteralHTML($v, &quot;updated added&quot;), $this-&gt;applyLiteralHTML($nv, &quot;updated deleted&quot;));
	}

	function getDeletedTypeJSONHTML($v, $pv){
		return $this-&gt;getJSONHTML($v, &quot;deleted structural&quot;, $pv);
	}

	function getAddedTypeJSONHTML($v, $pv){
		return $this-&gt;getJSONHTML($v, &quot;added structural&quot;, $pv);
	}

	function getAddedJSONHTML($v, $pv){
		return $this-&gt;getJSONHTML($v, &quot;added&quot;, $pv);
	}

	function getDeletedJSONHTML($v, $pv){
		return $this-&gt;getJSONHTML($v, &quot;deleted&quot;, $pv);
	}

	function getUnchangedJSONHTML($v, $pv){
		return $this-&gt;getJSONHTML($v, &quot;unchanged&quot;, $pv);
	}

	function getJSONHTML($v, $t, $pv){
		$nv = array();
		if($pv-&gt;literal() or $pv-&gt;objectliteral()){
			$nv = $this-&gt;applyLiteralHTML($v, $t);
		}
		elseif($pv-&gt;link()){
			$nv = $this-&gt;applyLinkHTML($v, $t);
		}
		elseif($pv-&gt;objectliterallist()){
			$nv = array();
			foreach($v as $val){
				$nv[] = $this-&gt;applyLiteralHTML($val, $t);
			}
		}
		elseif($pv-&gt;valuelist()){
			$nv = array();
			foreach($v as $val){
				if(isURL($val) || isNamespacedURL($val)){
					$nv[] = $this-&gt;applyLinkHTML($val, $t);
				}
				else {
					$nv[] = $this-&gt;applyLiteralHTML($val, $t);
				}
			}
		}
		elseif($pv-&gt;embeddedlist()){
			$nv = array();
			foreach($v as $id =&gt; $obj){
				$nid = $this-&gt;applyLinkHTML($id, $t);
				$nv[$nid] = array();
				foreach($obj as $p2 =&gt; $val2){
					$pv2 = new LDPropertyValue($val2, $this-&gt;cwurl);
					$np2 = $this-&gt;applyLinkHTML($p2, $t, true);
					$nv[$nid][$np2] = $this-&gt;getJSONHTML($val2, $t, $pv2);
				}
			}
		}
		return $nv;
	}

	function applyLinkHTML($ln, $t, $is_prop = false){
		if($is_prop){
			$cls = &quot;dacura-property $t&quot;;
		}
		else {
			$cls = &quot;dacura-property-value $t&quot;;
		}
		if(isURL($ln)){
			if($this-&gt;original-&gt;isDocumentLocalLink($ln)){
				$cls .= &quot; document_local_link&quot;;
				$lh = &quot;&lt;a class='$cls' href='$ln&quot;.$vstr.&quot;'&gt;$ln&lt;/a&gt;&quot;;
			}
			else {
				$lh = &quot;&lt;a class='$cls' href='$ln'&gt;$ln&lt;/a&gt;&quot;;
			}
		}
		elseif(isNamespacedURL($ln)){
			if($this-&gt;original-&gt;isDocumentLocalLink($ln)){
				$cls .= &quot; document_local_link&quot;;
				$expanded = $this-&gt;nsres-&gt;expand($ln);
				if(!$expanded){
					$lh = &quot;&lt;span class='$cls unknown-namespace' title='warning: unknown namespace'&gt;$ln&lt;/span&gt;&quot;;
				}
				else {
					$lh = &quot;&lt;a class='$cls' href='$expanded&quot;.$vstr.&quot;'&gt;$ln&lt;/a&gt;&quot;;
				}
			}
			else {
				$expanded = $this-&gt;nsres-&gt;expand($ln);
				if(!$expanded){
					$lh = &quot;&lt;span class='$cls unknown-namespace'&gt;$ln&lt;/span&gt;&quot;;
				}
				else {
					$lh = &quot;&lt;a class='$cls' href='$expanded'&gt;$ln&lt;/a&gt;&quot;;
				}
			}
		}
		else {
			$lh = &quot;&lt;span class='$cls not-a-url'&gt;$ln&lt;/span&gt;&quot;;
		}
		return $lh;
	}

	function applyLiteralHTML($ln, $tp){
		return &quot;&lt;span class='dacura-property-value $tp dacura-literal'&gt;$ln&lt;/span&gt;&quot;;
	}


	function deletedCandidateTriples(){
		$ndelta = compareLD($this-&gt;targetid, $this-&gt;original-&gt;ldprops, $this-&gt;changed-&gt;ldprops, $this-&gt;cwurl);
		return $ndelta-&gt;candidateDeletes(array($this-&gt;changed, &quot;showTriples&quot;));
	}

	function addedCandidateTriples(){
		$ndelta = compareLD($this-&gt;targetid, $this-&gt;original-&gt;ldprops, $this-&gt;changed-&gt;ldprops, $this-&gt;cwurl);
		return $ndelta-&gt;candidateInserts(array($this-&gt;changed, &quot;showTriples&quot;));
	}

	function sameAs($other){
		if($this-&gt;from_version != $other-&gt;from_version){
			return false;
		}
		if($this-&gt;status != $other-&gt;status){
			return false;
		}
		return json_encode($this-&gt;forward) == json_encode($other-&gt;forward);
	}

	function nodelta(){
		return !$this-&gt;delta or !$this-&gt;delta-&gt;containsChanges();
	}

	/*
	 * DB serialisation
	 */
	function from_version(){
		return $this-&gt;from_version;
	}

	function to_version(){
		return $this-&gt;to_version;
	}

	function get_forward_json(){
		$cmd = $this-&gt;forward ? $this-&gt;forward : $this-&gt;delta-&gt;forward;
		$x = json_encode($cmd);
		return ($x) ? $x : &quot;{}&quot;;
	}

	function get_backward_json(){
		$cmd = $this-&gt;backward ? $this-&gt;backward : $this-&gt;delta-&gt;backward;
		$x = json_encode($cmd);
		return ($x) ? $x : &quot;{}&quot;;
	}

	function get_meta_json(){
		return $this-&gt;meta ? json_encode($this-&gt;meta): &quot;{}&quot;;
	}

	function reportString(){
		return $this-&gt;delta ? $this-&gt;delta-&gt;reportString() : &quot;No delta calculated - nothing to report&quot;;
	}

	function set_status($v, $is_latest = false){
		$this-&gt;status = $v;
	}

	function showUpdateResult($format, $dacura_server) {
		if($dacura_server-&gt;isNativeFormat($format)){
			if($format == &quot;html&quot;){
				$this-&gt;displayHTML($dacura_server);
			}
			elseif($format == &quot;triples&quot;){
				$this-&gt;displayTriples($dacura_server);
			}
			elseif($format == &quot;quads&quot;){
				$this-&gt;displayQuads($dacura_server);
			}
			else{
				$this-&gt;displayJSON($dacura_server);
			}
		}
		else {
			$this-&gt;displayExport($format, $dacura_server);
		}
		return $this-&gt;getDisplayFormat();
	}

	function displayExport($format, $srvr){
		$vstr = &quot;?format=&quot;.$format;
		$flags = array(&quot;ns&quot;, &quot;links&quot;, &quot;problems&quot;, &quot;typed&quot;);
		$this-&gt;changed-&gt;displayExport($format, $flags, $vstr, $srvr);
		$this-&gt;original-&gt;displayExport($format, $flags, $vstr, $srvr);
		//$temp = new LDDocument($this-&gt;id);
		//$temp-&gt;load($this-&gt;forward);
		//$exported = $temp-&gt;export($format, $this-&gt;nsres);
		//if($exported){
		//	if($format != &quot;svg&quot; &amp;&amp; $format != &quot;dot&quot; &amp;&amp; $format != &quot;png&quot; &amp;&amp; $format != &quot;gif&quot;){
		//		$this-&gt;display = htmlspecialchars($exported);
		//	}
		//	else {
		//		if($format == &quot;png&quot; or $format == &quot;gif&quot;){
		//			$this-&gt;display = '&lt;img src=&quot;data:image/png;base64,'.base64_encode ( $exported).'&quot;/&gt;';
			//	}
				//else {
				//	$this-&gt;display = $exported;
				//}
			//}
		//}
		//else {
		//	$this-&gt;display = $this-&gt;getChangeViewHTML();
		//}
	}

	function displayJSON($srvr){
		$vstr = &quot;?format=json&quot;;
		$this-&gt;changed-&gt;display = $this-&gt;changed-&gt;ldprops;
		$this-&gt;original-&gt;display = $this-&gt;original-&gt;ldprops;
		$this-&gt;display = $this-&gt;forward;
	}

	function displayHTML($srvr){
		$vstr = &quot;?format=html&quot;;
		$flags = array(&quot;ns&quot;, &quot;links&quot;);
		$this-&gt;changed-&gt;displayHTML($flags, $vstr, $srvr);
		$this-&gt;original-&gt;displayHTML($flags, $vstr, $srvr);
		$this-&gt;display = $this-&gt;getChangeViewHTML();
	}

	function displayTriples($srvr){
		$vstr = &quot;?format=triples&quot;;
		$flags = array(&quot;ns&quot;, &quot;links&quot;);
		$this-&gt;changed-&gt;displayTriples($flags, $vstr, $srvr);
		$this-&gt;original-&gt;displayTriples($flags, $vstr, $srvr);
		$this-&gt;display = $this-&gt;deltaAsTriples($orig_upd);
	}

	function displayQuads($srvr){
		$vstr = &quot;?format=quads&quot;;
		$flags = array(&quot;ns&quot;, &quot;links&quot;);
		$this-&gt;changed-&gt;displayQuads($flags, $vstr, $srvr);
		$this-&gt;original-&gt;displayQuads($flags, $vstr, $srvr);
		$this-&gt;display = $this-&gt;deltaAsTriples();
	}

	function getDisplayFormat(){
		//$result = $this-&gt;changed;
		//$result-&gt;original = $this-&gt;original;
		$other = clone $this;
		unset($other-&gt;nsres);
		return $other;
	}

	function getDQSTests($type = false){
		$itests = array();
		if(isset($this-&gt;changed-&gt;meta['instance_dqs'])){
			$itests = $this-&gt;changed-&gt;meta['instance_dqs'];
			if($type == &quot;instance&quot;){
				return $itests;
			}
		}
		if(isset($this-&gt;changed-&gt;meta['schema_dqs'])){
			$stests = $this-&gt;changed-&gt;meta['schema_dqs'];
			if($type == &quot;schema&quot;){
				return $stests;
			}
			return array_merge($stests, $itests);
		}
		return false;
	}
}

</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>