<html>
    <head>
        <script
            type="text/javascript"
            src="../../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php

class LDDelta extends DacuraObject {
	var $make_updates_adds_rems = true;
	var $cwurl;
	var $gname;//the graphname that the triples belong to
	//variables below hold state describing the change
	var $forward = array(); //Candidate Update Request Expression in LD format
	var $backward = array(); //Candidate Update Request Undo Expression in LD format
	var $triples_added = array();
	var $triples_removed = array();
	var $triples_updated = array();
	var $triples_overwritten = array();//cancelled out by a remove and an add. state retained fyi
	var $type_changes = array();
	var $bad_links = array();
	
	function __construct($cwurl, $gname = false){
		$this-&gt;cwurl = $cwurl;
		$this-&gt;gname = $gname;
		if($gname){
			$this-&gt;triples_added[$gname] = array();
			$this-&gt;triples_removed[$gname] = array();
			$this-&gt;triples_updated[$gname] = array();
			$this-&gt;triples_overwritten[$gname] = array();
		}
	}
		
	function expandNS($schema){
		expandNamespaces($this-&gt;forward, $schema, $this-&gt;cwurl);
		expandNamespaces($this-&gt;backward, $schema, $this-&gt;cwurl);
		expandNSTriples($this-&gt;triples_added, $schema, $this-&gt;cwurl, true);
		expandNSTriples($this-&gt;triples_removed, $schema, $this-&gt;cwurl, true);
		expandNSTriples($this-&gt;triples_updated, $schema, $this-&gt;cwurl, true);
		expandNSTriples($this-&gt;triples_overwritten, $schema, $this-&gt;cwurl, true);
	}
	
	function compressNS($schema){
		compressNamespaces($this-&gt;forward, $schema, $this-&gt;cwurl);
		compressNamespaces($this-&gt;backward, $schema, $this-&gt;cwurl);
		compressNSTriples($this-&gt;triples_added, $schema, $this-&gt;cwurl, true);
		compressNSTriples($this-&gt;triples_removed, $schema, $this-&gt;cwurl, true);
		compressNSTriples($this-&gt;triples_updated, $schema, $this-&gt;cwurl, true);
		compressNSTriples($this-&gt;triples_overwritten, $schema, $this-&gt;cwurl, true);
	}
	
	function getDisplayFormat(){
		$other = clone($this);
		unset($other-&gt;make_updates_adds_rems);
		return $other;
	}
	
	function reportString(){
		if($this-&gt;containsChanges()){
			return count($this-&gt;triples_added). &quot; added, &quot;.count($this-&gt;triples_removed).&quot; removed, &quot;.count($this-&gt;triples_updated);
		}
		return &quot;No changes&quot;;
	}
	
	function add($frag_id, $p, $v, $add_top_level_triples = true){
		$this-&gt;forward[$p] = $v;
		$this-&gt;backward[$p] = array();
		$trips = getValueAsTypedTriples($frag_id, $p, $v, $this-&gt;cwurl);
		if(!$add_top_level_triples ){
			foreach($trips as $i =&gt; $trip){
				if($trip[0] == $frag_id){
					unset($trips[$i]);
				}
			}
			$trips = array_values($trips);//rebuild index 	
		}
		if($this-&gt;gname){
			$this-&gt;triples_added[$this-&gt;gname] = array_merge($this-&gt;triples_added[$this-&gt;gname], $trips);				
		}
		else {
			$this-&gt;triples_added = array_merge($this-&gt;triples_added, $trips);				
		}
	}

	function del($frag_id, $p, $v, $del_top_level_triples = true){
		$this-&gt;backward[$p] = $v;
		$this-&gt;forward[$p] = array();
		$trips = getValueAsTypedTriples($frag_id, $p, $v, $this-&gt;cwurl);
		if(!$del_top_level_triples ){
			foreach($trips as $i =&gt; $trip){
				if($trip[0] == $frag_id){
					unset($trips[$i]);
				}
			}
			$trips = array_values($trips);//rebuild index
		}
		$this-&gt;removeTriples($trips);
	}
	
	function addObject($frag_id, $p, $id, $obj, $ignore_root = false){
		if(!isset($this-&gt;forward[$p])){
			$this-&gt;forward[$p] = array();
			$this-&gt;backward[$p] = array();
		}
		$this-&gt;forward[$p][$id] = $obj;
		$this-&gt;backward[$p][$id] = array();
		$trips = $ignore_root ? array() : array(array($frag_id, $p, $id));
		$trips = array_merge($trips, getObjectAsTypedTriples($id, $obj, $this-&gt;cwurl));
		$this-&gt;addTriples($trips);
	}
	
	function delObject($frag_id, $p, $id, $obj, $ignore_root = false){
		if(!isset($this-&gt;forward[$p])){
			$this-&gt;forward[$p] = array();
			$this-&gt;backward[$p] = array();
		}
		$this-&gt;backward[$p][$id] = $obj;
		$this-&gt;forward[$p][$id] = array();
		$trips = $ignore_root ? array() : array(array($frag_id, $p, $id));
		$trips = array_merge($trips, getObjectAsTypedTriples($id, $obj, $this-&gt;cwurl));
		$this-&gt;removeTriples($trips);
	}
	
	function removeOverwrites(){
		if($this-&gt;gname){
			$this-&gt;triples_overwritten[$this-&gt;gname] = array_merge($this-&gt;triples_overwritten[$this-&gt;gname], removeOverwrites($this-&gt;triples_added[$this-&gt;gname], $this-&gt;triples_removed[$this-&gt;gname]));				
		}
		else {
			$this-&gt;triples_overwritten = array_merge($this-&gt;triples_overwritten, removeOverwrites($this-&gt;triples_added, $this-&gt;triples_removed));				
		}
	}

	function addTypeChange($frag_id, $p, $v, $t, $v2, $t2){
		$this-&gt;forward[$frag_id] = array($p =&gt; $v2);
		$this-&gt;backward[$frag_id] = array($p =&gt; $v);
		$del = $t-&gt;isempty() ? array() : getValueAsTypedTriples($frag_id, $p, $v, $this-&gt;cwurl);
		$add = $t2-&gt;isempty() ? array(): getValueAsTriples($frag_id, $p, $v2, $this-&gt;cwurl);
		if(count($del) &gt; 0 &amp;&amp; count($add) &gt; 0){
			$rem = removeOverwrites($del, $add);
		}
		else $rem = array();
		if(count($add) &gt; 0) {
			$this-&gt;addTriples($add);
		}
		if(count($del) &gt; 0){
			$this-&gt;removeTriples($del);
		}
		if(count($rem) &gt; 0){
			if($this-&gt;gname){
				$this-&gt;triples_overwritten[$this-&gt;gname] = array_merge($this-&gt;triples_overwritten[$this-&gt;gname], $rem);
			}
			else {
				$this-&gt;triples_overwritten = array_merge($this-&gt;triples_overwritten, $rem);
			}
		}
		$this-&gt;type_changes[] = array(
				&quot;subject&quot; =&gt; $frag_id, 
				&quot;predicate&quot; =&gt; $p, 
				&quot;from&quot; =&gt; $t-&gt;ldtype(), 
				&quot;to&quot; =&gt; $t2-&gt;ldtype(), 
				&quot;del&quot; =&gt; $del, 
				&quot;add&quot; =&gt; $add, 
				&quot;rem&quot; =&gt; $rem
		);				
	}
	
	function containsChanges(){
		return count($this-&gt;forward) &gt; 0 or count($this-&gt;backward) &gt; 0;
	}
		
	function addSubDelta($frag_id, $p, $id, $sub, $t = false){
		if($sub-&gt;containsChanges()){
			if(!isset($this-&gt;forward[$p])){
				$this-&gt;forward[$p] = array();
				$this-&gt;backward[$p] = array();
			}
			$this-&gt;forward[$p][$id] = $sub-&gt;forward;
			$this-&gt;backward[$p][$id] = $sub-&gt;backward;
			$this-&gt;addTriples($sub-&gt;triples_added);
			$this-&gt;removeTriples($sub-&gt;triples_removed);
			if($this-&gt;gname){
				$this-&gt;triples_updated[$this-&gt;gname] = array_merge($this-&gt;triples_updated[$this-&gt;gname], $sub-&gt;triples_updated);
				$this-&gt;triples_overwritten[$this-&gt;gname] = array_merge($this-&gt;triples_overwritten[$this-&gt;gname], $sub-&gt;triples_overwritten);		
			}
			else {
				$this-&gt;triples_updated = array_merge($this-&gt;triples_updated, $sub-&gt;triples_updated);
				$this-&gt;triples_overwritten = array_merge($this-&gt;triples_overwritten, $sub-&gt;triples_overwritten);
			}
			$this-&gt;type_changes = array_merge($this-&gt;type_changes, $sub-&gt;type_changes);
			$this-&gt;bad_links = array_merge($this-&gt;bad_links, $sub-&gt;bad_links);
		}
	}
	
	function addNamedGraphDelta($other, $sub = false){
		if($sub){
			$this-&gt;forward[$sub] = $other-&gt;forward;	
			$this-&gt;backward[$sub] = $other-&gt;backward;	
		}
		else {
			$this-&gt;forward = array_merge($this-&gt;forward, $other-&gt;forward);
			$this-&gt;backward = array_merge($this-&gt;backward, $other-&gt;backward);
		}
		$this-&gt;triples_added = array_merge($this-&gt;triples_added, $other-&gt;triples_added);
		$this-&gt;triples_removed = array_merge($this-&gt;triples_removed, $other-&gt;triples_removed);
		$this-&gt;triples_updated = array_merge($this-&gt;triples_updated, $other-&gt;triples_updated);
		$this-&gt;triples_overwritten = array_merge($this-&gt;triples_overwritten, $other-&gt;triples_overwritten);
		$this-&gt;type_changes = array_merge($this-&gt;type_changes, $other-&gt;type_changes);
		$this-&gt;bad_links = array_merge($this-&gt;bad_links, $other-&gt;bad_links);
	}

	function updValue($frag_id, $p, $ov, $updv){
		$this-&gt;forward[$p] = $updv;
		$this-&gt;backward[$p] = $ov;
		$this-&gt;updateTriple($frag_id, $p, $ov, $updv);
	}

	function updEmbeddedList($frag_id, $p, $vold, $vnew) {
		//this is the hard one.....
		//not supported for cwurls - only can occur in ccr or curs, not in candidates.
	}
	
	function removeTriple($trip_array){
		$this-&gt;removeTriples(array($trip_array));
	}
	
	function addTriple($trip_array){
		$this-&gt;addTriples(array($trip_array));
	}
	
	function removeTriples($trip_array){
		if($this-&gt;gname){
			$this-&gt;triples_removed[$this-&gt;gname] = array_merge($this-&gt;triples_removed[$this-&gt;gname], $trip_array);
		}
		else {
			$this-&gt;triples_removed = array_merge($this-&gt;triples_removed, $trip_array);
		}
	}

	function addTriples($trip_array){
		if($this-&gt;gname){
			$this-&gt;triples_added[$this-&gt;gname] = array_merge($this-&gt;triples_added[$this-&gt;gname], $trip_array);
		}
		else {
			$this-&gt;triples_added = array_merge($this-&gt;triples_added, $trip_array);
		}
	}
	
	function updateTriple($frag_id, $p, $ov, $updv){
		if($this-&gt;make_updates_adds_rems){
			$this-&gt;addTriples(getValueAsTypedTriples($frag_id, $p, $updv, $this-&gt;cwurl));
			$this-&gt;removeTriples(getValueAsTypedTriples($frag_id, $p, $ov, $this-&gt;cwurl));
		}
		else {
			if($this-&gt;gname){
				$this-&gt;triples_updated[$this-&gt;gname][] = array($frag_id, $p, encodeScalar($ov), encodeScalar($updv));
			}
			else {
				$this-&gt;triples_updated[] = array($frag_id, $p, encodeScalar($ov), encodeScalar($updv));
			}
		}
	}
	
	function updObjLiteralList($frag_id, $p, $ovals, $nvals){
		$unchanged = false;
		$rems = array();
		$adds = array();
		foreach($ovals as $oval){
			foreach($nvals as $i =&gt; $nval){
				if(compareObjLiterals($oval, $nval)){
					$unchanged = true;
					break;
				}
			}
			if(!$unchanged){
				$this-&gt;removeTriple(array($frag_id, $p, $oval));
				$rems[] = $oval;			
			}
		}
		$unchanged = false;
		foreach($nvals as $nval){
			foreach($ovals as $i =&gt; $oval){
				if(compareObjLiterals($oval, $nval)){
					$unchanged = true;
					break;
				}
			}
			if(!$unchanged){
				$this-&gt;addTriple(array($frag_id, $p, $oval));
				$adds[] = $nval;			
			}
		}
		if(count($adds) &gt; 0 or count($rems) &gt; 0){
			$this-&gt;forward[$p] = $adds;
			$this-&gt;backward[$p] = $rems;
		}	
	}
	
	function updValueList($frag_id, $p, $ovals, $nvals){
		$change = false;
		foreach($ovals as $oval){
			if(!in_array($oval, $nvals)){
				$this-&gt;removeTriple(array($frag_id, $p, encodeScalar($oval)));
				$change = true;
			}
		}
		foreach($nvals as $nval){
			if(!in_array($nval, $ovals)){
				$this-&gt;addTriple(array($frag_id, $p, encodeScalar($nval)));
				$change = true;
			}
		}
		if($change){
			$this-&gt;forward[$p] = $nvals;
			$this-&gt;backward[$p] = $ovals;
		}
	}
	
	function setMissingLinks($old, $new){
		//check the internal consistency of the delta?
		$this-&gt;bad_links['old'] = $old;
		$this-&gt;bad_links['new'] = $new;
		$this-&gt;bad_links['add'] = array();
		foreach($new as $i =&gt; $nml){
			$link_existed = false;
			foreach($old as $j =&gt; $oml){
				if($oml[0] == $nml[0] &amp;&amp; $oml[1] == $nml[1] &amp;&amp; $oml[2] == $nml[2]){
					$link_existed = true;
					break;
				}
			}
			if(!$link_existed){
				$this-&gt;bad_links['add'] = $nml;
			}
		}
	}

	function getNamedGraphDeleteQuads($gname, $ogname = false){
		if(!$ogname) $ogname = $gname;
		$dels = array();
		if(isset($this-&gt;triples_removed[$gname])){
			foreach($this-&gt;triples_removed[$gname] as $trip){
				$trip[] = $ogname;
				$dels[] = $trip;
			}
		}
		return $dels;
	}
	
	
	function getNamedGraphInsertQuads($gname, $ogname = false){
		if(!$ogname) $ogname = $gname;
		$adds = array();
		if(isset($this-&gt;triples_added[$gname])){
			foreach($this-&gt;triples_added[$gname] as $trip){
				$trip[] = $ogname;
				$adds[] = $trip;
			}
		}
		return $adds;		
	}
	
	function candidateInserts($callable = false){
		$inserts = array();
		foreach($this-&gt;triples_added as $trip){
			if(is_array($trip[2])){
				$o = $trip[2]['data'];
				$t = 'literal';
			}
			else {
				$o = $trip[2];
				$t = 'link';
			}
			if($callable){
				$inserts = array_merge($inserts, $callable($trip[0], $trip[1], $o, $t));
			}
			else {
				$inserts[] = array($trip[0], $trip[1], $o);
			}
		}
		return $inserts;
	}

	function candidateDeletes($callable = false){
		$deletes = array();
		foreach($this-&gt;triples_removed as $trip){
			if(is_array($trip[2])){
				$o = $trip[2]['data'];
				$t = 'literal';
			}
			else {
				$o = $trip[2];
				$t = 'link';
			}
			if($callable){
				$deletes = array_merge($deletes, $callable($trip[0], $trip[1], $o, $t));
			}
			else {
				$deletes[] = array($trip[0], $trip[1], $o);
			}
		}
		return $deletes;
	}
	
	
}</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>