<html>
    <head>
        <script
            type="text/javascript"
            src="../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
require_once(&quot;ServiceCall.php&quot;);
require_once(&quot;DacuraService.php&quot;);
require_once(&quot;DacuraServer.php&quot;);

/**
 * Class which loads the appropriate service object to handle the call when a new request is first received - 
 * 
 * both by api and index
 * * Creation Date: 20/11/2014
 * @author Chekov
 * @license GPL v2
 */

class ServiceLoader extends DacuraObject {
	/** @var string the path to the service directory */
	var $p2s;
	/** @var array system configuration settings array
	var $settings;
	
	/**
	 * @param array $settings system configuration settings
	 */
	function __construct($settings){
		$this-&gt;p2s = $settings['path_to_services'];
		$this-&gt;settings = $settings;
	}
	
	/**
	 * returns an array listing the ids of all the dacura services.
	 * @return string[] |boolean either the list of all the services, or false on error.
	 */
	function getServiceList(){
		$srvcs = array();
		if ($handle = opendir($this-&gt;p2s)) {
			while (false !== ($entry = readdir($handle))) {
				if ($entry != &quot;.&quot; &amp;&amp; $entry != &quot;..&quot;) {
					if(is_dir($this-&gt;p2s.$entry)
							&amp;&amp; file_exists($this-&gt;p2s.$entry.&quot;/&quot;.ucfirst($entry).&quot;Service.php&quot;)){
						$srvcs[] = $entry;
					}
				}
			}
			closedir($handle);
			return $srvcs;
		}
		return $this-&gt;failure_result(&quot;Failed to read services directory for service list&quot;, 500);
	}
		
	/**
	 * Creates a service object from a browser page load 
	 * @param RequestLog $logger 
	 * @return DacuraService|boolean
	 */
	function loadServiceFromURL(RequestLog &amp;$logger){
		$service_call = $this-&gt;parseServiceCall(&quot;html&quot;);		
		if($service_call){
			return $this-&gt;loadServiceFromCall($service_call, $logger);
		}
		return false;
	}
	
	/**
	 * Creates a service object from an API invocation
	 * @param RequestLog $logger
	 * @return DacuraService|boolean
	 */
	function loadServiceFromAPI(&amp;$logger){
		$service_call = $this-&gt;parseServiceCall(&quot;api&quot;);
		if($service_call){
			return $this-&gt;loadServiceFromCall($service_call, $logger);	
		}
		return false;
	}
	
	/**
	 * Creates a serviceCall object to parse the request
	 * @param string $provenance [html | rest]
	 * @return ServiceCall|boolean
	 */	
	 function parseServiceCall($provenance){
		$sc = new ServiceCall();
		$sc-&gt;parseURLInput($this-&gt;getServiceList());
		$sc-&gt;provenance = $provenance;
		if($provenance == &quot;html&quot; &amp;&amp; !$sc-&gt;servicename){
			//the home page (for the user or for collection_id..
			$sc-&gt;servicename = &quot;home&quot;;
		}
		if($sc-&gt;servicename == &quot;report&quot;){
			$sc-&gt;servicename = &quot;candidate&quot;;
		}
		if($this-&gt;serviceExists($sc-&gt;servicename)){
			return $sc;
		}
		else {
			return $this-&gt;failure_result(&quot;You have arrived at a non-existant URL. The service $sc-&gt;servicename in URL $sc-&gt;rawpath does not exist&quot;, 404);
		}
		$sc-&gt;provenance = $provenance;
		return $sc;
	}
	

	/**
	 * Load a service object
	 * 
	 * @param ServiceCall $sc
	 * @param RequestLog $logger the logger object tracking this request
	 * @return DacuraService|boolean
	 */
	function loadServiceFromCall($sc, &amp;$logger = null){
		global $dacura_settings;
		$type = ucfirst(strtolower($sc-&gt;servicename)).&quot;Service&quot;;
		$fname = $this-&gt;p2s .&quot;$sc-&gt;servicename/&quot;.ucfirst(strtolower($sc-&gt;servicename)).&quot;Service.php&quot;;
		$sname = $this-&gt;p2s .&quot;$sc-&gt;servicename/&quot;.strtolower($sc-&gt;servicename).&quot;_settings.php&quot;;
		if(file_exists($fname)){
			include_once($fname);
			if(file_exists($sname)){
				include_once($sname);
				$this-&gt;settings[strtolower($sc-&gt;servicename)] = $settings; 	
			}
			$ns = new $type($this-&gt;settings);
			$ns-&gt;load($sc, $logger);
			return $ns;
		}
		else {
			return $this-&gt;failure_result(&quot;Service $sc-&gt;servicename does not exist or could not be loaded&quot;, 404);
		}
	}
	
	/**
	 * Checks to ensure that there is a servicenamme included in the service call
	 * 
	 * @param ServiceCall $sc
	 * @return boolean if the service name is set
	 */
	function serviceCallIsValid($sc){
		if(!$sc-&gt;servicename){
			return $this-&gt;failure_result(&quot;No servicename included in URL&quot;, 404);
		}
		return true;
	}
	
	/**
	 * Checks that a given service actually exists
	 * @param string $servicename
	 * @return boolean true if service exists
	 */
	function serviceExists($servicename){
		return file_exists($this-&gt;settings['path_to_services'].&quot;$servicename/&quot;.ucfirst(strtolower($servicename)).&quot;Service.php&quot;);
	}	
}
</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>