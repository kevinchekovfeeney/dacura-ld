<html>
    <head>
        <script
            type="text/javascript"
            src="../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
/**
 * Class representing a service invocation
 * 
 * This is extended by actual service classes
 * The base class contains common functionality for producing service paths and urls for the current context
 * Creation Date: 20/11/2014
 * 
 * @author Chekov
 * @license GPL v2
 */
class DacuraService extends DacuraObject {
	/** @var array a name-value associate array of configuration settings that apply to this service invocation */
	var $settings; 
	/** @var string the path to the service's home directory (phplib/services/sname/) */
	var $mydir;
	/** @var string the service's name */
	var $servicename = &quot;abstract_base_class&quot;;
	/** @var string the id of the collection in which the service was invoked */
	var $collection_id;
	/** @var array associative array of the arguments that were passed to the service invocation */
	var $args;	
	/** @var string either &quot;html&quot; or &quot;api&quot; to indicate that the service was invoked from either a webpage or an api call*/ 
	var $connection_type; 
	/** @var string the name of the screen requested when the service is invoked in html mode */
	var $screen = &quot;&quot;; 
	/** @var string the screen to be used if no screen is passed with invocation in html mode */
	var $default_screen = &quot;view&quot;;
	/** @var RequestLog the service logger object */
	var $logger;
	/** @var string[] An array of java script urls which will be included in service screens */
	var $included_scripts = array();
	/** @var string[] An array of stylesheet urls which will be included in screens */
	var $included_css = array();

	/**
	 * 
	 * @param array $settings a name-value associative array of settings for the service invocation 
	 */
	function __construct($settings){
		$this-&gt;settings = $settings;
	}
	
	/**
	 * Called immediately after service creation.  
	 * 
	 * To be defined by derived services who have particular initiallisation requirements
	 */
	function init(){}

	/**
	 * returns the id of the collection in which the service was invokved. 
	 * 
	 * If there is no collection id (server root context) the string &quot;all&quot; will be returned
	 * @return string the collection id 
	 */
	function getCollectionID(){
		return $this-&gt;collection_id;
	}
	
	/**
	 * Returns the name of the service that was invoked
	 * @return string
	 */
	function name(){
		return $this-&gt;servicename;
	}
	
	/**
	 * Returns a user-readable title of the service 
	 * If no title property is set, the title is service id followed by &quot;service&quot;
	 * @return string the service title
	 */
	function getTitle(){
		if(isset($this-&gt;title) &amp;&amp; $this-&gt;title){
			return $this-&gt;title;
		}
		return ucfirst($this-&gt;servicename).&quot; Service&quot;;
	}
	
	/* Shorthand methods to access context details.*/
	
	/**
	 * shorthand for get collection id
	 * @return string collection id
	 */
	function cid(){
		return $this-&gt;getCollectionID();
	}
	
	/**
	 * Returns the base url of the dacura server
	 * @param string $ajax if true, the ajax url is returned, otherwise the html url
	 * @return string the url
	 */
	function durl($ajax = false){
		return (!$ajax) ? $this-&gt;getSystemSetting('install_url') : $this-&gt;getSystemSetting('ajaxurl');
	}
	
	/**
	 * Loads the service context from the service call object passed in
	 * @param ServiceCall $sc the object containing the parameters of the service invocation
	 * @param RequestLog $logger the object which will be used to log the results of the request
	 */
	function load(ServiceCall $sc, RequestLog &amp;$logger){
		$this-&gt;servicename = $sc-&gt;servicename;
		$this-&gt;collection_id = $sc-&gt;collection_id;
		$this-&gt;connection_type = $sc-&gt;provenance;
		if($sc-&gt;provenance == &quot;html&quot;){ //if it is html, all the arguments are in the URL
			$this-&gt;loadArgsFromBrowserURL($sc-&gt;args);
		}
		else {
			$this-&gt;args = $sc-&gt;args;
		}
		$this-&gt;mydir = $this-&gt;getSystemSetting('path_to_services').$this-&gt;name().&quot;/&quot;;
		$logger-&gt;loadFromService($this);
		$this-&gt;logger =&amp; $logger;
		if($sc-&gt;provenance == &quot;html&quot;){ //if it is html, all the arguments are in the URL
			$this-&gt;logger-&gt;setEvent(&quot;read&quot;, $this-&gt;screen);
		}
		$this-&gt;init();
	}
	
	/**
	 * Loads the service as a dependant service of another service (i.e. the other service is the one being called by the user
	 * and using this service incidentally)
	 * @param string $sid the id of the service being loaded
	 * @param DacuraService $other the controlling service doing the loading
	 */
	function loadAsDependant($sid, DacuraService &amp;$other){
		$this-&gt;servicename = $sid;
		$this-&gt;collection_id = $other-&gt;cid();
		$this-&gt;connection_type = $other-&gt;connection_type;
		$this-&gt;mydir = $this-&gt;getSystemSetting('path_to_services').$sid.&quot;/&quot;;
		$this-&gt;logger =&amp; $other-&gt;logger;
		$this-&gt;init();
	}
	
	/**
	 * Loads the appropriate server for this service
	 * 
	 * Every Dacura Service has an associated Server which serves as an interface between the service and the rest 
	 * of the system. By convention, the server name is the service name followed by &quot;DacuraServer&quot; 
	 * 
	 *  At this stage we also load all of the configuration information in the system and local collections.
	 */
	function loadServer(){
		$srvclass = ucfirst($this-&gt;servicename).&quot;DacuraServer&quot;;
		try {
			$srvr = new $srvclass($this);
			if($srvr-&gt;errcode){
				return $this-&gt;failure_result($srvr-&gt;errmsg, $srvr-&gt;errcode);
			}
			if($this-&gt;cid() != &quot;all&quot;){
				if(!$this-&gt;loadDefaultCollectionSettings($srvr)){
					default_settings($this-&gt;settings);//must load them explicitly as they aren't loaded yet
					return false;
				}
			}
			$this-&gt;loadContextSettings($this-&gt;settings, $srvr);
			$this-&gt;loadServiceContextSettings($this-&gt;servicename, $this-&gt;settings[$this-&gt;servicename], $srvr);
			$u = $srvr-&gt;getUser();
			if($u){
				$this-&gt;logger-&gt;user_name = $u-&gt;getName();
			}
			else {
				$this-&gt;logger-&gt;user_name = $_SERVER['REMOTE_ADDR'];				
			}
			return $srvr;
		}
		catch(Exception $e){
			return $this-&gt;failure_result(&quot;Failed to create $srvrclass object: &quot;.$e-&gt;getMessage(), 500);
		}
	}
	
	/**
	 * Loads the necessary settings for a collection from the default values if they have not already been set by
	 * the configuration. 
	 * @param DacuraServer $srvr
	 * @return boolean true if success
	 */
	function loadDefaultCollectionSettings(DacuraServer $srvr){
		if(!$col = $srvr-&gt;getCollection()){
			return $this-&gt;failure_result($this-&gt;cid() . &quot; is not a valid id of a dacura collection or service&quot;, 404);
		}
		if($col-&gt;status != &quot;accept&quot; &amp;&amp; !$srvr-&gt;userHasRole(&quot;admin&quot;, &quot;all&quot;)){
			return $this-&gt;failure_result($this-&gt;cid() . &quot; is currently in state $col-&gt;status and cannot be accessed&quot;, 401);
		}
		$defs = $col-&gt;getDefaultSettings($srvr);
		foreach($defs as $k =&gt; $v){
			if(!isset($this-&gt;settings[$k])){
				$this-&gt;settings[$k] = $defs[$k];
			}
		}
		return true;
	}
	
	/**
	 * Loads the settings for the context (collection)
	 * @param array $settings the settings array to load
	 * @param DacuraServer $srvr the active server
	 */
	function loadContextSettings(&amp;$settings, DacuraServer $srvr){
		$sys = $srvr-&gt;getCollection(&quot;all&quot;);
		$this-&gt;applyCollectionSettings($settings, $sys);
		if($this-&gt;cid() != &quot;all&quot;){
			$c = $srvr-&gt;getCollection();
			$this-&gt;applyCollectionSettings($settings, $c);
		}
		$this-&gt;overwriteLocked($settings, $sys-&gt;getConfig(&quot;settings&quot;), $sys-&gt;getConfig(&quot;meta&quot;));
		default_settings($settings);
	}

	/**
	 * Loads the service's settings for this context (collection)
	 * @param string $sid the id of the service
	 * @param array $settings the settings array to load
	 * @param DacuraServer $srvr the active server
	 */
	function loadServiceContextSettings($sid, &amp;$settings, DacuraServer $srvr){
		$sys = $srvr-&gt;getCollection(&quot;all&quot;);
		$this-&gt;applyServiceSettings($sid, $settings, $sys);
		if($this-&gt;cid() != &quot;all&quot;){
			$c = $srvr-&gt;getCollection();
			$this-&gt;applyServiceSettings($sid, $settings, $c);
		}
		$sset = $sys-&gt;getConfig(&quot;services.&quot;.$sid);
		$smeta = $sys-&gt;getConfig(&quot;servicesmeta.&quot;.$sid);
		$this-&gt;overwriteLocked($settings, $sset, $smeta);
		if(isset($sset['status']) &amp;&amp; isset($smeta['status']) &amp;&amp; isset($smeta['status']) &amp;&amp; $smeta['status']['changeable'] != &quot;changeable&quot;){
			$settings['status_locked'] = true;	
		}
		//opr($sset);
		if(isset($sset['status']) &amp;&amp; $sset['status'] != &quot;enable&quot;){
			$settings['status'] = 'disable';
		}
	}
	
	/**
	 * Overwrites any values in the settings that are locked at a system level with the corresponding system level values
	 * 
	 * Provides the basic ability to lock certain variables system wide 
	 * @param array $arr collection settings array
	 * @param array $lvals system level settings array
	 * @param array $meta an array of metadata about the lvals - only those with a meta[changeable] = changeable can vary in collections
	 */
	function overwriteLocked(&amp;$arr, $lvals, $meta){
		if(!is_array($lvals)) return;
		foreach($lvals as $i =&gt; $v){
			if(isset($meta[$i]) &amp;&amp; isset($meta[$i]['changeable']) &amp;&amp; $meta[$i]['changeable'] != &quot;changeable&quot;){
				$arr[$i] = $v;
			}
			if(is_array($lvals[$i])){
				$this-&gt;overwriteLocked($arr[$i], $lvals[$i], $meta);
			}
		}
	}
	
	/**
	 * Applies the settings from the passed collection to a particular service's settings
	 * @param string $sid the service id
	 * @param array $ssettings the server level settings array
	 * @param Collection $c the collection object to apply
	 */
	function applyServiceSettings($sid, &amp;$ssettings, $c){
		if($service_conf = $c-&gt;getConfig(&quot;services.&quot;.$sid)){
			foreach($service_conf as $k =&gt; $v){
				$ssettings[$k] = $v;
			}
		}
	}
	
	/**
	 * Applies the settings from the passed collection to the system settings
	 * @param array $settings the settings array to be modified
	 * @param Collection $c the collection object to apply
	 */
	function applyCollectionSettings(&amp;$settings, $c){
		if($csets = $c-&gt;getConfig(&quot;settings&quot;)){
			foreach($csets as $k =&gt; $v){
				$settings[$k] = $v;				
			}
		}
	}
	
	/*  Service access control / facet related functions */
	
	/**
	 * Returns a list of the facets that are considered active for the current user
	 * @param DacuraUser $u (or false if not logged in)
	 * @return array&lt;string&gt; the list of the facet names that are active
	 */
	function getActiveFacets($u = false){
		if(!$facets = $this-&gt;getServiceSetting(&quot;facets&quot;)){
			if(isset($this-&gt;default_facets) &amp;&amp; is_array($this-&gt;default_facets)){
				return $this-&gt;default_facets;
			}
			return array();
		}
		$allowed = array();
		foreach($facets as $f){
			if($f['role'] == &quot;public&quot;){
				$allowed[] = $f;
			}
			elseif($u &amp;&amp; $u-&gt;hasSufficientRole($f['role'], $this-&gt;cid())){
				$allowed[] = $f;				
			}
		}
		return $allowed;
	}
	
	/**
	 * Compares facets according to some hierarchy - returns true if the first is &gt;= the second
	 * @param string $a facet name
	 * @param string $b facet name
	 * @return true if $a &gt;= $b
	 */
	function compareFacets($a, $b){
		//hierarchy... admin-&gt;manage
		//admin-&gt;inspect-&gt;view inspect-&gt;list
		if($a == $b) return true;
		if($a == &quot;admin&quot;) return true;
		elseif($b == &quot;admin&quot;) return false;
		if(($a == &quot;manage&quot; || $a == &quot;inspect&quot;) &amp;&amp; ($b == 'view' or $b == 'list')) return true;
		return false;
	}
	
	/**
	 * What is the minimum facet required to access the service at the given screen?
	 * @param DacuraServer $dacura_server
	 * @return string the facet name required
	 */
	function getMinimumFacetForAccess(DacuraServer &amp;$dacura_server){
		return $this-&gt;getScreenForAC($dacura_server);
	}
		
	/**
	 * Load any URL arguments from the browser into the service context
	 * 
	 * Sets the first arg to screen
	 * Sets args to a name value associative array covering the rest of the args /a/b/c/d =&gt; [a=&gt;b, c=&gt;d]
	 * 
	 * @param string[] $sections the segments of the URL (divided by /) that appeared after the servicename in the URL 
	 */
	function loadArgsFromBrowserURL($sections){
		if(count($sections) &gt; 0){
			$this-&gt;screen = array_shift($sections);
			$this-&gt;args = array();
			for($i = 0; $i &lt; count($sections); $i+=2){
				$this-&gt;args[$sections[$i]] = (isset($sections[$i + 1]) ? $sections[$i + 1] : &quot;&quot;);
			}
			$this-&gt;args['screen'] = $this-&gt;screen;
		}
		else {
			$this-&gt;screen = $this-&gt;default_screen;
		}
	}

	/*
	 * Functions for getting configuration settings
	 */

	/**
	 * Return the value of a system configuration setting
	 * @param string $cname the name of the configuration variable
	 * @param string $def the default value to give it if the variable does not exist
	 * @param array $fillings name value array of parameter subsitutions (&quot;TITLE&quot; =&gt; &quot;this is the title to be subbed in&quot;)
	 * @return string the parameterised configuration variable value (or default if not set)
	 */
	function getSystemSetting($cname, $def = false, $fillings = array()){
		if(isset($this-&gt;settings[$cname])){
			$cval = $this-&gt;settings[$cname];
			return $this-&gt;subParamsIntoConfigValue($cval, $fillings);
		}
		return $def;
	}
	
	/**
	 * returns the value of a service configuration variable (or default if it does not exist)
	 * @param unknown $cname
	 * @param string $def the default value to give it if the variable does not exist
	 * @param array $fillings name value array of parameter subsitutions (&quot;TITLE&quot; =&gt; &quot;this is the title to be subbed in&quot;)
	 * @return string the parameterised configuration variable value (or default if not set)
	 */
	function getServiceSetting($cname, $def = false, $fillings = array()){
		if(isset($this-&gt;settings[$this-&gt;servicename]) &amp;&amp; isset($this-&gt;settings[$this-&gt;servicename][$cname])){
			$cval = $this-&gt;settings[$this-&gt;servicename][$cname];
			return $this-&gt;subParamsIntoConfigValue($cval, $fillings);
		}
		return $def;
	}
	
	/**
	 * Substitutes parameters (fillings) into the configuration variable value 
	 * 
	 * If the value is an array, it will apply the subtitution recursively to the array values
	 * @param mixed $val the configuration variable value
	 * @param array $fillings name value array of parameter subsitutions (&quot;TITLE&quot; =&gt; &quot;this is the title to be subbed in&quot;)
	 */
	protected function subParamsIntoConfigValue(&amp;$val, $fillings){
		if(is_array($val)){
			foreach($val as $i =&gt; $nval){
				$this-&gt;subParamsIntoConfigValue($val[$i], $fillings);
			}
		}
		else {
			foreach($fillings as $n =&gt; $v){
				if(strstr($n, $val) !== false){
					$val = str_replace($n, $v, $val);
				}		
			}
		}
		return $val;//just for convenience - the value is changed by being passed by reference
	}
	
	/**
	 * Get the necessary configuration for a particular dacura form 
	 * @param string $id the form id
	 * @param array $fillings name value array of parameter subsitutions (&quot;TITLE&quot; =&gt; &quot;this is the title to be subbed in&quot;)
	 * @return array an array of form element configurations (associative arrays with id, etc. set]
	 * @see DacuraForm 
	 */
	protected function sform($id, $fillings = array()){
		$form = $this-&gt;getServiceSetting($id);
		if(!$form){
			return array();
		}
		$sform = array();
		foreach($form as $fieldid =&gt; $onef){
			if(!isset($onef['id'])){
				$onef['id'] = $fieldid;
			}
			$sform[$fieldid] = $this-&gt;subParamsIntoConfigValue($onef, $fillings);
		}
		return $sform;
	}
	
	/**
	 * Get a particular natural language message from a service's setting
	 * @param string $id the message id
	 * @param array $fillings name value array of parameter subsitutions (&quot;TITLE&quot; =&gt; &quot;this is the title to be subbed in&quot;)
	 * @return string the message itself
	 */
	protected function smsg($id, $fillings = array()){
		$msgs = $this-&gt;getServiceSetting(&quot;messages&quot;, array());
		$msg = isset($msgs[$id]) ? $msgs[$id] : &quot;&quot;;
		return $this-&gt;subParamsIntoConfigValue($msg, $fillings);
	}
	
	/**
	 * Get a particular listing table configuration from a service's settings 
	 * @param string $id the table id
	 * @param array $fillings
	 * @return mixed
	 */
	protected function stab($id, $fillings = array()){
		$tabs = $this-&gt;getServiceSetting(&quot;tables&quot;, array());
		$tab = isset($tabs[$id]) ? $tabs[$id] : array();
		return $this-&gt;subParamsIntoConfigValue($tab, $fillings);
	}
	
	/**
	 * Return the services datatable settings for a particular table
	 * @param string $id table id
	 * @return string|boolean the json-encoded datatable setting string or false if not found
	 */
	protected function getDatatableSetting($id){
		$tab = $this-&gt;stab($id);
		if(isset($tab['datatable_options'])){
			return json_encode($tab[&quot;datatable_options&quot;]);
		}
		return false;
	}
	
	/* Functions for rendering screens. Listed in the order that they are called */
	
	/**
	 * Includes a snippet of html (from services/core/snippets) and sets the parameters in it
	 *
	 * @param string $sn snippet name
	 * @param array $params substitution name value array for snippet parameters
	 */
	public function includeSnippet($sn, $params = array()){
		$service = &amp;$this;//make $service available in the scope of the snippet
		global $dacura_server;//make server available too!
		include(path_to_snippet($sn));
	}
	
	/**
	 * Renders a screen when viewed in full page mode
	 * @param DacuraServer $dacura_server
	 */
	public function renderFullPage(DacuraServer &amp;$dacura_server){
		$this-&gt;renderFullPageHeader($dacura_server);
		$this-&gt;handlePageLoad($dacura_server);
		$this-&gt;renderFullPageFooter($dacura_server);
	}

	/**
	 * Renders the html header for a service when viewed in full page mode
	 * @param DacuraServer $dacura_server
	 */
	protected function renderFullPageHeader(DacuraServer &amp;$dacura_server){
		$this-&gt;renderHeaderSnippet($dacura_server);
		$this-&gt;renderTopbarSnippet($dacura_server);
		$this-&gt;writeIncludedScripts($dacura_server);
		$this-&gt;writeIncludedCSS($dacura_server);
		$this-&gt;writeBodyHeader($dacura_server);
	}
	
	/**
	 * Render the page's HTML header
	 * @param DacuraServer $dacura_server the dacura server object that was invoked
	 */
	protected function renderHeaderSnippet(DacuraServer &amp;$dacura_server){
		$service = &amp;$this;
		$params = $this-&gt;settings;
		$this-&gt;includeSnippet(&quot;header&quot;, $params);
	}
	
	/**
	 * Render the bar at the top of each Dacura Page
	 * @param DacuraServer $dacura_server
	 */
	protected function renderTopbarSnippet(DacuraServer &amp;$dacura_server){
		$params = $this-&gt;getTopbarParams($dacura_server);
		$service = &amp;$this;
		$this-&gt;renderScreen(&quot;topbar&quot;, $params, &quot;core&quot;);
	}
	
	/**
	 * Generates a parameter array for passing to the topbar snippet rendering
	 * @param DacuraServer $dacura_server
	 * @return array a name-value array of parameters
	 */
	protected function getTopbarParams(DacuraServer &amp;$dacura_server){
		$params = array();
		$params[&quot;context&quot;] = $dacura_server-&gt;loadContextParams();
		$scl = $this-&gt;getServiceContextLinks();
		if(count($scl) &gt; 0){
			$params[&quot;context&quot;][] = $scl;
		}
		$u = $dacura_server-&gt;getUser();
		if($u){
			$params[&quot;username&quot;] = $u-&gt;handle;
			$params[&quot;usericon&quot;] = $this-&gt;furl(&quot;image&quot;, &quot;icons/user_icon.png&quot;);
			if($u-&gt;rolesSpanCollections()){
				$params[&quot;profileurl&quot;] = $this-&gt;get_service_url(&quot;users&quot;, array(), &quot;html&quot;, &quot;all&quot;, &quot;all&quot;).&quot;/profile&quot;;
			}
			else {
				$cid = $u-&gt;getRoleCollectionId();
				$params[&quot;profileurl&quot;] = $this-&gt;get_service_url(&quot;users&quot;, array(), &quot;html&quot;, $cid, &quot;all&quot;).&quot;/profile&quot;;
			}
			$params[&quot;logouturl&quot;] = $this-&gt;getSystemSetting(&quot;install_url&quot;).&quot;login/logout&quot;;
			if(isset($u-&gt;sesssion['system'])){
				$sys = $u-&gt;sessions[&quot;system&quot;];
				$params[&quot;activity&quot;] = &quot;logged in for &quot;.gmdate(&quot;H:i&quot;, $sys-&gt;activeDuration());
			}
			else {
				$params[&quot;activity&quot;] = &quot;unknown access history&quot;;
			}
		}
		return $params;
	}
	/**
	 * Loads a parameter array for the current service
	 * @return array parameter array(&quot;class&quot;: css class, &quot;url&quot;: service url, &quot;icon&quot;: service icon file, &quot;name&quot;: service name)
	 */
	protected function getServiceContextLinks(){
		$cls = ($this-&gt;getCollectionID() == &quot;all&quot;) ? &quot;service-context ucontext first&quot; : &quot;service-context ucontext&quot;;
		$sparams = array(
				&quot;class&quot; =&gt; $cls,
				&quot;url&quot; =&gt; $this-&gt;get_service_url(),
				&quot;icon&quot; =&gt; $this-&gt;furl(&quot;image&quot;, &quot;services/&quot;.$this-&gt;servicename.&quot;_icon.png&quot;),
				&quot;name&quot; =&gt; $this-&gt;getServiceSetting(&quot;service-title&quot;, $this-&gt;getTitle())
		);
		return $sparams;
	}
	
	/**
	 * Includes any necessary javascripts in the page
	 * 
	 * If there is a script in the service directory called dacura.[servicename].js it will be included
	 * As will any scripts that are added to $this-&gt;included_scripts
	 * @param DacuraServer $dacura_server
	 */
	protected function writeIncludedScripts(DacuraServer &amp;$dacura_server){
		$jsname = &quot;dacura.&quot;.$this-&gt;servicename.&quot;.js&quot;;
		if(file_exists($this-&gt;mydir.$jsname)){
			$this-&gt;included_scripts[] = $this-&gt;furl(&quot;script&quot;, $jsname);
		}
		foreach($this-&gt;included_scripts as $url){
			echo &quot;&lt;script src='$url'&gt;&lt;/script&gt;&quot;;
		}
	}
	
	/**
	 * Writes the html to include necessary css files in page
	 * 
	 * Whatever is included in $this-&gt;included_css is included
	 * @param DacuraServer $dacura_server
	 */
	protected function writeIncludedCSS(DacuraServer &amp;$dacura_server){
		foreach($this-&gt;included_css as $url){
			echo '&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; media=&quot;screen&quot; href=&quot;'.$url.'&quot;&gt;';
		}
	}
	
	/**
	 * Writes the header of the page body
	 * @param DacuraServer $dacura_server
	 */
	protected function writeBodyHeader(DacuraServer &amp;$dacura_server){
		echo &quot;&lt;div id='pagecontent-container'&gt;&quot;;
		echo &quot;&lt;div id='pagecontent-nopad'&gt;&quot;;
	}
	
	/**
	 * Called to deal with the actual invocation when a page is loaded after the headers have been rendered
	 * @param DacuraServer $dacura_server
	 */
	function handlePageLoad(DacuraServer &amp;$dacura_server){
		$screen = $this-&gt;getScreenForCall($dacura_server);
		if($screen){
			$params = $this-&gt;getParamsForScreen($screen, $dacura_server);
			$this-&gt;renderToolHeader($params);
			$this-&gt;renderScreen($screen, $params);
			$this-&gt;renderToolFooter($params);
		}
		else {
			$params = $this-&gt;getParamsFor404($dacura_server);
			$this-&gt;renderScreen(&quot;error&quot;, $params, &quot;core&quot;);
		}
	}

	/**
	 * Which screen is being accessed by the browser?
	 * @param DacuraServer $dacura_server
	 * @return string the id of the screen
	 */
	function getScreenForCall(DacuraServer &amp;$dacura_server){
		return $this-&gt;screen;
	}
	
	/**
	 * Which screen is being accessed from an access control point of view?
	 * 
	 * This is separated out to allow services to override this to get 
	 * complex relationships between screens and access control
	 * @param DacuraServer $dacura_server
	 * @return string the id of the screen 
	 */
	function getScreenForAC(DacuraServer &amp;$dacura_server){
		return $this-&gt;getScreenForCall($dacura_server);
	}
	
	/**
	 * Generate the name-value array of parameters to pass to a particular screen
	 * @param string $screen the id of the screen in question
	 * @param DacuraServer $dacura_server
	 * @return array parameter array 
	 */
	function getParamsForScreen($screen, DacuraServer &amp;$dacura_server){
		return $this-&gt;args;
	}
	
	/**
	 * Gets the necessary parameter array for 404 screens (when the screen being accessed does not exist)
	 * @param DacuraServer $dacura_server
	 * @return array Parameter array(title =&gt; &quot;&quot;, &quot;message&quot; =&gt; )
	 */
	function getParamsFor404(&amp;$dacura_server){
		return array(&quot;title&quot; =&gt; &quot;The screen could not be found&quot;, &quot;message&quot; =&gt; &quot;The service was not able to identify a screen for the call&quot;);;
	}	
	
	/**
	 * Writes the tool header html to the browser
	 * @param array $option name value array of options to pass to tool
	 */
	protected function renderToolHeader($option){
		global $dacura_server;//make it available in the scope of the tool header template
		$params = array();
		$params['close-link'] = isset($option['close-link']) ? $option['close-link'] : $this-&gt;get_service_url(&quot;browse&quot;);
		$params['close-msg'] = isset($option['close-tool-msg']) ? $option['close-tool-msg'] : &quot;Close the tool and return to the main menu&quot;;
		$params['title']= isset($option['title']) ? $option['title'] : &quot;Dacura Tool&quot;;
		$params['subtitle'] = isset($option['subtitle']) ? $option['subtitle'] : &quot;&quot;;
		$params['description'] = isset($option['description']) ? $option['description'] : &quot;&quot;;
		$params['image'] = isset($option['image']) ? $option['image'] : false;
		$params['image-link'] = $dacura_server-&gt;userHasRole(&quot;admin&quot;, &quot;all&quot;) ? $this-&gt;durl().$this-&gt;servicename : &quot;&quot;;
		$params['css_class'] = isset($option[&quot;css_class&quot;]) ? $option[&quot;css_class&quot;] : &quot;&quot;;
		$params['tabs'] = isset($option['tabs']) ? $option['tabs'] : false;
		$params['jsoned'] = isset($option['jsoned']) ? true : false;
		$params['dt'] = isset($option['dt']) ? true : false;
		$params['init-msg'] = isset($option['msg']) ? $option['msg'] : &quot;&quot;;
		$tl = isset($option['breadcrumb_labels']) ? $option['breadcrumb_labels'] : false;
		$tx = isset($option['breadcrumb_links']) ? $option['breadcrumb_links'] : false;
		$params['breadcrumbs'] = isset($option['breadcrumbs']) ? $this-&gt;getBreadCrumbsHTML($tl, $tx) : false;
		$this-&gt;includeSnippet(&quot;toolheader&quot;, $params);
	}

	/**
	 * Called to render a screen to the browser
	 * @param string $screen the name of the screen to render
	 * @param array $params name value associate array of substitution parameters to be passed to screen
	 * @param string $other_service if set, the screen will be taken from this service, rather than the current one which is default
	 * @return void
	 */
	public function renderScreen($screen, $params, $other_service = false){
		$service =&amp; $this;
		global $dacura_server;
		if($other_service){
			$f = $this-&gt;getSystemSetting('path_to_services').$other_service.&quot;/screens/$screen.php&quot;;
			if(file_exists($f)){				
				include_once($f);
			}
			else {
				return $this-&gt;renderScreen(&quot;error&quot;, array(&quot;title&quot; =&gt; &quot;Navigation Misstep&quot;, &quot;message&quot; =&gt; &quot;No '$screen' page found in $other_service service&quot;), &quot;core&quot;);
			}
		}
		else {
			$f = $this-&gt;mydir.&quot;screens/$screen.php&quot;;
			if(file_exists($f)){
				include_once($f);
			}
			else {
				return $this-&gt;renderScreen(&quot;error&quot;, array(&quot;title&quot; =&gt; &quot;Navigation Error&quot;, &quot;message&quot; =&gt; &quot;No '$screen' page found in &quot;.$this-&gt;servicename), &quot;core&quot;);
			}
		}
	}
	
	/**
	 * Renders a screen and returns the HTML string
	 * @param string $screen
	 * @param array $params - name:value substitution parameters for screen 
	 * @param string $other_service the name of the service which owns the screen (if omitted, the current service is assumed)
	 * @return string the html encoding of the screen
	 */
	public function renderScreenAsString($screen, $params, $other_service = false){
		ob_start();
		$this-&gt;renderScreen($screen, $params, $other_service);
		$page = ob_get_contents();
		ob_end_clean();
		return $page;
	}
	
	/**
	 * Tests whether the service has a particular screen
	 * @param string $screen the name of the screen
	 * @return boolean true if it exists
	 */
	function hasScreen($screen){
		return file_exists($this-&gt;mydir.&quot;screens/$screen.php&quot;);
	}
	
	/**
	 * Writes the tool footer html to the browser
	 * @param array $params
	 */
	protected function renderToolFooter($params){
		$this-&gt;includeSnippet(&quot;toolfooter&quot;, $params);
	}
	
	/**
	 * Render the html footer of a full page
	 * @param DacuraServer $dacura_server
	 */
	protected function renderFullPageFooter(DacuraServer &amp;$dacura_server){
		$service = &amp;$this;
		$this-&gt;writeBodyFooter($dacura_server);
		$this-&gt;includeSnippet(&quot;footer&quot;);
	}
	
	/**
	 * Writes the footer of the page body
	 * @param DacuraServer $dacura_server
	 */
	protected function writeBodyFooter(DacuraServer &amp;$dacura_server){
		echo &quot;&lt;/div&gt;&lt;/div&gt;&quot;;
	}
	
	/*
	 * The next functions render snippets of html that are needed by multiple services
	 */
	
	/**
	 * Renders the LD editor screen (from the ld service)
	 * @param array $params
	 */
	public function showLDEditor($params){
		$service = $this;
		$entity = isset($params['entity']) ? $params['entity'] : &quot;Entity&quot;;
		$this-&gt;renderScreen(&quot;editor&quot;, $params, &quot;ld&quot;);
	}
	
	/**
	 * Renders the Linked Data Update Result box
	 * @param array $params
	 */
	public function showLDResultbox($params){
		$service = $this;
		$entity = isset($params['entity']) ? $params['entity'] : &quot;Entity&quot;;
		$this-&gt;renderScreen(&quot;resultbox&quot;, $params, &quot;ld&quot;);
	}
	
	/**
	 * Renders the Dacura Quality Service Control screen 
	 * @param string $graph the name of the graph that it is being applied to 
	 * @param array $set_tests an array of the ids of the dqs tests that are available
	 */
	public function showDQSControls($graph, $set_tests){
		$params = array(&quot;graph&quot; =&gt; $graph, &quot;tests&quot; =&gt; $set_tests);
		$this-&gt;renderScreen(&quot;dqs&quot;, $params, &quot;ld&quot;);		
	}

	/**
	 * Generates the HTML for a service's breadcrumb tabs
	 * @param array $xcrumbs an array of extra breadcrumbs to add to the regular service ones
	 * @param string $append a string (non linked) to be added at the end of the breadcrumb list
	 * @param string $top_level the label on the top level breadcrumb (leave blank to omit top level)
	 * @param string $collection a string that is appended to the collection breadcrumb label (e.g. &quot;users&quot;)
	 * @return string html breadcrumbs (in a html ul element)
	 */
	function getBreadCrumbsHTML($link_overrides = false){
		$paths = $this-&gt;getBreadcrumbsPaths($link_overrides);
		$html = &quot;&lt;ul class='service-breadcrumbs'&gt;&quot;;
		$z = 20;
		$tot = 0;
		foreach($paths as $i =&gt; $path){
			$n = $z--;
			$tot++;
			if($i == 0){
				$html .= &quot;&lt;li class='first'&gt;&lt;a href='&quot;.$path['url'].&quot;' style='z-index:$n;'&gt;&lt;span&gt;&lt;/span&gt;&quot;.$path['title'].&quot;&lt;/a&gt;&lt;/li&gt;&quot;;
			}
			else {
				$html .= &quot;&lt;li&gt;&lt;a href='&quot;.$path['url'].&quot;' style='z-index:$n;'&gt;&quot;.$path['title'].&quot;&lt;/a&gt;&lt;/li&gt;&quot;;
			}
		}
		$html .= &quot;&lt;/ul&gt;&quot;;
		if($tot &gt; 0){
			$html .= &quot;&lt;script&gt;$('.service-breadcrumbs').css('height', '29px')&lt;/script&gt;&quot;;
		}
		return $html;
	}
	
	/**
	 * Generates the breadcrumbs that return the user to the root context from their current context
	 * @param string $top_level the label on the top level breadcrumb (leave blank to omit top level)
	 * @param string $collection a string that is appended to the collection breadcrumb label (e.g. &quot;users&quot;)
	 * @return array an array where each entry is an associative array with 'url' &amp; 'title' parameters
	 */
	protected function getBreadcrumbsPaths(){
		$path = array();
		$stitle = $this-&gt;getServiceSetting(&quot;service-title&quot;);
		if(!$stitle) $stitle = ucfirst($this-&gt;servicename).&quot; service&quot;;
		if($this-&gt;cid() != &quot;all&quot;){
			$ctitle = $this-&gt;settings['name'];
			$path[] = array(&quot;url&quot; =&gt; $this-&gt;durl().$this-&gt;cid(), &quot;title&quot; =&gt; $ctitle);
			$path[] = array(&quot;url&quot; =&gt; $this-&gt;durl().$this-&gt;cid().&quot;/&quot;.$this-&gt;servicename, &quot;title&quot; =&gt; $stitle);
		}
		else {
			$path[] = array(&quot;url&quot; =&gt; $this-&gt;durl(), &quot;title&quot; =&gt; &quot;Dacura Platform&quot;);
			$path[] = array(&quot;url&quot; =&gt; $this-&gt;durl().&quot;/&quot;.$this-&gt;servicename, &quot;title&quot; =&gt; $stitle);				
		}
		return $path;
	}

	/**
	 * Produces html for a given confirugation of table rows 
	 * @param string $tid the html id of the table
	 * @param string $ttype the type of table being shown one of DacuraForm::type
	 * @param array&lt;rows&gt; $fields an array of filed configuration rows (name value pairs)
 	 */
	function getInputTableHTML($tid, $fields, $settings = array()){
		$df = new DacuraForm($tid, $settings);
		if(is_array($fields) &amp;&amp; $df-&gt;addElements($fields)){
			return $df-&gt;html($tid);				
		}
		else {
			return $this-&gt;renderScreenAsString(&quot;errormsg&quot;, array(&quot;title&quot; =&gt; &quot;failed to load dacura table $tid &quot;.$df-&gt;errcode, &quot;message&quot; =&gt; $df-&gt;errmsg), &quot;core&quot;);
		}
	}

/* functions to get the appropriate urls for stuff */
	
	/**
	 * Gets the url for this service 
	 * @param string $interface html | api (whether the api or webpage is desired
	 * @return string the url
	 */
	function my_url($interface = &quot;html&quot;){
		$api_sign = $this-&gt;getSystemSetting('apistr');
		$api_bit = ($interface ==  $api_sign ? $api_sign .&quot;/&quot; : &quot;&quot;);
		$ext = $this-&gt;cid() == &quot;all&quot; ? &quot;&quot; : $this-&gt;cid().&quot;/&quot;;
		return $this-&gt;durl().$api_bit.$ext.$this-&gt;name();
	}
	
	/**
	 * Returns the URL for accessing a service
	 * @param string $servicen the name of the service (if omitted, the current service is used)
	 * @param array $args the arguments to be passed as url parameters
	 * @param string $interface html | api
	 * @param string $col_id collection id
	 * @return string the url to the service
	 */
	function get_service_url($servicen = false, $args = array(), $interface=&quot;html&quot;, $col_id = false){
		$args_ext = (count($args) &gt; 0) ? &quot;/&quot;.implode(&quot;/&quot;, $args) : &quot;&quot;;
		$servicen = ($servicen ? $servicen : $this-&gt;servicename);
		if($servicen == 'login'){
			return $this-&gt;durl().&quot;login&quot;.$args_ext;
		}
		else {
			$api_bit = ($interface == $this-&gt;getSystemSetting('apistr') ? $this-&gt;getSystemSetting('apistr') .&quot;/&quot; : &quot;&quot;);
			$col_id = $col_id ? $col_id : $this-&gt;cid();
			if($col_id == &quot;all&quot;){
				$col_bit = &quot;&quot;;
			}
			else {
				$col_bit = $col_id .&quot;/&quot;;
			}
			return $this-&gt;durl().$api_bit.$col_bit.$servicen.$args_ext;
		}
	}
	
	/**
	 * Get the URL of a particular file
	 * @param string $type [service, collection, script, image, css, js]
	 * @param string $name filename
	 * @param string $cid collection id if type = service|collection|script
	 * @return string the file url
	 */
	function furl($type, $name, $cid = false){
		if($type == 'service'){
			return $this-&gt;get_service_file_url($name, $cid);
		}
		elseif($type == &quot;collection&quot;){
			return $this-&gt;get_cds_url($name, $cid);
		}
		elseif($type == &quot;script&quot;){
			return $this-&gt;get_service_script_url($name, $cid);
		}
		else return $this-&gt;get_system_file_url($type, $name);
	}
	
	/**
	 * URL of a file that is associated with a particular collection
	 * @param string $fname filename
	 * @param string $col_id collection id
	 * @return string url
	 */
	function get_cds_url($fname, $col_id = false){
		$col_bit = ($col_id ? $col_id : $this-&gt;cid()).&quot;/&quot;;
		return $this-&gt;getSystemSetting(&quot;collections_urlbase&quot;).$col_bit.$fname;
	}
	
	/**
	 * URL of a file that is associated with a particular service
	 * @param string $fname filename
	 * @param string $servicen service name
	 * @return string url
	 */
	function get_service_file_url($fname, $servicen = false){
		$servicen = ($servicen ? $servicen : $this-&gt;name());
		$durl = $this-&gt;getSystemSetting(&quot;services_url&quot;);
		return $durl.$servicen.&quot;/files/&quot;.$fname;
	}
	
	/**
	 * Get the URL of a script associated with a particular service
	 * @param string $fname the script name
	 * @param string $servicen the service name
	 * @return string url
	 */
	function get_service_script_url($fname, $servicen = false){
		$servicen = ($servicen ? $servicen : $this-&gt;name());
		$durl = $this-&gt;getSystemSetting(&quot;services_url&quot;);
		return $durl.$servicen.&quot;/&quot;.$fname;
	}
	
	/**
	 * System files are dacura media (css, image, js, etc)
	 * @param string $type (css, image, js)
	 * @param unknown $name
	 * @return string
	 */
	function get_system_file_url($type, $name){
		$fu = $this-&gt;getSystemSetting(&quot;files_url&quot;);
		if($type == &quot;js&quot; || $type == &quot;css&quot;){
			$ext_bit = $fu.$type.&quot;/&quot;;
		}
		elseif($type == &quot;master&quot;){
			return $fu.&quot;master.css&quot;;
		}
		else {
			$ext_bit = $fu.&quot;images/&quot;;
		}
		return $ext_bit.$name;
	}
}
</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>