<html>
    <head>
        <script
            type="text/javascript"
            src="../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
/**
 * Class responsible for interacting with the Dacura SQL database. 
 * 
 * This and the classes that extend it is the one and only place where SQL interactions are kept 
 * * Creation Date: 20/11/2014
 * 
 * @author chekov
 * @license GPL v2
 */
class DBManager extends DacuraController {
	/** @var PDO the PHP Data Object that stores the connection to the database */
	var $link;
	/** @var an array of clauses that are added to the where clause of all select statements */
	var $extra_wheres = array();//a portion of sql that will be added to every where clause.
		
	/**
	 * Creates a connectoin to the Mysql database
	 * @param string $h hostname
	 * @param string $u username
	 * @param string $p password
	 * @param string $n database name
	 * @param array $config array of configuration variables (e.g. include_deleted)
	 */
	function connect($h, $u, $p, $n, $config = false){
		$dsn = &quot;mysql:host=$h;dbname=$n;charset=utf8&quot;;
		$this-&gt;link = new PDO($dsn, $u, $p, array(PDO::ATTR_ERRMODE =&gt; PDO::ERRMODE_WARNING));
		if(!($config &amp;&amp; isset($config['include_deleted']) &amp;&amp; $config['include_deleted'])){
			$this-&gt;extra_wheres['deleted.status'] = &quot;TABLE.status != 'deleted'&quot;;			
		}
	}
	
	/**
	 * Has this object connected to the DB
	 * @return PDO
	 */
	function hasLink(){
		return $this-&gt;link;
	}
	
	/**
	 * Embellish the where clause by adding further clauses
	 * @param boolean $is_only true if there are no other where sub-clauses
	 * @param string $table if is set this table name will be added to the name of columns 
	 * Supports situation where there are columns in the select with the same name and different tables
	 * @return string the extra where clause
	 */
	function where($is_only = false, $table = &quot;&quot;){
		$first = true;
		$clause = &quot;&quot;;
		foreach($this-&gt;extra_wheres as $id =&gt; $ew){
			if($is_only &amp;&amp; $first){
				$clause .= &quot; WHERE &quot;;
			}
			else {
				$clause .= &quot; AND &quot;;
			}
			$clause .= str_replace(&quot;TABLE.&quot;, $table, $ew);
			$first = false;
		}
		return $clause;
	}
	
	/* Collection Config related functions */
	
	/**
	 * Does the collection with the given id exist?
	 * @param string $id
	 * @return boolean
	 */
	function hasCollection($id){
		try {
			$stmt = $this-&gt;link-&gt;prepare(&quot;SELECT * FROM collections where collection_id=?&quot;.$this-&gt;where());
			$stmt-&gt;execute(array($id));
			if($stmt-&gt;rowCount()) {
				return true;
			}
			return false;
		}
		catch(PDOException $e){
			return $this-&gt;failure_result(&quot;Error retrieving collection $id &quot; .$e-&gt;getMessage(), 500);
		}
	}

	/**
	 * Get the collection object from db
	 * @param string $id collection id
	 * @return Collection
	 */
	function getCollection($id){
		try {
			$stmt = $this-&gt;link-&gt;prepare(&quot;SELECT collection_id, collection_name, status, contents FROM collections where collection_id=?&quot;.$this-&gt;where());
			$stmt-&gt;execute(array($id));
			if($stmt-&gt;rowCount()) {
				$row = $stmt-&gt;fetch();
				if(!$row || !$row['collection_id']){
					return $this-&gt;failure_result(&quot;Error in collection data $id &quot;, 500);
				}
				$x = new Collection($row['collection_id'], $row['collection_name'], json_decode($row['contents'], true), $row['status']);
				return $x;
			}
			return $this-&gt;failure_result(&quot;Collection $id does not exist&quot;, 404);
		}
		catch(PDOException $e){
			return $this-&gt;failure_result(&quot;Error retrieving collection $id &quot;.$e-&gt;getMessage(), 500);
		}
	}
	
	/**
	 * Returns the list of all collections in the system
	 * @return array&lt;string:Collection&gt; array of collections, indexed by their ids
	 */
	function getCollectionList(){
		try {
			$cols = array();
			$stmt = $this-&gt;link-&gt;prepare(&quot;SELECT collection_id, collection_name, status, contents FROM collections&quot;.$this-&gt;where(true));
			$stmt-&gt;execute(array());
			if($stmt-&gt;rowCount()) {
				while($row = $stmt-&gt;fetch(PDO::FETCH_ASSOC)){
					if(!$row || !$row['collection_id']){
						return $this-&gt;failure_result(&quot;Error in collection list&quot;, 500);
					}
					$x = new Collection($row['collection_id'], $row['collection_name'], json_decode($row['contents']), $row['status']);
					$cols[$row['collection_id']] = $x;
				}
				return $cols;
			}
			return $this-&gt;failure_result(&quot;No Collections found in list&quot;, 500);
		}
		catch(PDOException $e){
			return $this-&gt;failure_result(&quot;Error retrieving collection list &quot;.$e-&gt;getMessage(), 500);
		}
	}

	/**
	 * Update the stored version of a collection
	 * @param string $id collection id
	 * @param string $name collection title
	 * @param string $status one of @see DacuraObject::valid_statuses
	 * @param array $new_obj the contents of the collection object (name-value array)
	 * @return boolean|Collection the updated collection id, or false if failure
	 */
	function updateCollection($id, $name = false, $status = false, $new_obj = false) {
		if(!$this-&gt;hasCollection($id)){
			return $this-&gt;failure_result(&quot;update collection - Collection with ID $id does not exist&quot;, 500);
		}
		$params = array();
		if($name !== false){
			$params['collection_name'] = $name;
		}
		if($status){
			$params['status'] = $status;
		}
		if($new_obj !== false){
			$params['contents'] = json_encode($new_obj);
		}
		if(count($params) == 0){
			return $this-&gt;failure_result(&quot;Update must change something: collection $id is unchanged&quot;, 400);
		}
		$sql = &quot;UPDATE collections SET &quot;.implode(&quot;=?, &quot;, array_keys($params)).&quot;=? WHERE collection_id=?&quot;;	
		$vals = array_values($params);
		$vals[] = $id;	
		try {
			$stmt = $this-&gt;link-&gt;prepare($sql);
			$res = $stmt-&gt;execute($vals);
			return $this-&gt;getCollection($id);
		}
		catch(PDOException $e){
			return $this-&gt;failure_result(&quot;Error updating collection $id &quot;.$e-&gt;getMessage(), 500);
		}
	}
	
	/**
	 * Deletes a collection (sets its status to deleted, does not actually delete it)
	 * @param string $id
	 * @return boolean true if successful
	 */
	function deleteCollection($id) {
		if(!$this-&gt;hasCollection($id)){
			return $this-&gt;failure_result(&quot;Collection with ID $id does not exist&quot;, 404);
		}
		try {
			$stmt = $this-&gt;link-&gt;prepare(&quot;UPDATE collections SET status = 'deleted' WHERE collection_id=?&quot;);
			$res = $stmt-&gt;execute(array($id));
			return true;
		}
		catch(PDOException $e){
			return $this-&gt;failure_result(&quot;error deleting collection $id&quot; . $e-&gt;getMessage(), 500);
		}
	}
	
	/**
	 * Creates a new collection in the system
	 * @param string $id collection id
	 * @param string $title collection title
	 * @param array $obj configuration name-value array
	 * @param string $status dacura status code @see DacuraObject::valid_statuses
	 * @return boolean|Collection
	 */
	function createNewCollection($id, $title, $obj, $status = &quot;accept&quot;){
		if($this-&gt;hasCollection($id)){
			return $this-&gt;failure_result(&quot;Collection with ID $id already exists&quot;, 400);
		}
		try {
			$stmt = $this-&gt;link-&gt;prepare(&quot;INSERT INTO collections VALUES(?, ?, ?, ?)&quot;);
			$conf = (is_array($obj) &amp;&amp; count($obj) &gt; 0) ? json_encode($obj) : &quot;{}&quot;;
			$res = $stmt-&gt;execute(array($id, $title, $conf, $status));
			$col = new Collection($id, $title, $obj, $status);
			return $col;
		}
		catch(PDOException $e){
			return $this-&gt;failure_result(&quot;error retrieving $email &quot; . $e-&gt;getMessage(), 500);
		}
	}
	
	/**
	 * When we create a new collection we also need to create its default (main) graph
	 * @param string $id collection id
	 * @return boolean true if successful
	 */
	function createCollectionInitialEntities($id){
		try {
			$stmt = $this-&gt;link-&gt;prepare(&quot;INSERT INTO ld_entities
				(id, collectionid, type, version, contents, meta, status, createtime, modtime)
				VALUES('main', '$id', 'graph', 1, ?, ?, 'pending', ?, ?)&quot;);
			$ld = json_encode(array(&quot;main&quot; =&gt; array()));
			if(!$ld){
				return $this-&gt;failure_result(&quot;JSON encoding error: &quot;.json_last_error() . &quot; &quot; . json_last_error_msg(), 500);
			}
			$meta = json_encode(array(&quot;status&quot; =&gt; &quot;pending&quot;));
			if(!$meta){
				return $this-&gt;failure_result(&quot;JSON encoding error: &quot;.json_last_error() . &quot; &quot; . json_last_error_msg(), 500);
			}
			$params = array($ld, $meta, time(), time());
			$res = $stmt-&gt;execute($params);
			return true;
		}
		catch(PDOException $e){
			return $this-&gt;failure_result(&quot;PDO Error&quot;.$e-&gt;getMessage(), 500);
		}
	}
	
/* User management functions */	
	
	/**
	 * Get the list of users who have roles in the given collection context
	 * @param string[] $cids an array of collection ids
	 * @return string[] an array of user ids of users who have roles in the collections
	 */
	function getUsersInContext(array $cids){
		try {
			$uids = array();
			$sql = &quot;SELECT distinct userid AS uid from user_roles&quot;;
			if(count($cids) &gt; 0){
				$inQuery = implode(',', array_fill(0, count($cids), '?'));
				$stmt = $this-&gt;link-&gt;prepare($sql. &quot; WHERE collectionid IN($inQuery)&quot;);
				$stmt-&gt;execute($cids);
				$uids = $stmt-&gt;fetchAll(PDO::FETCH_COLUMN);
			}
			$users = array();
			foreach($uids as $uid){
				$u = $this-&gt;loadUser($uid);
				if($u){
					$users[$uid] = $u;
				}				
			}
			return $users;
		}
		catch(PDOException $e){
			return $this-&gt;failure_result(&quot;error getting users &quot;.$e-&gt;getMessage(), 500);
		}
	}
	
	/**
	 * Does a user with the given email exist?
	 * @param string $email
	 * @return boolean
	 */	
	function hasUser($email){
		try {
			$stmt = $this-&gt;link-&gt;prepare(&quot;SELECT * FROM users where email=?&quot;.$this-&gt;where());
			$stmt-&gt;execute(array($email));
			if($stmt-&gt;rowCount()) {
				return true;
			}
			return false;
		}
		catch(PDOException $e){
			return $this-&gt;failure_result(&quot;Error searching for user $email&quot; . $e-&gt;getMessage(), 500);
		}
	}
	
	/**
	 * Load a user object 
	 * @param string $id user id
	 * @return boolean|DacuraUser
	 */
	function loadUser($id){
		try {
			$stmt = $this-&gt;link-&gt;prepare(&quot;SELECT name, email, status, profile FROM users where id=?&quot;.$this-&gt;where());
			$stmt-&gt;execute(array($id));
			$row = $stmt-&gt;fetch();
			if(!$row){
				return $this-&gt;failure_result(&quot;User with id $id does not exist in this system&quot;, 404);
			}
			$prof = json_decode($row['profile'], true);
			if($prof === NULL){
				return $this-&gt;failure_result(&quot;Failed to parse profile JSON of user $id&quot;, 500);
			}
			$du = new DacuraUser($id, $row['email'], $row['name'], $row['status'], $prof);
			$roles = $this-&gt;loadUserRoles($id);
			if($roles === false){
				return false;
			}
			$du-&gt;roles = $roles;
			return $du;
	
		}
		catch(PDOException $e){
			return $this-&gt;failure_result(&quot;Error loading user $id &quot; . $e-&gt;getMessage(), 500);
		}
	}
	
	/**
	 * Loads the full list of users in the system
	 * @return array&lt;string:DacuraUser&gt; an array of users indexed by their ids
	 */
	function loadUsers(){
		$users = array();
		try {
			$stmt = $this-&gt;link-&gt;prepare(&quot;SELECT id FROM users&quot;.$this-&gt;where(true));
			$stmt-&gt;execute(array());
			while($row = $stmt-&gt;fetch(PDO::FETCH_ASSOC)){
				$u = $this-&gt;loadUser($row['id']);
				if($u){
					$users[$row['id']] = $u;
				}
			}
			return $users;
		}
		catch(PDOException $e){
			return $this-&gt;failure_result(&quot;Error loading user list&quot; . $e-&gt;getMessage(), 500);
		}
	}
	
	/**
	 * Load the roles for the given user
	 * @param string $id
	 * @return UserRole[] an array of roles 
	 */
	function loadUserRoles($id){
		try {
			$stmt = $this-&gt;link-&gt;prepare(&quot;SELECT roleid, collectionid, role FROM user_roles where userid=?&quot;);
			$stmt-&gt;execute(array($id));
			$roles = array();
			while($row = $stmt-&gt;fetch(PDO::FETCH_ASSOC)){
				$roles[] = new UserRole($row['roleid'], $row['collectionid'], $row['role']);
			}
			return $roles;
		}
		catch(PDOException $e){
			return $this-&gt;failure_result(&quot;Error loading roles for user $id &quot; . $e-&gt;getMessage(), 500);
		}
	}	
	
	/**
	 * Save user to db
	 * @param DacuraUser $u
	 * @return boolean true on success
	 */
	function saveUser(DacuraUser $u){
		try {
			$stmt = $this-&gt;link-&gt;prepare(&quot;UPDATE users set name=?, email=?, status=?, profile=? where id=?&quot;);
			$stmt-&gt;execute(array($u-&gt;name, $u-&gt;email, $u-&gt;status, json_encode($u-&gt;profile), $u-&gt;id));
			return true;
		}
		catch(PDOException $e){
			return $this-&gt;failure_result(&quot;Error saving $u-&gt;handle &quot; . $e-&gt;getMessage(), 500);
		}
	}
	
	/**
	 * Saves a user's roles to db
	 * 
	 * Deletes all existing roles in DB and creates new roles for each role in user object
	 * @param DacuraUser $u
	 * @return boolean true on success
	 */
	function updateUserRoles(DacuraUser &amp;$u){
		try {
			$stmt = $this-&gt;link-&gt;prepare(&quot;DELETE FROM user_roles where userid=?&quot;);
			$stmt-&gt;execute(array($u-&gt;id));
			foreach($u-&gt;roles as $r){
				$stmt = $this-&gt;link-&gt;prepare(&quot;INSERT INTO user_roles VALUES(0, ?, ?, ?)&quot;);
				$stmt-&gt;execute(array($u-&gt;id, $r-&gt;role, $r-&gt;collection_id));
			}
			return true;
		}
		catch(PDOException $e){
			return $this-&gt;failure_result(&quot;Error updating roles for user $u-&gt;email &quot; . $e-&gt;getMessage(), 500);
		}
	}
	
	/**
	 * Deletes a specific role 
	 * @param number $rid the role id
	 * @return boolean true on success
	 */
	function deleteRole($rid){
		try {
			$stmt = $this-&gt;link-&gt;prepare(&quot;DELETE FROM user_roles where roleid=?&quot;);
			$stmt-&gt;execute(array($rid));
			return true;
		}
		catch(PDOException $e){
			return $this-&gt;failure_result(&quot;Error updating roles for user $u-&gt;email &quot; . $e-&gt;getMessage(), 500);
		}
	}
	
	/**
	 * Loads a user with a given email address
	 * @param string $email
	 * @return boolean|DacuraUser the user object
	 */
	function loadUserByEmail($email){
		try {
			$stmt = $this-&gt;link-&gt;prepare(&quot;SELECT id, name, status, profile FROM users where email=?&quot;.$this-&gt;where());
			$stmt-&gt;execute(array($email));
			$row = $stmt-&gt;fetch();
			if(!$row || !$row['id']){
				return $this-&gt;failure_result(&quot;Error loading user: User with email $email does not exist in this system&quot;, 404);
			}
			$du = new DacuraUser($row['id'], $email, $row['name'], $row['status'], json_decode($row['profile'], true));
			$roles = $this-&gt;loadUserRoles($row['id']);
			if($roles === false){ return false; }
			$du-&gt;roles = $roles;
			return $du;
		}
		catch(PDOException $e){
			return $this-&gt;failure_result(&quot;Error loading user $email  &quot; . $e-&gt;getMessage(), 500);
		}
	}
	
	/**
	 * Creates a new Dacura User in DB
	 * @param string $email users email address
	 * @param string $name user handle
	 * @param string $p password 
	 * @param string $status status @see DacuraObject::valid_statuses
	 * @param string $prof jsonified string of user profile
	 * @return boolean|DacuraUser the new user object
	 */
	function addUser($email, $name, $p, $status, $prof = &quot;{}&quot;){
		if($email &amp;&amp; $this-&gt;hasUser($email)){
			return $this-&gt;failure_result(&quot;Cannot add user: User with email $email already exists&quot;, 400);
		}
		else {
			try {
				$stmt = $this-&gt;link-&gt;prepare(&quot;INSERT INTO users VALUES(0, ?, ?, PASSWORD(?), ?, ?)&quot;);
				$res = $stmt-&gt;execute(array($email, $name, $p, $status, $prof));
				$id = $this-&gt;link-&gt;lastInsertId();
				$du = new DacuraUser($id, $email, $name, $status, json_decode($prof, true));
				return $du;
			}
			catch(PDOException $e){
				return $this-&gt;failure_result(&quot;Error adding user $email  &quot; . $e-&gt;getMessage(), 500);
			}
		}
	}
	
	/**
	 * Updates a user's password in the DB
	 * @param number $uid user id
	 * @param string $p password
	 * @param boolean $purge if true, all existing confirm codes for user will be purged from DB
	 * @return boolean true if success
	 */
	function updatePassword($uid, $p, $purge = false){
		try {
			if($purge){
				$stmt = $this-&gt;link-&gt;prepare(&quot;DELETE FROM user_confirms WHERE type='lost' AND uid=?&quot;);
				$stmt-&gt;execute(array($uid));
			}
			$stmt = $this-&gt;link-&gt;prepare(&quot;UPDATE users set password=PASSWORD(?) WHERE id=?&quot;);
			$res = $stmt-&gt;execute(array($p, $uid));
			return true;
		}
		catch(PDOException $e){
			return $this-&gt;failure_result(&quot;PDO Error&quot;.$e-&gt;getMessage(), 500);
		}
	}
	
	/**
	 * Tests username and password to see if a login is valid
	 * @param string $email
	 * @param string $pword
	 * @return boolean|DacuraUser user object or false if failure
	 */
	function testLogin($email, $pword){
		try {
			$stmt = $this-&gt;link-&gt;prepare(&quot;SELECT id, name, status, profile FROM users where email=? AND password=PASSWORD(?)&quot;);
			$stmt-&gt;execute(array($email, $pword));
			$row = $stmt-&gt;fetch();
			if(!$row || !$row['id']){
				return $this-&gt;failure_result(&quot;Incorrect Username / Password combination&quot;, 401);
			}
			if($row['status'] == &quot;unconfirmed&quot;){
				return $this-&gt;failure_result(&quot;User $email has been registered but has not yet confirmed their email address.&quot;, 400);
			}
			$du = new DacuraUser($row['id'], $email, $row['name'], $row['status'], json_decode($row['profile'], true));
			$roles = $this-&gt;loadUserRoles($row['id']);
			if($roles === false){ return false; }				
			$du-&gt;roles = $roles;
			return $du;
	
		}
		catch(PDOException $e){
			return $this-&gt;failure_result(&quot;Error logging in $email &quot; .$e-&gt;getMessage(), 500);
		}
	}
	
	/**
	 * Generates a new confirm code for the user and stores it in the DB
	 * @param number $uid the user id
	 * @param string $type the type of the confirm (invite, register, lost)
	 * @param boolean $purge if set to true all existing confirm codes will be deleted
	 * @return string|boolean the confirm code or false if failure
	 */
	function generateUserConfirmCode($uid, $type, $purge = false){
		try {
			if($purge){
				$stmt = $this-&gt;link-&gt;prepare(&quot;DELETE FROM user_confirms WHERE type=? AND uid=?&quot;);
				$stmt-&gt;execute(array($type, $uid));
			}
			$code = createRandomKey(50);
			$stmt = $this-&gt;link-&gt;prepare(&quot;INSERT INTO user_confirms VALUES(0, ?, ?, ?, NOW())&quot;);
			$res = $stmt-&gt;execute(array($uid, $type, $code));
			return $code;
		}
		catch(PDOException $e){
			return $this-&gt;failure_result(&quot;Error generate user confirm code &quot; . $e-&gt;getMessage(), 500);
		}
	}
	
	/**
	 * Retrieve the user id associated with a given confirm code
	 * 
	 * Used to ensure that the confirmation comes from the correct user
	 * @param string $code the confirm code
	 * @param string $type the type of the confirm (invite, register, lost)
	 * @param number $tlimit the time limit that applies to this confirm code - older confirm codes are ignored
	 * @return number|boolean the id of the user or false if the code does not exist
	 */
	function getConfirmCodeUid($code, $type, $tlimit = 0){
		try {
			$stmt = $this-&gt;link-&gt;prepare(&quot;SELECT uid FROM user_confirms where code=? AND type=? AND issued &gt; ?&quot;);
			$stmt-&gt;execute(array($code, $type, $tlimit));
			if($stmt-&gt;rowCount()) {
				$row = $stmt-&gt;fetch();
				return $row['uid'];
			}
			return $this-&gt;failure_result(&quot;The confirmation code in the link is invalid&quot;, 404);
		}
		catch(PDOException $e){
			return $this-&gt;failure_result(&quot;Error getting user confirm code &quot; . $e-&gt;getMessage(), 500);
		}
	}
	
	/**
	 * Get the confirm code associated with a user and type from the db
	 * @param number $uid user id
	 * @param string $type the type of the confirm (invite, register, lost)
	 * @param number $tlimit the time limit that applies to this confirm code - older confirm codes are ignored
	 * @return string|boolean the confirm code or false if it does not exist
	 */
	function getUserConfirmCode($uid, $type, $tlimit = 0){
		try {
			$stmt = $this-&gt;link-&gt;prepare(&quot;SELECT code FROM user_confirms where uid=? AND type=? AND issued &gt; ?&quot;);
			$stmt-&gt;execute(array($uid, $type, $tlimit));
			if($stmt-&gt;rowCount()) {
				$row = $stmt-&gt;fetch();
				return $row['code'];
			}
			return $this-&gt;failure_result(&quot;No valid confirmation code entry found for $type $uid&quot;, 404);
		}
		catch(PDOException $e){
			return $this-&gt;failure_result(&quot;Error getting user confirm code for user $uid &quot; . $e-&gt;getMessage(), 500);
		}
	}
}</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>