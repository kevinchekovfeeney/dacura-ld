<html>
    <head>
        <script
            type="text/javascript"
            src="../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php 
/**
 * Class representing an element within a user-interface form
 *
 * Creation Date: 15/11/2015
 * @author Chekov
 * @license GPL V2
 */
class DacuraFormElement extends DacuraObject {
	/** @var string[] the list of valid types of form element */
	private static $valid_types = array(&quot;text&quot;, &quot;url&quot;, &quot;image&quot;, &quot;password&quot;, &quot;boolean&quot;, &quot;choice&quot;, &quot;status&quot;, &quot;section&quot;, &quot;email&quot;, &quot;complex&quot;);
	/** @var string[] the list of valid input types of form element */
	private static $valid_input_types = array(&quot;input&quot;, &quot;select&quot;, &quot;radio&quot;, &quot;textarea&quot;, &quot;checkbox&quot;, &quot;password&quot;, &quot;custom&quot;);
	/** @var string[] the list of valid sizes of form elements */
	private static $valid_element_sizes = array(&quot;long&quot;, &quot;regular&quot;, &quot;short&quot;, &quot;tiny&quot;);
	/** @var string[] the list of valid display types of forms and form elements */
	private static $valid_display_types = array(&quot;view&quot;, &quot;update&quot;, &quot;create&quot;);
	/** @var string the element type - must be one of DacuraFormElement::$valid_types */
	var $type; 
	/** @var string the input html element associated with this element type. must be one of DacuraFormElement::$valid_input_types */
	var $input_type; 
	/** @var string the size of the ui element must be one of DacuraFormElement::$valid_element_sizes */
	var $element_size; 
	/** @var string the display type of the element must be one of DacuraFormElement::$valid_display_types */
	var $display_type;
	/** @var string a human readable label */
	var $label;
	/** @var string passage of text to help the user in undertstanding this element */
	var $help;
	/** @var mixed The value of the input element */
	var $value;
	/** @var mixed The default value (if any) of the input element */
	var $default_value;
	/** @var boolean if true, the input element is disabled */
	var $update_disabled;
	/** @var boolean if true, the element is hidden */
	var $hidden;
	/** @var boolean if true, the element can be submitted independently of the form */
	var $options;
	/** @var array associative name value array of state for complex fields */
	var $complex; 
	/** @var DacuraForm containing the sub-elements of this element (e.g. for elements of type &quot;section&quot; */
	var $subfields;
	/** @var array associative name value field of meta-data about this form field */
	var $meta = array();

	/**
	 * Loads the form element from an associative name-value array of settings 
	 * 
	 * The settings are generally specified in service settings files
	 * @param array $row an associative array with fields for:
	 * [label, hidden, length, value, default_value, submit, disabled, type, id, options, input_type, fields]
	 * @param string $type one of DacuraFormElement::$valid_display_types
	 * @return boolean
	 */
	function load(array $row, $settings){
		if(!isset($row['id'])){
			return $this-&gt;failure_result(&quot;Dacura form elements must have a form id associated&quot;, 400);
		}
		$this-&gt;label = isset($row['label']) ? $row['label'] : false;
		$this-&gt;hidden = isset($row['hidden']) || isset($settings['hidden']) ? true : false;
		$this-&gt;element_size = isset($row['length']) ? $row['length'] : 'regular';
		$this-&gt;default_value = isset($row['default_value']) ? $row['default_value'] : &quot;&quot;;
		$this-&gt;value = isset($row['value'])  ? $row['value'] : $this-&gt;default_value;
		$this-&gt;update_disabled = isset($row['disabled']) || isset($settings['disabled'])? true : false;
		$this-&gt;help = isset($row['help']) ? $row['help'] : &quot;&quot;;
		$this-&gt;options = isset($row['options']) ? $row['options'] : array();
		$this-&gt;id = $row['id'];
		$this-&gt;type = isset($row['type']) ? $row['type'] : 'text';
		if(isset($row['selected'])){
			$this-&gt;selected = $row['selected'];
		}
		if(isset($row['input_type'])){
			$this-&gt;input_type = $row['input_type'];
		}
		elseif(is_array($this-&gt;value)){
			$this-&gt;input_type = &quot;textarea&quot;;
		}
		elseif($this-&gt;type == 'password'){
			$this-&gt;input_type = &quot;password&quot;;
		}
		elseif($this-&gt;type == 'status'){
			$this-&gt;options = DacuraObject::$valid_statuses;
			$this-&gt;input_type = &quot;select&quot;;
		}
		elseif($this-&gt;type == 'choice'){
			$this-&gt;input_type = &quot;select&quot;;
		}
		elseif($this-&gt;type == 'boolean'){
			$this-&gt;input_type = &quot;checkbox&quot;;
		}
		else {
			$this-&gt;input_type = &quot;input&quot;;
		}
		if($this-&gt;type == &quot;section&quot;){
			$this-&gt;input_type = &quot;section&quot;;
			//subforms inherit disabled and hidden from parent forms
			if($this-&gt;update_disabled){
				if(isset($settings['disabled_view']) &amp;&amp; $settings['disabled_view'] == &quot;form&quot;){
					$settings['disabled'] = true;	
				}
				else {
					$settings['display_type'] = &quot;view&quot;;
				}
				if($this-&gt;hidden){
					$settings['hidden'] = true;
				}
			}
			$this-&gt;subfields = new DacuraForm($this-&gt;id, $settings);
			if(isset($row['fields'])){
				$this-&gt;subfields-&gt;addElements($row['fields']);
			}
		}
		if($this-&gt;type == &quot;complex&quot; &amp;&amp; isset($row['extras'])){
			$this-&gt;complex = $row['extras'];			
		}
		return $this-&gt;hasValidSettings();
	}
	
	/**
	 * Adds a metadata column to the row
	 * @param string $name the name of the metadata variable
	 * @param unknown $val the value of the variable
	 * @param unknown $type the variables type
	 * @param unknown $options the options that are passed into to define the meta-variable
	 */
	function addMeta($name, $val, $type, $options){
		$this-&gt;meta[$name] = array($val, $type, $options);
		if($this-&gt;type == &quot;section&quot;){
			$this-&gt;subfields-&gt;addMetaDataColumn($name, $val, $type, $options);
		}
	}
	
	/**
	 * Sections are special types of form elements that contain lists of form elements
	 * @return boolean true if the element is a section (container) element, false otherwise
	 */
	function isSection(){
		return $this-&gt;type == &quot;section&quot;;
	}
	
	/**
	 * Tests the element to ensure that it has been given valid settings 
	 * 
	 * Just checks that type, input_type, display_type and element_size are among the valid entries defined 
	 * for those type
	 * @return boolean true if valid, false if invalid
	 */
	function hasValidSettings(){
		if(!in_array($this-&gt;type, DacuraFormElement::$valid_types)){
			return $this-&gt;failure_result(&quot;Form element $this-&gt;id has invalid type: $this-&gt;type&quot;, 400);
		}
		if(!in_array($this-&gt;input_type, DacuraFormElement::$valid_input_types) &amp;&amp; $this-&gt;input_type != &quot;section&quot;){
			return $this-&gt;failure_result(&quot;Form element $this-&gt;id has invalid input type: $this-&gt;input_type&quot;, 400);
		}		
		if(!in_array($this-&gt;element_size, DacuraFormElement::$valid_element_sizes)){
			return $this-&gt;failure_result(&quot;Form element $this-&gt;id has invalid element size: $this-&gt;element_size&quot;, 400);
		}			
		return true;
	}
	
	/**
	 * Returns a HTML string as a representation of this form element in table rows
	 * @param object settings name value array of settings from form
	 * @param array context - array of ids of elements that this is embedded inside 
	 * @return string html as a TR element
	 */
	function tr($settings, $context, $rownum, $islast = false){
		$cls_extra = $rownum == 1 ? &quot;first-row row-1&quot; : &quot;row-$rownum&quot;;
		if($islast){
			$cls_extra .= &quot; last-row&quot;;
		}
		$prefix = $context[count($context)-1].&quot;-&quot;;
		if(isset($settings['embedstyle']) &amp;&amp; $settings['embedstyle'] == &quot;flat&quot; &amp;&amp; $this-&gt;isSection() &amp;&amp; count($context) % 2 != 0 &amp;&amp; count($context) != 0){
			$html = &quot;&lt;tr class='dacura-property-spacer'&gt;&lt;/tr&gt;&quot;;
			$html .= &quot;&lt;tr class='dacura-property-section'&gt;&quot;;
			$html .= &quot;&lt;th colspan='2' class='dacura-property-label'&gt;&quot;.$this-&gt;label.&quot; &lt;span class='dacura-property-help'&gt;&quot;.$this-&gt;help.&quot;&lt;/span&gt;&lt;/th&gt;&quot;;
			foreach($this-&gt;meta as $mk =&gt; $mv){
				$html .= &quot;&lt;th class='dacura-property-meta' id='meta-&quot;.$prefix.$this-&gt;id.&quot;-&quot;.$mk.&quot;'&gt;&quot;;
				$html .= $this-&gt;getMetaHTML($mk, $mv, $prefix, $settings);
				$html .= &quot;&lt;/th&gt;&quot;;
			}
			$html .= &quot;&lt;/tr&gt;&quot;;
			$html .= &quot;&lt;tr class='dacura-property dacura-embedded-property $cls_extra' id='row-&quot;.$prefix.$this-&gt;id.&quot;'&gt;&lt;td colspan='&quot;. (2 + count($this-&gt;meta)) . &quot;' class='dacura-embedded-property'&gt;&quot;;
			$html .= $this-&gt;getValueTable($settings, $context);
			$html .= &quot;&lt;/tr&gt;&quot;;	
			$html .= &quot;&lt;tr class='dacura-section-spacer'&gt;&lt;/tr&gt;&quot;;
		}
		else {
			$html = &quot;&quot;;
			if($this-&gt;type == &quot;complex&quot; || $this-&gt;type == &quot;section&quot;){
				$html = &quot;&lt;tr class='dacura-property-spacer'&gt;&lt;/tr&gt;&quot;;
			}
			$html .= &quot;&lt;tr class='dacura-property $cls_extra' id='row-&quot;.$prefix.$this-&gt;id.&quot;'&gt;&quot;;
			$html .= &quot;&lt;td class='dacura-property-label'&gt;&quot;.$this-&gt;label.&quot;&lt;/td&gt;&quot;;
			$html .= &quot;&lt;td class='dacura-property-value'&gt;&quot;;
			$html .= $this-&gt;getValueTable($settings, $context, $this-&gt;help);
			$html .= &quot;&lt;/td&gt;&quot;;
			foreach($this-&gt;meta as $mk =&gt; $mv){
				$html .= &quot;&lt;td class='dacura-property-meta' id='meta-&quot;.$prefix.$this-&gt;id.&quot;-&quot;.$mk.&quot;'&gt;&quot;;
				$html .= $this-&gt;getMetaHTML($mk, $mv, $prefix, $settings);
				$html .= &quot;&lt;/td&gt;&quot;;
			}
			$html .= &quot;&lt;/tr&gt;&quot;;
			if($this-&gt;type == &quot;complex&quot; || $this-&gt;type == &quot;section&quot;){
				$html .= &quot;&lt;tr class='dacura-property-spacer'&gt;&lt;/tr&gt;&quot;;
			}
		}
		return $html;
	}
	
	/**
	 * Generates the html to represent a metadata variable
	 * @param string $mk metadata key - the name of the variable
	 * @param mixed $mv - metadata value - the value of the variable
	 * @param string $prefix - the prefix that is applied to ids in this context
	 * @param array $settings - a settings array that contains various settings for the variable
	 * @return string - the html string
	 */
	function getMetaHTML($mk, $mv, $prefix = &quot;&quot;, $settings = array()){
		$html = &quot;&quot;;
		if(isset($settings['display_type']) &amp;&amp; $settings['display_type'] == &quot;update&quot;){
			$disabled = $this-&gt;update_disabled ? &quot;disabled&quot; : &quot;&quot;;
			$id = $this-&gt;id.&quot;-&quot;.$mk;
			if($mv[1] == &quot;choice&quot;){
				$html = &quot;&lt;select class='property-meta' $disabled id='$prefix&quot;.&quot;$id'&gt;&quot;;
				foreach($mv[2] as $v =&gt; $l){
					if($mv[0] == $v){
						$html .= &quot;&lt;option selected value='$v'&gt;$l&lt;/option&gt;&quot;;						
					}
					else {
						$html .= &quot;&lt;option value='$v'&gt;$l&lt;/option&gt;&quot;;						
					}
				}
				$html .= &quot;&lt;/select&gt;&quot;;
			}
			elseif($mv[1] == &quot;checkbox&quot;){
				$html = &quot;&lt;input class='property-meta' $disabled type='checkbox' id='$prefix&quot;.&quot;$id' &quot;;
				if($mv[0]) $html .= &quot; checked&quot;;
				$html .= &quot;&gt;&quot;;	
			}
			else {
				$html = &quot;&lt;input type='text' id='$prefix&quot;.$this-&gt;id.&quot;-&quot;.$mk.&quot;' value='&quot;.$mv[0].&quot;' $disabled&gt;&quot;;
			}
		}
		elseif(isset($settings['show_meta'])) {
			$html = $mv[0];
		}
		return $html;
	}
	
	/**
	 * Returns a representation of the element's value as a HTML table 
	 * 
	 * The table has css class dacura-property-value-bundle and cells for: 
	 * * the value (css class dacura-property-input)
	 * * a submit cell - when the value can be submitted in isolation (css class: dacura-property-submit)
	 * * a help cell (css class: dacura-property-help)
	 * @param string $display_type one of $DacuraFormElement::$valid_display_types
	 * @return string The TABLE html
	 */
	function getValueTable($settings, $context, $help = false){
		$html = &quot;&lt;table class='dacura-property-value-bundle'&gt;&lt;tr&gt;&quot;;
		$html .= ($this-&gt;display_type == 'view') ? &quot;&lt;td class='dacura-property-display'&gt;&quot; : &quot;&lt;td class='dacura-property-input'&gt;&quot;;
		if(isset($settings['display_type']) &amp;&amp;  $settings['display_type'] == &quot;view&quot;){
			$html .= $this-&gt;getDisplayElementHTML($settings, $context);
		}
		else {
			$html .= $this-&gt;getInputElementHTML($settings, $context);
		}
		$html .= &quot;&lt;/td&gt;&quot;;
		if($help){
			$html .= &quot;&lt;td class='dacura-property-help'&gt;&quot;.$help.&quot;&lt;/td&gt;&quot;;
		}
		$html .= &quot;&lt;/tr&gt;&lt;/table&gt;&quot;;
		return $html;
	}
	
	/**
	 * Generates the HTML to display the element value when display_type = &quot;view&quot;
	 * 
	 * @return string the element HTML 
	 */
	function getDisplayElementHTML($settings, $context){
		$prefix = $context[count($context)-1].&quot;-&quot;;
		if($this-&gt;isSection()){
			$section_id = implode(&quot;-&quot;, $context).&quot;-&quot;.$this-&gt;id;
			$html = $this-&gt;subfields-&gt;html($section_id, $context);
		}
		elseif($this-&gt;type == &quot;complex&quot;){
			return $this-&gt;drawCustomDisplayField($settings, $context);
		}
		elseif(is_array($this-&gt;value)){
			$html = &quot;&lt;div id='$prefix&quot;.&quot;$this-&gt;id' class='dacura-display-json raw-json'&gt;&quot; . json_encode($this-&gt;value, JSON_PRETTY_PRINT).&quot;&lt;/div&gt;&quot;;
		}
		elseif($this-&gt;value === &quot;&quot;){
			$html = &quot;&lt;span id='$prefix&quot;.&quot;$this-&gt;id' class='dacura-display-value'&gt;&lt;/span&gt;&quot;;
		}
		else {
			$prefix = $context[count($context)-1].&quot;-&quot;;
			$v = $this-&gt;value;
			if($this-&gt;type == &quot;image&quot;){
				$html = &quot;&lt;img class='form-display-image' src='$v'&gt;&quot;;
			}
			else {
				if($v === true) $v = &quot;true&quot;;
				if($v === false) $v = &quot;false&quot;;
				else $v = htmlspecialchars($v);
				$html = &quot;&lt;span class='dacura-display-value'&gt;$v&lt;/span&gt;&lt;input id='$prefix&quot;.&quot;$this-&gt;id' type='hidden' value='$v'&gt;&quot;;
			}
		}
		return $html;
	}
	
	/**
	 * Generates the HTML to display the element value when display_type = &quot;update&quot; or &quot;create&quot;
	 *
	 * @return string the element input HTML
	 */
	function getInputElementHTML($settings, $context){
		$prefix = $context[count($context)-1].&quot;-&quot;;
		if($this-&gt;input_type == &quot;custom&quot;){
			return $this-&gt;drawCustomInputField($settings, $context);
		}
		if($this-&gt;isSection()){
			$section_id = implode(&quot;-&quot;, $context).&quot;-&quot;.$this-&gt;id;
			return $this-&gt;subfields-&gt;html($section_id, $context);
		}
		$cls = 'dacura-'.$this-&gt;element_size.'-input';
		$disabled = $this-&gt;update_disabled ? &quot;disabled&quot; : &quot;&quot;;
		if($this-&gt;input_type == &quot;input&quot;){
			$val = htmlspecialchars($this-&gt;value);
			if($this-&gt;type == &quot;image&quot;){
				$html = $this-&gt;drawImageInputField($settings, $context);
			}
			else {
				$html = &quot;&lt;input id=\&quot;$prefix&quot;.&quot;$this-&gt;id\&quot; class=\&quot;$cls\&quot; $disabled type='text' value=\&quot;$val\&quot;&gt;&quot;;				
			}		
		}
		elseif($this-&gt;input_type == &quot;textarea&quot;){
			if(is_array($this-&gt;value)){
				$val = json_encode($this-&gt;value, JSON_PRETTY_PRINT);
				$cls .= &quot; dacura-display-json&quot;;
			}
			else {
				$val = htmlspecialchars($this-&gt;value);
			}			
			$html = &quot;&lt;textarea id=\&quot;$prefix&quot;.&quot;$this-&gt;id\&quot; class=\&quot;$cls\&quot; $disabled&gt;$val&lt;/textarea&gt;&quot;;
		}
		elseif ($this-&gt;input_type == &quot;password&quot;){
			$val = htmlspecialchars($this-&gt;value);
			$html = &quot;&lt;input id=\&quot;$prefix&quot;.&quot;$this-&gt;id\&quot; class=\&quot;$cls\&quot; $disabled type=\&quot;password\&quot; value=\&quot;$val\&quot;/&gt;&quot;;
		}
		elseif( $this-&gt;input_type == &quot;checkbox&quot;){
			$val = $val ? &quot;checked&quot; : &quot;&quot; ;
			$html = &quot;&lt;input id=\&quot;$prefix&quot;.&quot;$this-&gt;id\&quot; class=\&quot;$cls\&quot; $disabled type=\&quot;checkbox\&quot; $val/&gt;&quot;;				
		}		
		elseif($this-&gt;input_type == &quot;select&quot;){
			$html = &quot;&lt;select id=\&quot;$prefix&quot;.&quot;$this-&gt;id\&quot; class=\&quot;dacura-select $cls\&quot; $disabled&gt;&quot;;
			if(isAssoc($this-&gt;options)){
				foreach($this-&gt;options as $v =&gt; $title){
					$selected = ($this-&gt;value &amp;&amp; $this-&gt;value == $v) ? &quot; selected&quot; : &quot;&quot;;
					$val = htmlspecialchars($v);
					$title = htmlspecialchars($title);
					$html .= &quot;&lt;option value=\&quot;$val\&quot; $selected&gt;$title&lt;/option&gt;&quot;;
				}
			}
			else {
				if(isAssoc($this-&gt;options)){
					foreach($this-&gt;options as $k =&gt; $v ){
						$selected = ($this-&gt;value &amp;&amp; $this-&gt;value == $k) ? &quot; selected&quot; : &quot;&quot;;
						$k = htmlspecialchars($k);
						$v = htmlspecialchars($v);
						$html .= &quot;&lt;option value=\&quot;$k\&quot; $selected&gt;$v&lt;/option&gt;&quot;;
					}						
				}
				else {
					foreach($this-&gt;options as $v ){
						$selected = ($this-&gt;value &amp;&amp; $this-&gt;value == $v) ? &quot; selected&quot; : &quot;&quot;;
						$v = htmlspecialchars($v);
						$html .= &quot;&lt;option value=\&quot;$v\&quot; $selected&gt;$v&lt;/option&gt;&quot;;
					}
				}
			}
			$html .= &quot;&lt;/select&gt;&quot;;
		}
		else {
			$html = &quot;&lt;span class='dacura-error'&gt;Value: $this-&gt;value&lt;/span&gt;&quot;;
		}
		return $html;
	}
	
	/**
	 * Draw an image input field - basic text field with a few wrappings 
	 * @param array $settings - the optional settings for the form element
	 * @param array $context - an array with the ids of the parent forms that this element is within
	 * @return string - the html representation of the field
	 */
	function drawImageInputField($settings, $context){
		$val = htmlspecialchars($this-&gt;value);
		$prefix = $context[count($context)-1].&quot;-&quot;;
		$html = &quot;&lt;div class='dacura-image-input'&gt;&quot;;
		$html .= &quot;&lt;span id=\&quot;$prefix&quot;.$this-&gt;id.&quot;-preview\&quot; class='image-input-preview'&gt;&quot;;
		if($this-&gt;update_disabled){
			$html .= &quot;&lt;img id=\&quot;$prefix&quot;.$this-&gt;id.&quot;-img\&quot; class='input-preview-disabled' src='$val'&gt;&quot;;				
		}
		else {
			$html .= &quot;&lt;img id=\&quot;$prefix&quot;.$this-&gt;id.&quot;-img\&quot; class='input-preview' src='$val' title='Click to change the file'&gt;&quot;;
		}
		$html .= &quot;&lt;/span&gt;&quot;;
		$cls = 'dacura-'.$this-&gt;element_size.'-input';
		$disabled = $this-&gt;update_disabled ? &quot;disabled&quot; : &quot;&quot;;
		$html .= &quot;&lt;span class='image-input-text'&gt;&quot;;
		$html .= &quot;&lt;input id=\&quot;$prefix&quot;.&quot;$this-&gt;id\&quot; class=\&quot;$cls image-input\&quot; $disabled type='text' value=\&quot;$val\&quot;&gt;&quot;;
		$html .= &quot;&lt;/span&gt;&lt;/div&gt;&quot;;
		return $html;
	}

	/**
	 * Draw a non-standard field - complex fields with special rules
	 * @param array $settings - the optional settings for the form element
	 * @param array $context - an array with the ids of the parent forms that this element is within
	 * @return string - the html representation of the field
	 */
	function drawCustomInputField($settings, $context){
		if($this-&gt;id == &quot;facets&quot;){
			$html = $this-&gt;drawFacetsInput($settings, $context);	
		}
		else {
			$prefix = $context[count($context)-1].&quot;-&quot;;
			$cls = 'dacura-'.$this-&gt;element_size.'-input';
			$disabled = $this-&gt;update_disabled ? &quot;disabled&quot; : &quot;&quot;;
			if(is_array($this-&gt;value)){
				$val = json_encode($this-&gt;value, JSON_PRETTY_PRINT);
				$cls .= &quot; dacura-display-json&quot;;
			}
			else {
				$val = htmlspecialchars($this-&gt;value);
			}			
			$html = &quot;&lt;textarea id=\&quot;$prefix&quot;.&quot;$this-&gt;id\&quot; class=\&quot;$cls\&quot; $disabled&gt;$val&lt;/textarea&gt;&quot;;
		}
		return $html;
	}
	
	/**
	 * The read only view of the display field
	 * @param array $settings the options for the field
	 * @param array $context - an array with the ids of the parent forms that this element is within
	 * @return string - the html representation of the field
	 */
	function drawCustomDisplayField($settings, $context){
		if(is_array($this-&gt;value)){
			$html = &quot;&lt;div class='dacura-display-json raw-json'&gt;&quot; . json_encode($this-&gt;value, JSON_PRETTY_PRINT).&quot;&lt;/div&gt;&quot;;
		}
		else {
			$html = &quot;Unknown thing to display&quot;;
		}
		return $html;
	}
	
	/**
	 * Generates the html to represent a facet on the facet editing control
	 * @param string $rname the name of the role 
	 * @param string $fname the name of the facet
	 * @param boolean $active if true, the facet has links included
	 * @param string $extra - extra text to be added to the end of the facet button (for added descriptions)
	 * @return string - the html representation
	 */	
	function getFacetButtonHTML($rname, $fname, $active = false, $extra = &quot;&quot;){
		$type = $active ? 'active' : &quot;&quot;;
		$divid = $rname.&quot;-&quot;.$fname.&quot;-&quot;.$this-&gt;id;
		$rtitle = htmlspecialchars(UserRole::$extended_dacura_roles[$rname]);
		$html = &quot;&lt;div class='dacura-facet-button $type' id='$divid'&gt;&quot;;
		$html .= &quot;&lt;span class='dacura-role $rname' title='$rtitle'&gt;&lt;/span&gt;&quot;;
		$html .= &quot;&lt;span class='dacura-role-label'&gt;$rtitle&lt;/span&gt;&quot;;
		$html .= &quot;&lt;span class='facet-text'&gt;$extra&lt;/span&gt;&quot;;
		if($active){
			$html .= &quot;&lt;span class='dacura-facet-action dacura-facet-$active'&gt;&quot;;
			$html .= &quot;&lt;a href='javascript:facet_&quot;.$active.&quot;(\&quot;$divid\&quot;, \&quot;$rname\&quot;, \&quot;$fname\&quot;)' class='dacura-role-$active'&gt;&quot;.ucfirst($active).&quot; Access&lt;/a&gt;&quot;;
			$html .= &quot;&lt;/span&gt;&quot;;
		}
		$html .= &quot;&lt;/div&gt;&quot;;
		return $html;
	}
	
	/**
	 * Draws the form input element to represent facets
	 * @param array $settings the settings options for this element
	 * @param array $context - an array with the ids of the parent forms that this element is within
	 * @return string the html representation of the element
	 */
	function drawFacetsInput($settings, $context){
		$prefix = $context[count($context)-1].&quot;-&quot;;
		if(count($this-&gt;value) == 0){
			$html = &quot;&lt;div class='dacura-facets-listing dacura-empty'&gt;No access currently permitted&lt;/div&gt;&quot;;
		}
		else {
			$html = &quot;&lt;div class='dacura-facets-listing'&gt;&quot;;
			foreach($this-&gt;value as $f){
				$active = (isset($f['default']) ? false : &quot;remove&quot;);
				if(isset($this-&gt;options[$f['facet']])){
					$extra = &quot;Permission to &quot;.$this-&gt;options[$f['facet']];						
					if(isset($f['default'])){
						$extra .= &quot; (default setting)&quot;;
					}
					$html .= $this-&gt;getFacetButtonHTML($f['role'], $f['facet'], $active, $extra);	
				}
				else {
					$extra = &quot;Unknown permission &quot;.$f['facet'];
				}
			}
			$html .= &quot;&lt;/div&gt;&quot;;			
		}
		if($this-&gt;options &amp;&amp; $this-&gt;complex){
			$facetlist = &quot;&lt;select id=\&quot;$prefix.&quot;.$this-&gt;id.&quot;-facets\&quot; class=\&quot;facets\&quot;&gt;&quot;;
			if(isAssoc($this-&gt;options)){
				foreach($this-&gt;options as $k =&gt; $v){
					$facetlist .= &quot;&lt;option value=\&quot;&quot;.htmlspecialchars($k).&quot;\&quot;&gt;&quot;.htmlspecialchars($v).&quot;&lt;/option&gt;&quot;;
				}
			}
			else {
				foreach($this-&gt;options as $v){
					$facetlist .= &quot;&lt;option value=\&quot;&quot;.htmlspecialchars($v).&quot;\&quot;&gt;&quot;.htmlspecialchars($v).&quot;&lt;/option&gt;&quot;;
				}
			}
			$facetlist .= &quot;&lt;/select&gt;&quot;;
			$rhtml = &quot;&lt;select id='$prefix.&quot;.$this-&gt;id.&quot;-roles' class='roles'&gt;&quot;;
			foreach($this-&gt;complex as $r =&gt; $t){
				$rhtml .= &quot;&lt;option value='$r'&gt;$t&lt;/option&gt;&quot;;
			}
			$rhtml .= &quot;&lt;/select&gt;&quot;;
			$bhtml = &quot;&lt;button id='$prefix.&quot;.$this-&gt;id.&quot;-add' class='addfacet'&gt;Grant Access&lt;/button&gt;&quot;;
				
			$thtml = &quot;&lt;div class='facet-maker'&gt;&quot;;
			$thtml .= &quot;&lt;table class='facet-maker-table'&gt;&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td class='option'&gt;$rhtml&lt;/td&gt;&quot;;
			$thtml .= &quot;&lt;td class='option'&gt;$facetlist&lt;/td&gt;&lt;td&gt;$bhtml&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;;
			$html .= &quot;&lt;div id='$prefix&quot;.&quot;-&quot;.$this-&gt;id.&quot;-update-table' class='facet-table-container'&gt;$thtml&lt;/div&gt;&quot;;
			return $html;
		}
		else {
			$html .= &quot;&lt;b&gt;Could not do anything with $this-&gt;id no facets/roles&lt;/b&gt;&quot;;
		}
	}
}

</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>