<html>
    <head>
        <script
            type="text/javascript"
            src="../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
/**
 * Class which stores a log of what happens to a single request as it journeys through the system...
 * * Creation Date: 20/11/2014
 * @author Chekov
 * @license GPL v2
 */
class RequestLog {
	/** @var string path to the request log file */
	var $log_file;
	/** @var string path the the event log */
	var $event_file;
	/** @var array false (off) or an associative array of microtime() to event name */
	var $timer = false;
	/** @var number http response code for request. 200 = ok */
	var $result_code;
	/** @var string a message that will be written to log */
	var $result_message;
	/** @var string the currently logged in user */
	var $user_name;
	/** @var string the id of the current collection */
	var $collection_id;
	/** @var string [api|html] */
	var $access_mode = &quot;api&quot;;
	/** @var string the service name */
	var $service;
	/** @var string the action that was carred out */
	var $action;
	/** @var string the object of the action */
	var $object;
	/** @var array the arguments passed to the service */
	var $args;
	/** @var string one of $log_levels - logs have to have a level &gt;= this to be logged */
	var $request_log_level = &quot;debug&quot;;
	/** @var string one of $log_levels - logs have to have a level &gt;= this to be logged */
	var $system_log_level = &quot;debug&quot;;
	/** @var string[] list of legal log levels */
	static $log_levels = array(&quot;debug&quot;, &quot;info&quot;, &quot;notice&quot;, &quot;warning&quot;, &quot;error&quot;, &quot;critical&quot;, &quot;alert&quot;, &quot;emergency&quot;);
	/** @var string[] list of fields that are included in a particular log message */
	static $log_fields = array(&quot;time&quot;, &quot;access&quot;, &quot;result&quot;, &quot;service&quot;, &quot;context&quot;, &quot;user&quot;, &quot;arguments&quot;, &quot;timings&quot;, &quot;message&quot;);

	/**
	 * Object constructor
	 * @param array $settings name-value server configuration settings 
	 * @param string $mode html | api
	 */
	function __construct($settings, $mode){
		$this-&gt;log_file = $settings['dacura_request_log'];
		$this-&gt;request_log_level = $settings['request_log_level'];
		$this-&gt;system_log_level = $settings['system_log_level'];
		$this-&gt;access_mode = $mode;
		$this-&gt;event_file = $settings['dacura_system_log'];
		$this-&gt;timer = array(&quot;start&quot; =&gt;  microtime(true));
	}
	
	/**
	 * Loads the request details from the service context 
	 * @param DacuraService $service
	 */
	function loadFromService(DacuraService $service){
		$this-&gt;collection_id = $service-&gt;collection_id;
		$this-&gt;args = $service-&gt;args;
		$this-&gt;service = $service-&gt;servicename;
		$this-&gt;access_mode = $service-&gt;connection_type;
		$this-&gt;setResult($service-&gt;errcode, $service-&gt;errmsg);
	}
	
	/**
	 * Sets the collection context...
	 * @param string $cid collection id
	 */
	function setContext($cid){
		$this-&gt;collection_id = $cid;
	}
	
	/**
	 * Sets result code and message
	 * @param number $c http result code
	 * @param string $m result message
	 */
	function setResult($c, $m){
		$this-&gt;result_code = $c;
		$this-&gt;result_message = $m;
	}
	
	/**
	 * set the service name of the request
	 * @param string $n service name
	 */
	function setServiceName($n){
		$this-&gt;service = $n;	
	}
	
	/**
	 * Defines the request action
	 * @param string $a action 
	 */
	function setAction($a){
		$this-&gt;action = $a;
	}
	
	/**
	 * Set the requests action and object fields
	 * @param string $a action
	 * @param string $o object
	 */
	function setEvent($a, $o){
		$this-&gt;action = $a;
		$this-&gt;object = $o;
	}
	/**
	 * Set request object
	 * @param string $o object
	 */
	function setObject($o){
		$this-&gt;object = $o;
	}
	/**
	 * Set request arguments 
	 * @param array $args
	 */
	function setArgs($args){
		$this-&gt;args = $args;
	}
	
	/**
	 * Set the username of the request
	 * @param string $u user name
	 */
	function setUser($u){
		$this-&gt;user_name = $u;
	}
	
	/**
	 * Add timing information to a log for a particular event
	 * @param string $e event name
	 * @param string $level log level for this event
	 */
	function timeEvent($e, $level = &quot;debug&quot;){
		$my_level = array_search($this-&gt;request_log_level, RequestLog::$log_levels);
		$this_level = array_search($level, RequestLog::$log_levels);
		if($this_level &gt;= $my_level){
			$this-&gt;timer[$e] = microtime(true);
		}
	}
	/**
	 * Create log for a particular request
	 * @param string $level log level 
	 * @param number $code http response code
	 * @param string $msg user message
	 */
	function logEvent($level, $code, $msg){
		$my_level = array_search($this-&gt;system_log_level, RequestLog::$log_levels);
		$this_level = array_search($level, RequestLog::$log_levels);
		if($this_level &gt;= $my_level){
			$data = &quot;$level\t$code\t$msg\n&quot;;
			file_put_contents($this-&gt;event_file, $data, FILE_APPEND | LOCK_EX);
		}
	}
	
	/**
	 * Writes the log to the end of the request log file
	 */
	function dumpToLog(){
		$data = $this-&gt;asString();
		file_put_contents($this-&gt;log_file, $data, FILE_APPEND | LOCK_EX);
	}
	
	/**
	 * Generates a string / text version of the log - for writing to file
	 * @return string the tab-delimited encoding of the log
	 */	
	function asString(){
		$str = time().&quot;\t[$this-&gt;access_mode]\t[$this-&gt;result_code]\t[$this-&gt;service|$this-&gt;action|$this-&gt;object]\t&quot;;
		$str .= &quot;[$this-&gt;collection_id]\t&quot;;
		$str .= &quot;[$this-&gt;user_name]\t[&quot;;
		$str .= is_array($this-&gt;args) ? implode(&quot;|&quot;, $this-&gt;args) : &quot;&quot;;
		$str .= &quot;]\t[&quot;;
		if($this-&gt;timer){
			$timestrs = array();
			$prev = false;
			$first = false;
			$total = 0;
			foreach($this-&gt;timer as $e =&gt; $t){
				if(!$first){
					$first = $t;
					$prev = $t;
				}
				else {
					if(count($this-&gt;timer) == 2){
						$timestrs[] = ((float)$t - (float)$first);
					}
					else {
						$timestrs[] = &quot;$e: &quot;. ((float)$t - (float)$prev);
						$prev = $t;
					}	
				}
			}
			if(count($this-&gt;timer) &gt; 2){
				array_unshift($timestrs, &quot;total: &quot;.((float)$prev - (float)$first));
			}
			$str .= implode(&quot; | &quot;, $timestrs);
		}
		$str .= &quot;]\t$this-&gt;result_message\n&quot;;	
		return $str;	
	}
	
	/**
	 * Generate a dacura listing table view of the log
	 * @param string $id the html id of the table
	 * @return string table html
	 */
	static function getAsListingTable($id){
		$html = &quot;&lt;table id='$id' class='dacura-api-listing'&gt;\n&lt;thead&gt;\n&lt;tr&gt;&quot;;
		foreach(RequestLog::$log_fields as $th){
			$html .= &quot;\n&lt;th id='log-&quot;.$th.&quot;' title='$th'&gt;$th&lt;/th&gt;&quot;;
		}
		$html .= &quot;\n&lt;/tr&gt;\n&lt;/thead&gt;\n&lt;tbody&gt;\n&lt;/tbody&gt;\n&lt;/table&gt;&quot;;
		return $html;
	}
	
	/**
	 * Takes the last num rows of the log file and turns them into an array of listing rows
	 * @param number $num the number of lines to snag
	 * @return array&lt;array&gt; an array of listing associative arrays
	 */
	function lastRowsAsListingObjects($num = 50){
		$chunk = tailCustom($this-&gt;log_file, $num);
		$lines = explode(&quot;\n&quot;, $chunk);
		$objs = array();
		foreach($lines as $line){
			$objs[] = $this-&gt;rowToListingObject($line);
		}
		return $objs;
	}
	
	/**
	 * Turn a row of the request log into a Table listing object
	 * @param string $row a single row of the request log file
	 * @return array&lt;fieldid:value&gt; 
	 */
	function rowToListingObject($row){
		$lobj = array();
		$parts = array_map('xstrim', explode(&quot;\t&quot;, $row));
		foreach(RequestLog::$log_fields as $i =&gt; $f){
			$lobj[$f] = isset($parts[$i]) ? $parts[$i] : &quot;&quot;;
		}
		return $lobj;
	}
	
	/**
	 * Add end timer and dump log to file before end
	 */
	function __destruct(){
		if($this-&gt;timer){
			$this-&gt;timer[&quot;end&quot;] = microtime(true);
		}
		$this-&gt;dumpToLog();
	}	
}

</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>